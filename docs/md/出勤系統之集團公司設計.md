# 出勤系統之集團／公司組織架構設計

## 1. 設計問題

本系統作為出勤系統，需支援同集團不同公司使用。核心問題：

- `organizations` 與 `companies` 各自的角色為何？
- 是否沿用現有的 `companies + departments` 架構？
- 是否適合用 `teams` 取代或補充？

## 2. 現有資料表結構

### 2.1 organizations（組織）

```
organizations
├── id
├── business_no        -- 統一編號
├── shipping_state     -- 州/省/縣市
├── shipping_city      -- 區/鄉/鎮
├── shipping_address1  -- 地址1
├── shipping_address2  -- 地址2
└── translations (name, short_name)
```

- 系統原始設計中作為 **外部組織**（客戶、供應商、合作夥伴）使用
- 具備多語系翻譯、地址等基本資料
- 目前與 `companies` 無外鍵關聯

### 2.2 companies（公司）

```
companies
├── id
├── parent_id          -- 自引用階層（集團→子公司）
├── code               -- 公司代碼（唯一）
├── business_no        -- 統一編號
├── phone
├── address
├── is_active
├── sort_order
└── translations (name, short_name)
```

- 支援 **階層結構**（parent_id 自引用）
- 具備多語系翻譯
- 透過 `company_user` 中介表關聯使用者
- HRM 員工直接歸屬（`hrm_employees.company_id`）

### 2.3 departments（部門）

```
departments
├── id
├── company_id         -- 歸屬公司
├── parent_id          -- 自引用階層（處→部→課→組）
├── name
├── code
├── is_active
└── sort_order
```

- 隸屬於特定公司
- 支援多層級部門結構

### 2.4 現有階層關係

```
companies（可用 parent_id 組成集團結構）
└── departments（公司底下的部門，可多層）
    └── hrm_employees（歸屬公司 + 部門）
```

## 3. 設計決策

### 3.1 結論：沿用 `companies + departments`

**確定沿用現有架構，不改用 teams。**

### 3.2 各表角色定位

| 表格 | 定位 | 用途 |
|------|------|------|
| `organizations` | 外部組織 | 客戶、供應商、合作夥伴等外部實體，**不參與出勤系統** |
| `companies` | 內部公司 | 集團內的法人實體，是出勤、計薪、法規遵循的主體單位 |
| `departments` | 組織單位 | 公司底下的行政單位，用於人員歸屬與管理層級 |

### 3.3 為什麼不用 teams

出勤系統屬於 **強制度系統**（影響錢、假、法規），不是協作工具。以下是 teams 不適用的具體原因：

#### 原因一：公司與部門在法規上有本質差異

| 項目 | 公司層級 | 部門層級 |
|------|---------|---------|
| 勞保/勞退投保單位 | 是 | 否 |
| 發薪主體 | 是 | 否 |
| 行事曆基準 | 是 | 否 |
| 國定假日適用 | 是 | 否 |
| 財務報表 | 是 | 否 |

若用 `teams` 統一表示，會不斷需要 `if ($team->type === 'company')` 這種隱性耦合判斷。

#### 原因二：公司與部門的變動頻率不同

- 員工常調動部門 → 正常業務操作
- 員工換公司 → 涉及勞保轉出入、薪資結算、年資計算

兩者混為同一張表會模糊操作的嚴重程度。

#### 原因三：規則指派變模糊

出勤系統的規則查找必須清晰：

```
✅ 明確路徑：employee → department → company
❌ 模糊路徑：employee → team → parent team → ??? → default
```

### 3.4 teams 的適用場景（未來如有需要）

若未來有需求，`teams` 可作為 **工作分組** 使用，但不參與制度性判斷：

- 專案小組
- 跨部門任務編組
- 臨時產線或活動人員

**原則：凡是會影響「錢、假、法規」的，不用 teams 抽象。**

## 4. 集團多公司的支援方式

### 4.1 利用 companies.parent_id 表示集團結構

```
companies (parent_id = null)  → 集團母公司 / 控股公司
├── companies (parent_id = 1) → 子公司 A
├── companies (parent_id = 1) → 子公司 B
└── companies (parent_id = 1) → 子公司 C
```

不需要額外建立 `groups` 或 `holdings` 表，現有的 `parent_id` 自引用已經足夠。

### 4.2 各公司獨立的制度設定

每家公司可以有獨立的：

| 設定項目 | 說明 |
|---------|------|
| 行事曆 | A 公司週六補班、B 公司不補班 |
| 上下班時間 | 不同公司不同班別 |
| 加班規則 | 加班費計算方式可能不同 |
| 請假規則 | 特休計算、假別定義可能不同 |

### 4.3 行事曆的多公司擴充方向

目前 `hrm_calendar_days` 是全域的（無 `company_id`），未來多公司支援時有兩種方案：

**方案 A：加入 company_id（推薦）**

```
hrm_calendar_days
├── company_id (nullable)  -- null = 全域預設，有值 = 公司專屬
├── date
├── day_type
└── is_workday
```

查找順序：公司專屬 → 全域預設

**方案 B：獨立公司行事曆覆蓋表**

```
hrm_company_calendar_overrides
├── company_id
├── date
├── day_type
└── is_workday
```

基礎行事曆不變，各公司只記錄差異。

> 此擴充屬於 Phase 3 規劃，目前不需實作。

## 5. 完整組織階層圖

```
organizations（外部組織，不參與出勤）
    └── 客戶、供應商等

companies（內部公司，出勤系統主體）
├── [parent_id 自引用：集團 → 子公司]
├── 行事曆、計薪規則、勞保投保單位
├── departments（部門，公司底下的行政單位）
│   ├── [parent_id 自引用：處 → 部 → 課 → 組]
│   └── 人員管理、簽核層級
└── hrm_employees（員工）
    ├── company_id  → 決定勞保、發薪、行事曆
    ├── department_id → 決定管理歸屬、簽核流程
    ├── clock_records → 打卡記錄
    ├── daily_attendances → 每日出勤
    └── monthly_summaries → 每月統計
```

## 6. 規則查找優先順序

出勤相關規則的查找順序統一為：

```
員工個人設定
  ↓ (無設定時)
部門設定
  ↓ (無設定時)
公司設定
  ↓ (無設定時)
系統預設 (config/hrm.php)
```

此順序適用於：上下班時間、加班計算、行事曆、請假規則等所有制度性設定。

## 7. 總結

| 決策 | 內容 |
|------|------|
| organizations | 維持作為外部組織使用，不參與出勤系統 |
| companies | 作為出勤系統的核心主體，利用 parent_id 支援集團結構 |
| departments | 作為公司下的行政單位，利用 parent_id 支援多層部門 |
| teams | 不用於制度性功能；若未來有工作分組需求可再評估 |
| 行事曆多公司 | Phase 3 再擴充，優先考慮方案 A（company_id nullable） |
| 規則查找 | 員工 → 部門 → 公司 → 系統預設 |
