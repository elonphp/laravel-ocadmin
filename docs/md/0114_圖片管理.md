# 0114 圖片管理（Image Manager）

## 概述

圖片管理器是後台共用元件，提供檔案瀏覽、上傳、刪除、建立資料夾等功能。
使用者在表單中點擊「選擇圖片」按鈕後，彈出 Bootstrap Modal 檔案管理器，選取圖片後回填路徑到表單隱藏欄位並更新縮圖預覽。

參考來源：舊系統 `ImgManagerController` + `imgmanager.blade.php` + `ImageHelper` + `ImageLibrary`。

---

## Storage 設定

### 方案：`php artisan storage:link`（標準做法）

建立 symlink：`public/storage` → `storage/app/public`

- 不需要修改 `.htaccess`、不需要 Apache Alias
- Windows 上 Laravel 使用 `mklink /D`，需以**系統管理員**身份執行 terminal
- `config/filesystems.php` 已正確設定，無需修改

```
storage/app/public/
├── image/
│   ├── catalog/          ← 商品圖片
│   │   └── SZ25.jpg
│   └── no_image.png      ← 預設無圖片佔位圖
└── cache/                ← 縮圖快取（自動產生）
    └── image/
        └── catalog/
            └── SZ25-100x100.jpg
```

**公開 URL 範例：**

| 用途 | URL |
|------|-----|
| 原圖 | `https://domain/storage/image/catalog/SZ25.jpg` |
| 縮圖 | `https://domain/storage/cache/image/catalog/SZ25-100x100.jpg` |

> `public/assets/ocadmin/image/no_image.png` 已存在，作為表單預覽的 placeholder。
> `storage/app/public/image/no_image.png` 需要另外放置，供 ImageLibrary PNG 處理 fallback 使用。

---

## 檔案結構

```
app/
├── Libraries/
│   └── ImageLibrary.php                  ← 從舊系統複製（GD 圖片處理）
│
├── Helpers/Classes/
│   └── ImageHelper.php                   ← 從舊系統複製（縮圖快取）
│
├── Portals/Ocadmin/
│   ├── Core/
│   │   ├── Controllers/
│   │   │   └── Common/
│   │   │       └── ImageManagerController.php   ← 新增
│   │   └── Views/
│   │       └── common/
│   │           └── imgmanager/
│   │               ├── index.blade.php          ← Modal 外殼 + JS
│   │               └── list.blade.php           ← 檔案瀏覽器內容（AJAX partial）
│   │
│   ├── Modules/Catalog/Option/
│   │   ├── OptionController.php                 ← 修改（edit/create 傳圖片資料、saveOptionValues 加 image）
│   │   └── Views/
│   │       └── form.blade.php                   ← 修改（加圖片欄、imgmanager-url）
│   │
│   └── routes/
│       └── ocadmin.php                          ← 修改（加 common/image-manager 路由）
│
└── public/assets/ocadmin/javascript/
    └── common.js                                ← 修改（Image Manager URL 改 Laravel 路由）

lang/zh_Hant/
└── ocadmin/common/
    └── imgmanager.php                           ← 新增語系檔
```

**放置於 Core 的理由：** 圖片管理器在任何使用此框架的專案都會用到，符合 Core 的定位（系統層級、跨專案通用）。

---

## 實作步驟

### 步驟 1：Storage 設定

1. 執行 `php artisan storage:link`
2. 建立目錄 `storage/app/public/image/catalog/`
3. 複製 `no_image.png` 到 `storage/app/public/image/`

### 步驟 2：ImageLibrary（GD 圖片處理）

**檔案：** `app/Libraries/ImageLibrary.php`

從舊系統直接複製，已存在正確的 namespace `App\Libraries`。
功能：resize、save、watermark、crop、rotate，支援 PNG/JPEG/GIF/WEBP。

### 步驟 3：ImageHelper（縮圖快取）

**檔案：** `app/Helpers/Classes/ImageHelper.php`

從舊系統移植，改用 Laravel 標準路徑函式（移除 `DIR_PUBLIC_STORAGE`、`HTTP_CATALOG` 常數依賴）：

```php
namespace App\Helpers\Classes;

use App\Libraries\ImageLibrary;

class ImageHelper
{
    public static function resize(string $filename, int $width, int $height, bool $force = false): string
    {
        if (empty($filename)) return '';

        $storagePath = storage_path('app/public/');

        if (!is_file($storagePath . $filename)) return '';

        // 安全檢查：防止路徑遍歷
        // 計算縮圖尺寸（保持比例或強制）
        // 產生快取路徑：cache/{原路徑}-{W}x{H}.{ext}
        // 快取存在且較新則直接返回 URL
        // 否則用 ImageLibrary resize 產生縮圖

        return url('/storage/' . $cachePath);
    }
}
```

### 步驟 4：語系檔

**檔案：** `lang/zh_Hant/ocadmin/common/imgmanager.php`

```php
return [
    'heading_title'       => '圖片管理',
    'button_parent'       => '上一層',
    'button_refresh'      => '重新整理',
    'button_upload'       => '上傳',
    'button_folder'       => '新增資料夾',
    'button_delete'       => '刪除',
    'button_search'       => '搜尋',
    'column_search'       => '搜尋...',
    'column_folder'       => '資料夾名稱',
    'text_confirm'        => '確定要刪除嗎？',
    'text_sort'           => '排序',
    'text_sort_name'      => '名稱',
    'text_sort_mtime'     => '日期',
    'text_order_asc'      => '升冪',
    'text_order_desc'     => '降冪',
    'error_upload_size'   => '檔案大小超過限制！',
    'error_directory'     => '目錄錯誤！',
    'error_filename'      => '檔案名稱長度需在 4-255 字元之間！',
    'error_filetype'      => '不允許的檔案類型！',
    'error_permission'    => '無權限操作！',
    'text_uploaded'       => '上傳成功！',
    'text_folder_created' => '資料夾已建立！',
    'text_deleted'        => '刪除成功！',
];
```

### 步驟 5：ImageManagerController

**檔案：** `app/Portals/Ocadmin/Core/Controllers/Common/ImageManagerController.php`

```
namespace App\Portals\Ocadmin\Core\Controllers\Common;

extends OcadminController
```

**方法：**

| 方法 | HTTP | 路由 | 說明 |
|------|------|------|------|
| `index()` | GET | `/common/image-manager` | 回傳 Modal 外殼 HTML（帶 target/thumb 參數） |
| `list()` | GET | `/common/image-manager/list` | 回傳檔案瀏覽器 partial（目錄/檔案列表、分頁） |
| `upload()` | POST | `/common/image-manager/upload` | 檔案上傳（JSON 回應） |
| `folder()` | POST | `/common/image-manager/folder` | 建立資料夾（JSON 回應） |
| `delete()` | POST | `/common/image-manager/delete` | 刪除檔案/資料夾（JSON 回應） |

**核心邏輯（沿用舊系統）：**

- 檔案根目錄：`storage_path('app/public/image/')`
- `list()`：glob 掃描目錄 + 檔案，支援 filter_name/sort/order/page
- 縮圖透過 `ImageHelper::resize()` 產生
- `upload()`：驗證副檔名（jpg/jpeg/png/gif/webp/ico）、MIME、大小
- `folder()`：在 `image/catalog/` 下建立子目錄
- `delete()`：遞迴刪除，安全檢查路徑不超出 storage 範圍
- 每頁 16 筆

### 步驟 6：Views

#### `Core/Views/common/imgmanager/index.blade.php`

- Bootstrap 5 Modal (`#modal-image`)
- 載入後立即 AJAX 呼叫 `list` 路由填充 `.modal-body`
- JS 事件處理：導航(parent/refresh)、搜尋、上傳、建立資料夾、刪除、圖片選取回填、分頁、排序
- 圖片選取回填邏輯：
  ```javascript
  $('{{ $thumb }}').attr('src', $(this).find('img').attr('src'));   // 更新預覽
  $('{{ $target }}').val($(this).parent().parent().find('input').val()); // 寫入路徑
  ```

#### `Core/Views/common/imgmanager/list.blade.php`

- 工具列：上一層、重新整理、上傳、新增資料夾、刪除、排序選單、搜尋
- 網格佈局 `row-cols-sm-3 row-cols-lg-4`
- 目錄以資料夾圖示顯示，點擊導航
- 圖片以縮圖顯示，點擊選取
- 每項有 checkbox 用於批次刪除
- 底部分頁

### 步驟 7：路由

**檔案：** `app/Portals/Ocadmin/routes/ocadmin.php`

在需要登入的路由群組內新增：

```php
use App\Portals\Ocadmin\Core\Controllers\Common\ImageManagerController;

// 共用工具
Route::prefix('common')->name('common.')->group(function () {
    Route::prefix('image-manager')->name('image-manager.')->group(function () {
        Route::get('/', [ImageManagerController::class, 'index'])->name('index');
        Route::get('/list', [ImageManagerController::class, 'list'])->name('list');
        Route::post('/upload', [ImageManagerController::class, 'upload'])->name('upload');
        Route::post('/folder', [ImageManagerController::class, 'folder'])->name('folder');
        Route::post('/delete', [ImageManagerController::class, 'delete'])->name('delete');
    });
});
```

路由名稱格式：`lang.ocadmin.common.image-manager.*`

### 步驟 8：更新 common.js

**檔案：** `public/assets/ocadmin/javascript/common.js`（行 380-401）

將舊 OpenCart URL 改為從 DOM 讀取 `#imgmanager-url` hidden input 的值：

```javascript
// Image Manager
$(document).on('click', '[data-oc-toggle=\'image\']', function (e) {
    var element = this;
    $('#modal-image').remove();

    var imgmanagerUrl = $('#imgmanager-url').val();

    $.ajax({
        url: imgmanagerUrl + '?target=' + encodeURIComponent($(element).attr('data-oc-target'))
             + '&thumb=' + encodeURIComponent($(element).attr('data-oc-thumb')),
        dataType: 'html',
        beforeSend: function () {
            $(element).button('loading');
        },
        complete: function () {
            $(element).button('reset');
        },
        success: function (html) {
            $('body').append(html);
            $('#modal-image').modal('show');
        }
    });
});
```

使用圖片選擇器的表單頁面需加入 hidden input：

```html
<input type="hidden" id="imgmanager-url" value="{{ route('lang.ocadmin.common.image-manager.index') }}">
```

### 步驟 9：Option form 加入圖片欄位

#### Controller 修改（`OptionController.php`）

**`edit()` 方法**：為每個 option_value 產生 thumb URL

```php
foreach ($data['optionValues'] as $value) {
    if ($value->image && is_file(storage_path('app/public/' . $value->image))) {
        $value->thumb = ImageHelper::resize($value->image, 100, 100);
    } else {
        $value->image = '';
        $value->thumb = asset('assets/ocadmin/image/no_image.png');
    }
}
```

**`saveOptionValues()` 方法**：加入 `'image'` 欄位

```php
$valueData = [
    'option_id' => $option->id,
    'code' => $row['code'],
    'image' => $row['image'] ?? '',      // ← 新增
    'sort_order' => $row['sort_order'] ?? 0,
    'is_active' => true,
];
```

**驗證規則**：加入 `'option_values.*.image' => 'nullable|string|max:255'`

#### View 修改（`form.blade.php`）

在 option_value 表格新增「圖片」欄位：

```blade
<th style="width: 140px;">{{ $lang->value_column_image }}</th>
```

每列新增圖片 cell：

```blade
<td class="text-center">
    <div class="image">
        <a href="" target="_blank">
            <img src="{{ $value->thumb }}"
                 id="thumb-image-{{ $index }}"
                 data-oc-placeholder="{{ asset('assets/ocadmin/image/no_image.png') }}"
                 class="img-thumbnail" style="max-width:100px;">
        </a>
        <input type="hidden" name="option_values[{{ $index }}][image]"
               value="{{ $value->image }}" id="input-image-{{ $index }}">
        <div class="btn-group mt-1">
            <button type="button" data-oc-toggle="image"
                    data-oc-target="#input-image-{{ $index }}"
                    data-oc-thumb="#thumb-image-{{ $index }}"
                    class="btn btn-primary btn-sm"><i class="fa-solid fa-pencil"></i></button>
            <button type="button" data-oc-toggle="clear"
                    data-oc-target="#input-image-{{ $index }}"
                    data-oc-thumb="#thumb-image-{{ $index }}"
                    class="btn btn-warning btn-sm"><i class="fa-solid fa-trash-can"></i></button>
        </div>
    </div>
</td>
```

在表單底部加入 hidden input：

```blade
<input type="hidden" id="imgmanager-url" value="{{ route('lang.ocadmin.common.image-manager.index') }}">
```

`addOptionValue()` JS 函式也需同步加入圖片欄位的 HTML。

---

## 資料流程

```
使用者點擊「Edit」按鈕
    │  data-oc-toggle="image"
    ▼
common.js 攔截 → AJAX GET /common/image-manager?target=...&thumb=...
    │
    ▼
ImageManagerController::index() → 回傳 Modal HTML (imgmanager/index.blade.php)
    │  append to body, show modal
    ▼
Modal JS 自動觸發 → AJAX GET /common/image-manager/list
    │
    ▼
ImageManagerController::list() → glob 掃描 storage/app/public/image/
    │  每張圖片產生 thumb URL via ImageHelper::resize()
    ▼
回傳 imgmanager/list.blade.php → 顯示目錄/圖片網格
    │
    ▼ 使用者點擊圖片縮圖 (a.thumbnail)
    │
$('#input-image-N').val('image/catalog/SZ25.jpg')     ← 寫入隱藏 input
$('#thumb-image-N').attr('src', '..thumbnail URL..')   ← 更新預覽圖
    │
    ▼ 使用者儲存表單
    │
OptionController::store/update() → saveOptionValues()
    │
    ▼
option_values.image = 'image/catalog/SZ25.jpg'         ← 存入 DB
```

---

## 驗證方式

1. 執行 `php artisan storage:link`，確認 `public/storage` symlink 建立成功
2. 在 `storage/app/public/image/catalog/` 放幾張測試圖片
3. 瀏覽器訪問 `https://domain/storage/image/catalog/test.jpg` 確認可存取
4. 進入選項編輯頁面 → 點擊圖片「Edit」按鈕 → Modal 應彈出並列出圖片
5. 選擇圖片 → 確認縮圖更新、隱藏 input 值已填入
6. 儲存表單 → 確認 `ctl_option_values.image` 欄位正確寫入
7. 重新載入編輯頁 → 確認圖片縮圖正確顯示
8. 測試上傳新圖片 → 確認檔案出現在 storage 目錄
9. 測試清除圖片 → 確認縮圖還原為 placeholder、input 值清空

---

## 相關文件

- [0106_Ocadmin程式規範.md](0106_Ocadmin程式規範.md) — Core vs Module 定位、Controller 規範
- [0107_Ocadmin-common.js說明.md](0107_Ocadmin-common.js說明.md) — Image Manager / Clear / Upload JS 機制
- [0301_選項與選項值.md](0301_選項與選項值.md) — option_values.image 欄位說明

---

*文件版本：v1.0*
*建立日期：2026-02-18*
