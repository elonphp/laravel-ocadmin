# 例外處理機制

## 概述

本文件說明本系統的錯誤處理機制。

錯誤分為兩大類：

| 類型 | HTTP 狀態碼 | 處理方式 | 說明 |
|------|-------------|----------|------|
| **預期的業務邏輯錯誤** | 4xx | `CustomException` | 員工仍有有效合約、資料已被引用等 |
| **非預期的系統層級錯誤** | 500 | 全域 handler | 資料庫錯誤、程式 bug 等 |

---

## 核心概念

### 預期的業務邏輯錯誤（CustomException）

這類錯誤是**可預期的業務規則限制**，應該給用戶明確的提示訊息。

**範例場景：**
- 刪除員工時，該員工仍有有效合約 → `此員工仍有有效合約，無法刪除`
- 刪除部門時，該部門仍有員工 → `此部門仍有員工，無法刪除`
- 刪除公司時，該公司仍有部門 → `此公司仍有部門，無法刪除`

```php
// Service 層主動檢查並拋出
if ($employee->contracts()->active()->exists()) {
    throw CustomException::fail('此員工仍有有效合約，無法刪除');
}
```

### 非預期的系統層級錯誤（500）

這類錯誤是**程式或環境問題**，錯誤訊息包含敏感資訊（SQL、檔案路徑等），只有工程師能看到完整內容。

**範例場景：**
- 資料表不存在（schema 未同步）
- 欄位名稱打錯
- 資料庫連線失敗
- 外鍵約束失敗（未做業務檢查就直接刪除）

```php
// 不需要特別處理，全域 handler 自動捕捉
$department->delete();  // 若有外鍵約束失敗，自動回傳 500
```

**回應內容：**
- 一般用戶 → `系統發生錯誤，請聯絡管理員。`
- 工程師/debug 模式 → `SQLSTATE[23000]: Cannot delete, foreign key constraint fails...`

---

## 為什麼需要 CustomException？

### 情境：刪除部門

**沒有業務檢查（不好）：**
```php
public function delete(Department $department): void
{
    $department->delete();  // 直接刪除
}
```
- 若有約束失敗 → 500 錯誤
- 用戶看到：`系統發生錯誤，請聯絡管理員。`（不知道為什麼失敗）

**有業務檢查（好）：**
```php
public function delete(Department $department): void
{
    if ($department->employees()->exists()) {
        throw CustomException::fail('此部門仍有員工，無法刪除');  // 400 錯誤
    }

    $department->delete();
}
```
- 用戶看到：`此部門仍有員工，無法刪除`（清楚知道原因）

---

## 全域錯誤處理

檔案位置：`bootstrap/app.php`

### 請求類型分流

全域 handler 首先判斷請求類型：

| 請求類型 | `expectsJson()` | 處理方式 |
|----------|-----------------|----------|
| AJAX 請求（Ocadmin 表單、API） | `true` | 自訂 JSON handler（下方流程） |
| 全頁載入（瀏覽器直接訪問） | `false` | 回傳 `null`，走 Laravel 預設 Blade 錯誤頁 |

jQuery AJAX 會自動帶 `X-Requested-With: XMLHttpRequest` 及 `Accept: application/json`（透過 `dataType: 'json'`），因此 Ocadmin 的 AJAX 表單提交一定會走自訂 JSON handler。

### JSON 處理流程

當 `expectsJson()` 為 `true` 時：

```
Controller / Service
        ↓
    例外發生
        ↓
withExceptions() 捕捉所有例外
        ↓
expectsJson()? ── false ──→ return null（Laravel 預設 Blade 錯誤頁）
        │
      true
        ↓
依例外類型分流處理
        ↓
┌──────────────────────────────────────────────────────────────────┐
│ 1. ValidationException      → 422 + 驗證錯誤詳情                 │
│ 2. AuthenticationException  → 401 + 登入過期 + redirect          │
│ 3. HttpException            → 依狀態碼 + 自訂訊息                │
│ 4. CustomException          → 依狀態碼 + sendJsonErrorResponse   │
│ 5. 其他（含資料庫錯誤）      → 500 + sendJsonErrorResponse       │
└──────────────────────────────────────────────────────────────────┘
        ↓
    JSON Response
```

### 各類例外處理說明

| 順序 | 例外類型 | HTTP 狀態碼 | 處理方式 | 來源 |
|------|----------|-------------|----------|------|
| 0 | 非 JSON 請求 | — | 回傳 `null`（Laravel 預設） | 全頁載入 |
| 1 | `ValidationException` | 422 | 轉換 key + 統一格式回傳 | `$request->validate()` 驗證失敗 |
| 2 | `AuthenticationException` | 401 | 回傳登入過期訊息 + redirect | session 過期、未登入 |
| 3 | `HttpException` | 依例外 | 直接回傳訊息 | `abort()`、`ModelNotFoundException`、`AuthorizationException` 等 |
| 4 | `CustomException` | 依例外 | `sendJsonErrorResponse` | Service 層業務檢查 |
| 5 | 其他 | 500 | `sendJsonErrorResponse` | 資料庫錯誤、程式 bug |

---

## CustomException 類別

檔案位置：`app/Exceptions/CustomException.php`

### 建構子參數

| 參數 | 說明 | 範例 |
|------|------|------|
| `generalError` | 給一般用戶看的友善訊息 | `'此部門仍有員工，無法刪除'` |
| `sysError` | 給工程師看的詳細訊息（可選） | `'Department 5 has 12 active employees'` |
| `statusCode` | HTTP 狀態碼 | `400`, `404`, `403` |

### 靜態方法

透過靜態方法拋出例外，不需要繼承任何類別，在 Service、Controller、Repository 任何地方皆可使用：

```php
use App\Exceptions\CustomException;

// 業務邏輯錯誤（預設 400）
throw CustomException::fail('此部門仍有員工，無法刪除');

// 帶工程師訊息
throw CustomException::fail(
    '總公司部門無法刪除',
    "Department {$department->id} is headquarters"
);

// 找不到資源（404）
throw CustomException::notFound('找不到指定的資料');

// 權限不足（403）
throw CustomException::forbidden('您沒有權限執行此操作');

// 服務不可用（503）
throw CustomException::unavailable('服務暫時無法使用');

// 系統錯誤（500）
throw CustomException::error('系統發生錯誤，請聯絡管理員。');
```

| 靜態方法 | HTTP 狀態碼 | 用途 |
|----------|-------------|------|
| `CustomException::fail($msg)` | 400 | 業務邏輯錯誤 |
| `CustomException::fail($msg, $sysMsg)` | 400 | 帶工程師詳細訊息 |
| `CustomException::notFound($msg)` | 404 | 找不到資源 |
| `CustomException::forbidden($msg)` | 403 | 權限不足 |
| `CustomException::unavailable($msg)` | 503 | 服務不可用 |
| `CustomException::error($msg)` | 500 | 系統錯誤 |

---

## sendJsonErrorResponse()

這是一個輔助函式，用於根據環境和角色決定回傳哪種訊息。

### 參數說明

| 參數 | 說明 | 範例 |
|------|------|------|
| `$generalError` | 給一般用戶看的友善訊息 | `'系統發生錯誤，請聯絡管理員。'` |
| `$sysError` | 給工程師看的詳細訊息 | `'SQLSTATE[42S02]: Table not found...'` |
| `$statusCode` | HTTP 狀態碼 | `400`, `500` |
| `$request` | 當前請求（用於取得登入用戶） | - |
| `$e` | 原始例外物件（可選） | 用於 debug 模式附帶完整除錯資訊 |

### 訊息顯示邏輯

| 條件 | `message` | `debug` |
|------|-----------|---------|
| `APP_DEBUG=true` | `$sysError`（詳細錯誤） | 附帶 exception class、file、line、trace |
| 用戶有 `super_admin` 角色 | `$sysError`（詳細錯誤） | 附帶 exception class、file、line、trace |
| 其他情況 | `$generalError`（友善訊息） | 不輸出 |

### Debug 模式回應範例

debug 模式或 `super_admin` 時，JSON 回應額外包含 `debug` 欄位，供 browser console 查看：

```json
{
    "success": false,
    "message": "SQLSTATE[23000]: Cannot delete or update a parent row...",
    "debug": {
        "exception": "Illuminate\\Database\\QueryException",
        "file": "/app/Portals/Ocadmin/Modules/Organization/OrganizationController.php",
        "line": 42,
        "trace": [
            "/app/Models/Organization.php:15 Illuminate\\Database\\Eloquent\\Model->delete()",
            "..."
        ]
    }
}
```

前端 `handleJsonResponse()` 只讀取 `success`、`message`、`errors`，`debug` 欄位不影響 UI，僅供開發時在 browser console 的 Network 面板查看。

---

## 各元件關係

| 項目 | withExceptions | CustomException | sendJsonErrorResponse |
|------|----------------|-----------------|----------------------|
| **是什麼** | 全域錯誤處理器 | 自訂例外類別（含靜態方法） | 輔助函式 |
| **位置** | `bootstrap/app.php` | `app/Exceptions/CustomException.php` | `bootstrap/app.php` |
| **職責** | 捕捉所有例外並分流 | 攜帶業務錯誤資訊 | 根據角色決定回傳訊息 |
| **何時觸發** | 任何例外發生時 | 任何地方透過靜態方法拋出 | 被 withExceptions 呼叫 |

### 關係圖

```
Service 層
    │
    ├── 業務檢查失敗 ──→ throw CustomException ──┐
    │                                           │
    └── 其他操作（可能失敗）                      │
            │                                   │
            ├── 資料庫錯誤 ──→ QueryException ───┤
            │                                   │
            └── 其他錯誤 ───────────────────────┤
                                                │
                                                ▼
                                    withExceptions() 捕捉
                                                │
                    ┌───────────────────────────┼───────────────────────────┐
                    │                           │                           │
                    ▼                           ▼                           ▼
            CustomException              QueryException              其他例外
            (預期的業務錯誤)             (資料庫錯誤)               (非預期錯誤)
                    │                           │                           │
                    └───────────────────────────┴───────────────────────────┘
                                                │
                                                ▼
                                    sendJsonErrorResponse()
                                                │
                                    根據 debug/角色 決定訊息
                                                │
                                                ▼
                                          JSON Response
```

---

## 使用時機對照表

| 情境 | 處理方式 | 說明 |
|------|----------|------|
| 表單欄位驗證 | `$request->validate()` 或 FormRequest | 失敗自動拋 `ValidationException`，全域 handler 統一回傳 |
| 資源不存在 | `findOrFail()` 或 Route Model Binding | 自動回 404 |
| 業務規則限制 | `CustomException` | 給用戶明確提示 |
| 第三方 API 錯誤 | `CustomException` | 隱藏 API 錯誤細節 |
| 資料庫/程式錯誤 | 不處理（全域捕捉） | 自動回 500 |

---

## 實際範例

### Service 使用範例

Service 不需要繼承任何類別，直接使用 `CustomException` 靜態方法：

```php
namespace App\Portals\Ocadmin\Modules\Organization;

use App\Exceptions\CustomException;
use App\Models\Organization\Department;

class DepartmentService
{
    public function delete(Department $department): void
    {
        if ($department->employees()->exists()) {
            throw CustomException::fail('此部門仍有員工，無法刪除');
        }

        if ($department->children()->exists()) {
            throw CustomException::fail('此部門仍有子部門，無法刪除');
        }

        $department->delete();
    }

    public function batchDelete(array $ids): int
    {
        $hasEmployees = Department::whereIn('id', $ids)
            ->whereHas('employees')
            ->exists();

        if ($hasEmployees) {
            throw CustomException::fail('選取的部門中仍有員工，無法刪除');
        }

        return Department::whereIn('id', $ids)->delete();
    }
}
```

---

## 不需要 CustomException 的情況

簡單 CRUD 不需要 Service 和 CustomException（參照 [0106_Ocadmin程式規範.md](0106_Ocadmin程式規範.md) 的「何時使用 Service」）：

```php
// Controller 直接處理
public function destroy(Permission $permission): JsonResponse
{
    $permission->delete();
    return response()->json(['success' => true, 'message' => __('common.text_success_delete')]);
}
```

需要 Service 的情境：

```php
// Service 處理複雜刪除
public function delete(Employee $employee): void
{
    if ($employee->contracts()->active()->exists()) {
        throw CustomException::fail('此員工仍有有效合約，無法刪除');
    }

    $employee->attendances()->delete();
    $employee->leaves()->delete();
    $employee->delete();
}
```

---

## JSON 回應格式

所有回應皆遵循統一格式，詳見 [0109_JSON回應格式.md](0109_JSON回應格式.md)。

### 驗證錯誤（422，由全域 handler 處理 ValidationException）

```json
{
    "success": false,
    "message": "繁體中文 名稱 至少需要 2 個字元",
    "errors": {
        "name-zh_Hant": "繁體中文 名稱 至少需要 2 個字元",
        "name-en": "English 名稱 為必填"
    }
}
```

### 業務錯誤（4xx，由全域 handler 處理 CustomException）

```json
{
    "success": false,
    "message": "此部門仍有員工，無法刪除"
}
```

### 系統錯誤（500，由全域 handler 自動捕捉）

```json
// 一般用戶
{
    "success": false,
    "message": "系統發生錯誤，請聯絡管理員。"
}

// debug 模式 / super_admin
{
    "success": false,
    "message": "SQLSTATE[23000]: Cannot delete or update a parent row..."
}
```

---

## 相關檔案

| 檔案 | 說明 |
|------|------|
| `bootstrap/app.php` | 全域錯誤處理（withExceptions + sendJsonErrorResponse） |
| `app/Exceptions/CustomException.php` | 自訂例外類別（含靜態方法 fail, notFound 等） |

---

## 相關文件

- [0100_系統架構.md](0100_系統架構.md)
- [0106_Ocadmin程式規範.md](0106_Ocadmin程式規範.md)
- [0109_JSON回應格式.md](0109_JSON回應格式.md)

---

## 附錄：設計討論紀錄（已解決）

以下為建立本文件過程中討論的問題與決議，保留做為學習參考。

### #1 JSON 格式不一致

**問題：** 全域 handler 回傳 `{ success: false, message: "..." }` 但 common.js 的 `handleFormErrors()` 讀取 `error_warning` / `error`，格式不一致。

**決議：** 統一為 `{ success: boolean, message: string, errors?: object }`，不使用 `error` / `error_warning`。前端改為 `handleJsonResponse()`。詳見 [0109_JSON回應格式.md](0109_JSON回應格式.md)。

### #2 缺少 `expectsJson()` 分流

**問題：** 全域 handler 未區分 AJAX 和全頁載入請求，非 AJAX 請求也會收到 JSON 回應。

**決議：** 加入 `expectsJson()` 判斷。`true` → 自訂 JSON handler；`false` → 回傳 `null`，交給 Laravel 預設 Blade 錯誤頁。jQuery AJAX 的 `dataType: 'json'` 會自動帶 `Accept: application/json`，確保走 JSON 路徑。

### #3 ValidationException 路徑

**問題：** Controller 手動 `validator()->fails()` 回傳格式不一致，且翻譯欄位的 key（`translations.zh_Hant.name`）在前端無法對應 DOM ID。

**決議：** Controller 改用 `$request->validate()`，驗證失敗自動拋出 `ValidationException`，由全域 handler 統一處理。handler 中轉換 key 格式：`translations.{locale}.{column}` → `{column}-{locale}`，對應前端 `#input-name-zh_Hant` 的 DOM 結構。

### #4 0106 文件同步

**問題：** `0106_Ocadmin程式規範.md` 的表單 AJAX 範例仍使用舊格式（`error_warning`、手動 `validator()`）。

**決議：** 與 #1、#3 連帶處理，在實作階段同步更新 0106 文件中的範例程式碼。

### #5 BaseService 角色

**問題：** 參考專案使用 `BaseService` 基底類別提供 `fail()`、`notFound()` 等方法。本系統是否需要 `BaseService`？

**決議：** 不需要 `BaseService`。改為 `CustomException` 靜態方法（`CustomException::fail()`、`::notFound()` 等），任何地方皆可直接呼叫，Service 不需要繼承任何類別。Repository 層在需要跨 Service 共用資料查詢邏輯時才建立。

---

*文件版本：v1.0*
*建立日期：2026-02-07*
