# 靜態資源檔快取解法

## 問題

瀏覽器對靜態資源（如 `common.js`、`stylesheet.css`）會依據 `Cache-Control` 做快取。在快取未過期前，瀏覽器**根本不會發請求問伺服器**，直接用本地舊檔。

```
瀏覽器請求 common.js
  ↓
本地有快取？ ──否──→ 直接下載新檔
  ↓ 是
Cache-Control 過期了嗎？
  ↓ 沒過期
直接用快取（完全不問伺服器）  ← 問題在這裡
  ↓ 已過期
送 If-Modified-Since / If-None-Match 給伺服器
  ↓
伺服器比對檔案有無變動
  ├─ 沒變 → 回 304 Not Modified（用快取）
  └─ 有變 → 回 200 + 新檔案內容
```

檔案改了但檔名不變時：
- **最差情況**：使用者要等快取到期才會拿到新版（可能數天）
- **使用者手動 Ctrl+F5**：可以拿到新版，但不能要求每個使用者都這樣做
- **無明確快取標頭**：瀏覽器用啟發式快取（通常是 Last-Modified 時間的 10%），行為不可預期

## 解法：用 filemtime 自動產生版本號

在 URL 後面加上檔案的最後修改時間當 query string，檔案一改，時間戳就變，瀏覽器視為新 URL。

### 1. 建立 helper

```php
// app/Helpers/helpers.php
function versioned_asset(string $path): string
{
    $fullPath = public_path($path);
    $version = file_exists($fullPath) ? filemtime($fullPath) : '0';
    return asset($path) . '?v=' . $version;
}
```

### 2. 在 composer.json 註冊 autoload

```json
"autoload": {
    "files": [
        "app/Helpers/helpers.php"
    ]
}
```

註冊後執行 `composer dump-autoload`。

### 3. Blade 中使用

原本：
```blade
<script src="{{ asset('assets/ocadmin/javascript/common.js') }}"></script>
<link href="{{ asset('assets/ocadmin/stylesheet/stylesheet.css') }}" rel="stylesheet">
```

改為：
```blade
<script src="{{ versioned_asset('assets/ocadmin/javascript/common.js') }}"></script>
<link href="{{ versioned_asset('assets/ocadmin/stylesheet/stylesheet.css') }}" rel="stylesheet">
```

輸出結果：
```html
<script src="/assets/ocadmin/javascript/common.js?v=1739920845"></script>
```

### 效果

- 檔案沒改 → 時間戳不變 → 瀏覽器用快取（省流量）
- 檔案有改 → 時間戳變了 → 瀏覽器下載新版（即時更新）
- 不需要 npm / build 工具
- 不用手動改版本號

## 補充：Query String 與 CDN / Proxy 的相容性

有一種說法是「少數 proxy 會忽略 query string」，以下具體說明。

### 歷史背景

早期的 HTTP 快取代理（如 Squid）預設行為是：帶 query string 的 URL 一律不快取。也就是 `style.css?v=1` 和 `style.css?v=2` 都不會被快取，每次都回源，失去 CDN 加速效果。這是 HTTP/1.1 RFC 時代的保守設計，現代 CDN 大多已修正。

### 各 CDN / Proxy 的行為

| 服務 | 預設行為 | 備註 |
|------|---------|------|
| **Cloudflare** | 區分 query string | `?v=1` 和 `?v=2` 是不同快取條目，不用額外設定 |
| **AWS CloudFront** | **忽略** query string | 需手動開啟「Forward Query Strings」才會區分 |
| **Nginx 反向代理** | 區分 query string | `proxy_cache_key` 預設含 query string |
| **老舊企業 proxy（Squid 等）** | 可能不快取 | 帶 query string 的 URL 可能完全不被快取 |

### 結論

此缺點在現代環境已幾乎不是問題。主流 CDN（Cloudflare、Akamai、Fastly）都正確處理 query string。使用 Cloudflare 的話，`?v=filemtime()` 方案完全相容，不需擔心。唯一注意 AWS CloudFront 需手動開啟設定。
