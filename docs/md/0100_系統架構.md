# 系統架構

## 核心觀點：這是一個 Laravel 專案

本系統的基礎是 **Laravel**。所有的路由、認證、授權、資料庫、佇列、快取、測試 — 全部由 Laravel 掌控。

Inertia 不是一個框架，它是 Laravel 視圖層的**橋接器** — 讓 Controller 回傳 React 頁面，就像回傳 Blade 一樣自然。React 負責的僅僅是 UI 渲染。

```
┌─────────────────────────────────────────────────────────┐
│                      Laravel 12                         │
│                   （一切的基礎）                          │
│                                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐ │
│  │  路由    │  │  認證    │  │  授權    │  │  佇列  │ │
│  │ web.php  │  │ Session  │  │ Policy   │  │ Queue  │ │
│  └────┬─────┘  └──────────┘  └──────────┘  └────────┘ │
│       │                                                 │
│       ▼                                                 │
│  ┌──────────┐       ┌──────────┐       ┌──────────┐    │
│  │Controller│──────→│  Model   │──────→│ Database │    │
│  │          │       │ Eloquent │       │ MySQL    │    │
│  └────┬─────┘       └──────────┘       └──────────┘    │
│       │                                                 │
│       │  return Inertia::render(...)                    │
│       ▼                                                 │
│  ┌─────────────────────────────────────┐                │
│  │  Inertia（橋接器，不是框架）          │                │
│  │  把 Controller 的資料交給 React 渲染  │                │
│  └────────────────┬────────────────────┘                │
│                   ▼                                     │
│  ┌─────────────────────────────────────┐                │
│  │  React（UI 渲染層）                   │                │
│  │  接收 props → 畫畫面 → 使用者互動     │                │
│  └─────────────────────────────────────┘                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

一句話總結：**Controller 決定「給什麼資料」，React 決定「怎麼畫」，Inertia 負責「傳遞」。**

---

## 為什麼不前後端分離

### 本系統的需求特徵

| 問題 | 答案 | 結論 |
|------|------|------|
| 需要 Mobile App 嗎？ | 否 | 不需要獨立 API |
| 需要第三方串接嗎？ | 否 | 不需要獨立 API |
| 有獨立前端團隊嗎？ | 否 | 不需要分離開發 |
| 是公開網站嗎？ | 否，內部系統 | 不需要 SEO |
| 需要多端共用 API？ | 否 | 不需要 API-first |

**每一條都指向同一方向：不分離。**

### 分離的代價（省掉的工作量）

前後端分離需要的「膠水代碼」，全部不是業務功能：

| 膠水代碼 | 分離架構 | Laravel + Inertia |
|----------|---------|-------------------|
| API 路由設計 | 每個功能設計 RESTful endpoint | 不需要，用 `web.php` |
| 認證機制 | JWT / Sanctum Token + 前端存儲 + 刷新邏輯 | Session（Laravel 原生） |
| CORS 設定 | 必須 | 不需要 |
| 前端路由管理 | React Router 全自己管 | 後端 `web.php` 統一管 |
| 狀態管理 | Redux async thunk 對每支 API | `usePage().props` 直接拿 |
| 權限同步 | API 回傳 → 前端儲存 → 前端判斷 | Middleware 自動 share |
| 表單處理 | axios + loading + error + retry | `useForm()` 內建全部 |
| 分頁 | API 回傳 meta → 前端解析 | `paginate()` 直傳 |
| 錯誤處理 | HTTP status code 對應 → 前端 toast | Laravel 表單驗證自動回傳 |
| API 文件 | Swagger / OpenAPI 維護 | 不需要 |

### 什麼時候才需要分離

- 需要 Mobile App 共用 API
- 需要第三方系統串接
- 前端團隊獨立且使用 Next.js 等框架
- API-first 的微服務架構

本系統不符合以上任何一條。

### 未來如果需要 API

Inertia 不阻擋你加 API。隨時可以新增 `routes/api.php`，兩者並存：

```php
// routes/web.php — Inertia 頁面（正常使用）
Route::get('/employees', [EmployeeController::class, 'index']);

// routes/api.php — 如果未來需要給 App 或第三方用
Route::get('/employees', [Api\EmployeeController::class, 'index']);
```

---

## 技術棧

| 層 | 技術 | 角色 |
|----|------|------|
| **基礎框架** | Laravel 12 | 路由、認證、授權、ORM、佇列、快取、測試 |
| **語言** | PHP 8.2+ | 後端語言 |
| **資料庫** | MySQL / MariaDB | 資料持久化 |
| **視圖橋接** | Inertia.js | 將 Controller 資料傳給 React |
| **UI 渲染** | React 19 + TypeScript | 前端頁面渲染 |
| **UI 元件庫** | Ant Design 5 | 企業級元件（表格、表單、對話框） |
| **樣式** | Tailwind CSS + SASS | 自訂樣式 |
| **建構工具** | Vite 7 | 前端資源打包（Laravel 內建整合） |

---

## 專案目錄結構

```
laravel/                              ← 專案根目錄（一切都在這裡）
│
├── app/
│   ├── Http/
│   │   ├── Controllers/
│   │   │   ├── Controller.php        ← 基底 Controller
│   │   │   ├── Auth/                 ← 認證相關
│   │   │   │   └── LoginController.php
│   │   │   ├── HRM/                  ← 人資模組
│   │   │   │   ├── EmployeeController.php
│   │   │   │   ├── DepartmentController.php
│   │   │   │   ├── DesignationController.php
│   │   │   │   ├── AttendanceController.php
│   │   │   │   ├── LeaveController.php
│   │   │   │   ├── LeaveTypeController.php
│   │   │   │   ├── HolidayController.php
│   │   │   │   ├── PayrollController.php
│   │   │   │   └── ShiftController.php
│   │   │   ├── Dashboard/            ← 儀表板
│   │   │   │   └── DashboardController.php
│   │   │   └── System/               ← 系統管理
│   │   │       ├── UserController.php
│   │   │       ├── RoleController.php
│   │   │       └── SettingController.php
│   │   │
│   │   └── Middleware/
│   │       └── HandleInertiaRequests.php  ← Inertia 共享資料
│   │
│   ├── Models/                       ← Eloquent 模型
│   │   ├── User.php
│   │   ├── Employee.php
│   │   ├── Department.php
│   │   ├── Designation.php
│   │   ├── Attendance.php
│   │   ├── Leave.php
│   │   ├── LeaveType.php
│   │   ├── Holiday.php
│   │   ├── Payroll.php
│   │   └── Shift.php
│   │
│   └── Policies/                     ← 授權 Policy
│       ├── EmployeePolicy.php
│       └── ...
│
├── resources/
│   └── js/                           ← React 前端（在 Laravel 裡面）
│       ├── app.tsx                    ← Inertia 入口
│       ├── types/                    ← TypeScript 型別定義
│       │   └── index.d.ts
│       │
│       ├── Components/               ← 共用元件
│       │   ├── ui/                   ← 基礎 UI（Button, Input, Card...）
│       │   └── shared/               ← 業務共用元件
│       │
│       ├── Layouts/                  ← 版面
│       │   └── AppLayout.tsx         ← 主版面（側欄 + 頂欄）
│       │
│       ├── Pages/                    ← 頁面（對應 Controller）
│       │   ├── Auth/
│       │   │   └── Login.tsx
│       │   ├── Dashboard/
│       │   │   └── Index.tsx
│       │   ├── HRM/
│       │   │   ├── Employee/
│       │   │   │   ├── Index.tsx     ← 員工列表
│       │   │   │   ├── Create.tsx    ← 新增員工
│       │   │   │   ├── Edit.tsx      ← 編輯員工
│       │   │   │   └── Show.tsx      ← 員工詳情
│       │   │   ├── Department/
│       │   │   │   └── Index.tsx
│       │   │   ├── Attendance/
│       │   │   │   └── Index.tsx
│       │   │   ├── Leave/
│       │   │   │   └── Index.tsx
│       │   │   ├── Payroll/
│       │   │   │   └── Index.tsx
│       │   │   └── Shift/
│       │   │       └── Index.tsx
│       │   └── System/
│       │       ├── User/
│       │       ├── Role/
│       │       └── Setting/
│       │
│       └── hooks/                    ← 共用 Hooks
│           ├── usePermission.ts
│           └── useAuth.ts
│
├── routes/
│   ├── web.php                       ← 所有頁面路由（Inertia）
│   ├── console.php                   ← Console 指令
│   └── api.php                       ← 未來如需 API 再啟用
│
├── database/
│   ├── migrations/                   ← 資料庫遷移
│   ├── seeders/                      ← 資料填充
│   └── factories/                    ← 測試工廠
│
├── config/                           ← Laravel 設定
├── tests/                            ← 測試
├── vite.config.js                    ← Vite 設定（含 React + Laravel 插件）
├── tailwind.config.js                ← Tailwind 設定
├── tsconfig.json                     ← TypeScript 設定
└── package.json                      ← 前端依賴
```

### 關鍵差異：前端在 Laravel 裡面

```
之前（分離）：                     現在（統一）：
httpdocs/                          httpdocs/
├── laravel/     ← 後端            └── laravel/        ← 整個專案
│   └── ...                            ├── app/        ← PHP 後端
└── frontend/    ← 前端（獨立）         ├── resources/js/ ← React 前端
    └── src/                           └── ...
```

`frontend/` 目錄不再需要。React 程式碼住在 `laravel/resources/js/` 裡，由 Laravel 的 Vite 插件統一建構。

---

## 資料流

### 頁面載入

```
使用者請求 /employees
       │
       ▼
  Laravel Router (web.php)
       │
       ▼
  Middleware（認證、權限、Inertia 共享資料）
       │
       ▼
  EmployeeController::index()
       │
       ├── 查詢資料：Employee::with('department')->paginate()
       ├── 檢查權限：$this->authorize('viewAny', Employee::class)
       │
       ▼
  Inertia::render('HRM/Employee/Index', [
      'employees' => $employees,      // 分頁資料
      'filters'   => $request->only(['search', 'department_id']),
  ])
       │
       ▼
  React 頁面收到 props，渲染 UI
  function EmployeeIndex({ employees, filters }) { ... }
```

### 表單提交

```
使用者填完表單，點擊「儲存」
       │
       ▼
  Inertia useForm().post('/employees')
  （自動帶 CSRF token、自動追蹤 loading 狀態）
       │
       ▼
  Laravel Router → EmployeeController::store()
       │
       ├── 驗證：$request->validate([...])
       ├── 存檔：Employee::create($validated)
       │
       ▼
  return redirect()->route('employees.index')
      ->with('success', '員工已新增')
       │
       ▼
  Inertia 自動導向新頁面，flash message 自動傳遞
  React 頁面渲染，不需手動處理 loading / error / redirect
```

---

## 權限架構

### 鐵律

> **前端權限只控制「顯示」，後端權限才控制「執行」。兩者缺一不可。**

### 後端：Controller 一定要檢查

```php
class EmployeeController extends Controller
{
    public function index()
    {
        $this->authorize('viewAny', Employee::class);  // ← 後端保護
        return Inertia::render('HRM/Employee/Index', [...]);
    }

    public function destroy(Employee $employee)
    {
        $this->authorize('delete', $employee);  // ← 後端保護
        $employee->delete();
        return redirect()->route('employees.index');
    }
}
```

### 中間：Inertia Middleware 自動傳遞權限

```php
// HandleInertiaRequests.php
public function share(Request $request): array
{
    return [
        ...parent::share($request),
        'auth' => [
            'user' => $request->user(),
        ],
        'permissions' => fn () => $request->user()
            ?->getAllPermissions()->pluck('name') ?? [],
    ];
}
```

### 前端：只決定按鈕要不要顯示

```tsx
const { can } = usePermission()

{can('employee.delete') && (
    <Button danger onClick={() => handleDelete(employee.id)}>刪除</Button>
)}
// 就算使用者繞過前端直接發請求，後端 authorize 也會擋住
```

---

## 業務模組對照表

| 業務功能 | Controller | Model | React Pages | 路由前綴 |
|----------|-----------|-------|-------------|---------|
| 員工管理 | `HRM\EmployeeController` | `Employee` | `Pages/HRM/Employee/` | `/employees` |
| 部門管理 | `HRM\DepartmentController` | `Department` | `Pages/HRM/Department/` | `/departments` |
| 職稱管理 | `HRM\DesignationController` | `Designation` | `Pages/HRM/Designation/` | `/designations` |
| 出勤管理 | `HRM\AttendanceController` | `Attendance` | `Pages/HRM/Attendance/` | `/attendances` |
| 請假管理 | `HRM\LeaveController` | `Leave` | `Pages/HRM/Leave/` | `/leaves` |
| 假別管理 | `HRM\LeaveTypeController` | `LeaveType` | `Pages/HRM/LeaveType/` | `/leave-types` |
| 國定假日 | `HRM\HolidayController` | `Holiday` | `Pages/HRM/Holiday/` | `/holidays` |
| 薪資管理 | `HRM\PayrollController` | `Payroll` | `Pages/HRM/Payroll/` | `/payrolls` |
| 班別管理 | `HRM\ShiftController` | `Shift` | `Pages/HRM/Shift/` | `/shifts` |
| 儀表板 | `Dashboard\DashboardController` | — | `Pages/Dashboard/` | `/dashboard` |
| 使用者 | `System\UserController` | `User` | `Pages/System/User/` | `/system/users` |
| 角色 | `System\RoleController` | `Role` | `Pages/System/Role/` | `/system/roles` |
| 設定 | `System\SettingController` | `Setting` | `Pages/System/Setting/` | `/system/settings` |

### 對應規則

每個業務功能都遵循 Laravel 的 Resource Controller 慣例：

| HTTP | URL | Controller 方法 | React Page | 用途 |
|------|-----|----------------|------------|------|
| GET | `/employees` | `index()` | `Employee/Index.tsx` | 列表 |
| GET | `/employees/create` | `create()` | `Employee/Create.tsx` | 新增表單 |
| POST | `/employees` | `store()` | — | 儲存新增 |
| GET | `/employees/{id}` | `show()` | `Employee/Show.tsx` | 詳情 |
| GET | `/employees/{id}/edit` | `edit()` | `Employee/Edit.tsx` | 編輯表單 |
| PUT | `/employees/{id}` | `update()` | — | 儲存編輯 |
| DELETE | `/employees/{id}` | `destroy()` | — | 刪除 |

`store()`、`update()`、`destroy()` 不需要對應的 React Page — 它們處理完直接 redirect。

---

## 現有前端程式碼的處置

`frontend/` 目錄中的 React 程式碼（UI 殼 + mock 資料），有兩種處理方式：

### 方案 A：搬移可用的 UI 元件

將有價值的 UI 部分搬到 `laravel/resources/js/`，丟棄 mock 資料和路由邏輯：

- **保留**：UI 元件、樣式、版面結構
- **丟棄**：React Router 設定、Redux async 邏輯、mock JSON、`environment.tsx`
- **改寫**：每個頁面改為接收 Inertia props，不再自己 fetch 資料

### 方案 B：以現有 UI 為參考，重新建立

以 `frontend/` 的畫面為視覺參考，在 `laravel/resources/js/Pages/` 中重新建立頁面。

由於現有前端沒有任何 API 串接（全是 mock），兩種方案的工作量差異不大。

---

## 開發工作流

```bash
# 日常開發 — 一個指令啟動全部
cd laravel/
composer dev
# 等同於同時啟動：php artisan serve + queue + logs + vite

# 資料庫遷移
php artisan migrate

# 建立新功能（以薪資模組為例）
php artisan make:model Payroll -mfs        # Model + Migration + Factory + Seeder
php artisan make:controller HRM/PayrollController --resource  # Resource Controller
# 然後在 resources/js/Pages/HRM/Payroll/ 建立 React 頁面
```

---

**文件版本**: 1.0
**建立日期**: 2026-02-05
