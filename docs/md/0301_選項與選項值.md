# 0301 選項與選項值（Options & Option Values）

## 概述

選項模組是電商系統「商品型錄」的基礎元件，定義產品可使用的規格屬性（如顏色、尺寸）及其可選值。
選項本身獨立於產品存在，多個產品可共用同一組選項定義。

參考來源：OpenCart 4.x `catalog/option` 模組，並依本系統規範轉換為 Laravel + Blade 架構。

---

## 資料表前綴規劃

本系統採用 **3 字母前綴** 區隔業務子系統，與既有的 `acl_`、`hrm_` 一致。

### 設計原則

- **各子系統獨立運作**，先建需要的模組，不預建用不到的依賴
- `clg_products` 是電商商品的本體，自帶 SKU、名稱、價格等，**不需依賴 `inv_items`**
- `inv_items` 是庫存/進銷存的料件本體，**需要庫存管理時才建立**
- 當同一品項既銷售又需庫存管理時，透過 nullable FK 關聯（後期加入）
- 不對外銷售的料件/食材只存在於 `inv_items`，不建 `clg_products`

### 前綴總覽

| 前綴 | 子系統 | 職責 | 範例資料表 |
|------|--------|------|-----------|
| （無） | 核心/共用 | 使用者、組織、設定、分類 | `users`, `companies`, `settings`, `taxonomies` |
| `acl_` | 訪問控制 | 權限、角色 | `acl_permissions`, `acl_roles` |
| `hrm_` | 人資管理 | 員工、出勤、薪資 | `hrm_employees`, `hrm_calendar_days` |
| `clg_` | 商品型錄 | 銷售商品、分類、選項、屬性、品牌 — 面向客戶 | `clg_products`, `clg_options`, `clg_categories` |
| `ord_` | 訂單管理 | 銷售訂單、訂單明細、出貨紀錄 | `ord_orders`, `ord_order_items` |
| `inv_` | 庫存管理 | 料件、倉庫、庫存數量、異動紀錄 | `inv_items`, `inv_warehouses`, `inv_stock` |
| `pur_` | 採購管理 | 供應商、採購單、供應商料號 | `pur_suppliers`, `pur_orders` |

### 分階段建置

```
Phase 1：純電商（目前階段）
─────────────────────────────────────────────
clg_products              ← 商品本體（自帶 sku, price, slug）
clg_product_translations  ← 商品名稱、描述多語
clg_product_options       ← product ↔ option 關聯
clg_options               ← 選項定義（本文件範圍）
clg_option_values
clg_categories
  → 完全不依賴 inv_，直接上線銷售

Phase 2：加入庫存管理（需要時才建）
─────────────────────────────────────────────
inv_items                 ← 料件本體（含非銷售的原料、食材）
inv_item_translations
inv_warehouses
inv_stock                 ← item + warehouse + qty
inv_movements             ← 進/出/調撥/盤點紀錄
  → clg_products 加 nullable FK：inv_item_id → inv_items.id

Phase 3：加入採購管理（需要時才建）
─────────────────────────────────────────────
pur_suppliers
pur_supplier_items        ← inv_item_id FK + 供應商料號、MOQ
pur_orders / pur_order_items
```

### 各場景對應

| 場景 | 使用的表 | 說明 |
|------|---------|------|
| 純電商賣商品 | `clg_*` | `clg_products` 自己就是商品，不需 inv_ |
| 電商 + 庫存追蹤 | `clg_*` + `inv_*` | `clg_products.inv_item_id` → `inv_items` |
| 純進銷存（不對外銷售） | `inv_*` + `pur_*` | 不需 clg_，料件只在 inv_items |
| 既採購又銷售 | 三者都有 | `inv_items` 一筆，clg_ 和 pur_ 各自 FK 指過去 |

> **選項（options）是純粹的型錄概念**，定義產品可選的規格維度，獨立存在，
> 因此使用 `clg_` 前綴。不需等 `inv_items` 建立即可使用。

---

## 資料表設計

### clg_options（選項主表）

| 欄位       | 類型              | 說明                                                              |
|------------|-------------------|-------------------------------------------------------------------|
| id         | bigint PK         | 主鍵                                                              |
| type       | string(20)        | 選項類型（select, radio, checkbox, text, textarea, file, date, time, datetime） |
| sort_order | int default 0     | 排序                                                              |
| created_at | timestamp         |                                                                   |
| updated_at | timestamp         |                                                                   |

### clg_option_translations（選項翻譯表）

| 欄位      | 類型            | 說明               |
|-----------|-----------------|-------------------|
| id        | bigint PK       | 主鍵              |
| option_id | bigint FK       | 關聯 clg_options.id |
| locale    | string(10)      | 語系代碼           |
| name      | string(128)     | 選項名稱（如：顏色） |

- UNIQUE：`(option_id, locale)`
- CASCADE DELETE

### clg_option_values（選項值主表）

| 欄位       | 類型              | 說明                            |
|------------|-------------------|---------------------------------|
| id         | bigint PK         | 主鍵                            |
| option_id  | bigint FK         | 關聯 clg_options.id              |
| image      | string(255) null  | 圖片路徑（如顏色色票）            |
| sort_order | int default 0     | 排序                            |
| created_at | timestamp         |                                 |
| updated_at | timestamp         |                                 |

- CASCADE DELETE

### clg_option_value_translations（選項值翻譯表）

| 欄位            | 類型           | 說明                        |
|-----------------|----------------|-----------------------------|
| id              | bigint PK      | 主鍵                        |
| option_value_id | bigint FK      | 關聯 clg_option_values.id    |
| locale          | string(10)     | 語系代碼                     |
| name            | string(128)    | 選項值名稱（如：紅色）        |

- UNIQUE：`(option_value_id, locale)`
- CASCADE DELETE

---

## 選項類型分類

| 分類     | 類型                         | 特性                     |
|----------|------------------------------|--------------------------|
| 選擇型   | select, radio, checkbox      | 有選項值（option_values） |
| 輸入型   | text, textarea               | 無選項值，僅需文字輸入     |
| 檔案型   | file                         | 無選項值，僅需檔案上傳     |
| 日期型   | date, time, datetime         | 無選項值，僅需日期選取     |

> **只有「選擇型」類型才會有 option_values 子資料。**

---

## 範例資料

### 選項：顏色（選擇型）

```
clg_options: { id: 1, type: 'select', sort_order: 0 }
clg_option_translations:
  - { option_id: 1, locale: 'zh_Hant', name: '顏色' }
  - { option_id: 1, locale: 'en', name: 'Color' }

clg_option_values:
  - { id: 1, option_id: 1, image: null, sort_order: 0 }  → 黃色 / Yellow
  - { id: 2, option_id: 1, image: null, sort_order: 1 }  → 紅色 / Red
  - { id: 3, option_id: 1, image: null, sort_order: 2 }  → 綠色 / Green
```

### 選項：尺寸（選擇型）

```
clg_options: { id: 2, type: 'radio', sort_order: 1 }
clg_option_translations:
  - { option_id: 2, locale: 'zh_Hant', name: '尺寸' }
  - { option_id: 2, locale: 'en', name: 'Size' }

clg_option_values:
  - { id: 4, option_id: 2, image: null, sort_order: 0 }  → 大 / Large
  - { id: 5, option_id: 2, image: null, sort_order: 1 }  → 中 / Medium
  - { id: 6, option_id: 2, image: null, sort_order: 2 }  → 小 / Small
```

---

## 程式架構

### 目錄結構

```
app/
├── Models/Catalog/
│   ├── Option.php
│   ├── OptionTranslation.php
│   ├── OptionValue.php
│   └── OptionValueTranslation.php
│
├── Portals/Ocadmin/
│   ├── Modules/Catalog/Option/
│   │   ├── OptionController.php
│   │   └── Views/
│   │       ├── index.blade.php
│   │       ├── list.blade.php
│   │       └── form.blade.php
│   └── routes/ocadmin.php          （新增 catalog/option 路由）

database/migrations/
└── 2026_02_10_000001_create_option_tables.php

lang/zh_Hant/catalog/
└── option.php
```

### 路由

```
Route prefix: {locale}/admin/catalog/option
Route name prefix: lang.ocadmin.catalog.option.

GET    /                   → index     列表頁
GET    /list               → list      AJAX 列表
GET    /create             → create    新增表單
POST   /                   → store     儲存
GET    /{option}/edit      → edit      編輯表單
PUT    /{option}           → update    更新
DELETE /{option}           → destroy   刪除
POST   /batch-delete       → batchDelete 批次刪除
```

### 選單位置

```
商品型錄（menu-catalog）
└── 選項（catalog.option.index）
```

---

## Model 關聯

```
Option
  ├── translations()    → HasMany OptionTranslation
  ├── translation()     → HasOne  OptionTranslation (current locale)
  └── optionValues()    → HasMany OptionValue
        ├── translations()    → HasMany OptionValueTranslation
        └── translation()     → HasOne  OptionValueTranslation (current locale)
```

---

## 表單設計（參考 OpenCart option form）

採用 fieldset 分區，無 Tab 結構。多語名稱以 input-group 上下堆疊。

### Fieldset 1：選項資料（text_option）
- **選項名稱**：多語系 input-group 堆疊（每語系一列，前方顯示語系名稱）
- **類型**：下拉選單（optgroup 分組：選擇 / 輸入 / 檔案 / 日期）
- **排序**：數字輸入

### Fieldset 2：選項值（text_value）— 僅選擇型顯示
- 類型為 select / radio / checkbox 時顯示，其他類型隱藏
- 動態表格，可新增/刪除列
- 每列欄位：
  - 多語系名稱（input-group 堆疊）
  - 排序
  - 刪除按鈕
- 新增按鈕位於 tfoot

---

## Controller 方法

| 方法        | 回傳             | 說明                     |
|-------------|------------------|--------------------------|
| index()     | View             | 列表頁，含初始 getList() |
| list()      | string           | AJAX 入口               |
| getList()   | string           | 核心查詢邏輯             |
| create()    | View             | 新增表單                 |
| store()     | JsonResponse     | 儲存（AJAX）             |
| edit()      | View             | 編輯表單                 |
| update()    | JsonResponse     | 更新（AJAX）             |
| destroy()   | JsonResponse     | 刪除（AJAX）             |
| batchDelete() | JsonResponse   | 批次刪除（AJAX）         |

---

## 儲存邏輯（store / update）

1. 驗證選項主表欄位 + 多語翻譯
2. 建立/更新 `clg_options` 記錄
3. 呼叫 `saveTranslations()` 儲存選項翻譯
4. 若為選擇型（select / radio / checkbox）：
   - 刪除舊的 option_values + option_value_translations
   - 依表單提交的 `option_value` 陣列重建
   - 每筆 option_value 呼叫 `saveTranslations()` 儲存翻譯
5. 若為非選擇型：刪除所有 option_values（確保資料一致）

---

## 刪除保護

刪除選項前需檢查是否有產品正在使用此選項（未來 `clg_product_options` 表建立後）。
目前階段可先允許直接刪除，待產品模組建立後再加入保護邏輯。
