# 參數設定 (Setting)

## 概述

系統參數設定模組，用於儲存全域的系統組態、功能開關、預設值等。

**設計原則：**

- 一個 `code` 對應一筆設定，唯一不重複
- 設定值透過 `type` 欄位標註資料類型，Model 自動解析
- 管理員可在後台管理所有參數，不需工程師介入
- 程式中透過 `code` 取值，不依賴 `id`

## OpenCart 4 原型參考

OpenCart 4 的 `oc_setting` 表結構：

| 欄位 | 類型 | 說明 |
|------|------|------|
| setting_id | int PK AI | 主鍵 |
| store_id | int default 0 | 商店 ID（多商店用） |
| code | varchar(128) | 群組代碼，如 `config`、`payment_cod` |
| key | varchar(128) | 設定鍵，如 `config_admin_limit` |
| value | text | 設定值 |
| serialized | tinyint(1) default 0 | 是否為 JSON 序列化值 |

特徵：

- **無 `locale` 欄位** — 217 筆設定中，只有 `config_description` 一筆涉及多語
- 多語值的處理方式：存成 JSON，以 `language_id` 為 key
  ```json
  {"1": {"meta_title": "Your Store", "meta_description": "", "meta_keyword": ""}}
  ```
- `serialized` 只有 0/1，判斷 value 是否為 JSON

## 評估：locale 欄位是否需要

### 現況

目前 `settings` 表有 `locale` 欄位，`unique(locale, code)`，代表同一個 `code` 可以依語系有不同的值。

### 問題

| 問題 | 說明 |
|------|------|
| 絕大多數設定與語言無關 | `config_admin_limit`、SMTP 帳號、開關值… 全部不分語系 |
| 語意混淆 | `locale = ''` 是通用？還是忘了填？必須靠約定 |
| 查詢複雜化 | 取設定值要考慮「先查當前語系，沒有再 fallback 到空字串」 |
| 違反原型設計 | OpenCart 4（我們的參考）沒有這個欄位 |
| 實務上幾乎不會用到 | HRM 內部系統，設定值是系統行為的組態，不是面向使用者的內容 |

### 三種方案比較

#### 方案 A：移除 locale，JSON 處理多語（推薦）

與 OpenCart 相同做法。`code` 直接唯一，不分語系。

極少數需要多語的設定值（如網站標題），使用 `json` 類型存：

```json
{"zh_Hant": "華邦人資管理系統", "en": "HRM System"}
```

| 優點 | 缺點 |
|------|------|
| 最簡單，經 OpenCart 驗證的做法 | 多語值需手動解析 JSON key |
| `code` 唯一，查詢直覺 | — |
| 不需額外資料表 | — |
| 符合 HRM 系統特性（99% 設定不分語系） | — |

#### 方案 B：移除 locale，加 `setting_translations` 表

仿照 `taxonomy_translations` 模式，主表存設定，翻譯表存多語值。

```
settings                    setting_translations
┌────┬──────────────────┐   ┌────┬────────────┬────────┬──────┐
│ id │ code             │   │ id │ setting_id │ locale │ value│
├────┼──────────────────┤   ├────┼────────────┼────────┼──────┤
│  1 │ config_site_title│──→│  1 │          1 │zh_Hant │ 華邦 │
│    │                  │   │  2 │          1 │ en     │ HRM  │
└────┴──────────────────┘   └────┴────────────┴────────┴──────┘
```

| 優點 | 缺點 |
|------|------|
| 與專案 HasTranslation 模式一致 | 為了 1% 的需求多一張表 |
| 結構化，查詢清晰 | 增加開發與維護成本 |
| — | 設定模組不像詞彙，幾乎不需要翻譯 |

#### 方案 C：保留現有 locale 欄位

維持 `unique(locale, code)`，`locale = ''` 代表通用。

| 優點 | 缺點 |
|------|------|
| 不用改現有程式碼 | 語意不明確，`''` 代表什麼需要約定 |
| — | 查詢邏輯複雜（fallback 機制） |
| — | 偏離 OpenCart 原型 |
| — | 解決一個幾乎不存在的問題 |

### 結論：採用方案 A

理由：

1. **HRM 是內部系統** — 設定值是系統組態（一頁幾筆、SMTP、開關），不是面向使用者的多語內容
2. **OpenCart 用了 217 筆設定驗證此模式可行** — 唯一需要多語的 `config_description` 用 JSON 解決
3. **YAGNI 原則** — 不為假設性需求增加複雜度；真的遇到再用 JSON type 處理
4. **查詢最簡單** — `Setting::where('code', 'xxx')->first()` 直接取值

## 資料庫結構（方案 A）

### settings 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | bigint PK | 主鍵 |
| group | varchar(100) nullable | 群組，如 `config`、`mail`、`theme` |
| code | varchar(255) unique | 設定代碼，系統唯一 |
| value | text nullable | 設定值 |
| type | enum | 值類型（見下方） |
| note | varchar(255) nullable | 備註說明 |
| created_at | timestamp | |
| updated_at | timestamp | |

**與現有差異：移除 `locale` 欄位，`code` 單獨唯一。**

### SettingType 列舉

| 值 | 說明 | 範例 |
|----|------|------|
| text | 純文字 | `Hello World` |
| line | 多行文字，一行一個項目 | `item1\nitem2\nitem3` |
| json | JSON 格式 | `{"key": "value"}` |
| serialized | PHP 序列化 | `a:1:{s:3:"key";s:5:"value";}` |
| bool | 布林值 | `1` / `0` |
| int | 整數 | `10` |
| float | 小數 | `3.14` |
| array | 逗號分隔 | `a,b,c` |

## 程式位置

此模組屬於系統管理，放在 Ocadmin：

```
app/Portals/Ocadmin/Modules/System/Setting/
├── SettingController.php
└── Views/
    ├── index.blade.php
    ├── list.blade.php
    └── form.blade.php

app/Models/System/
└── Setting.php

app/Enums/System/
└── SettingType.php

database/migrations/
└── 2026_02_05_000001_create_settings_table.php
```

## 路由

前綴：`/{locale}/admin/system/setting/`

| 方法 | 路徑 | 名稱 | 說明 |
|------|------|------|------|
| GET | /system/setting | system.setting.index | 列表 |
| GET | /system/setting/create | system.setting.create | 新增表單 |
| POST | /system/setting | system.setting.store | 儲存新增 |
| GET | /system/setting/{setting}/edit | system.setting.edit | 編輯表單 |
| PUT | /system/setting/{setting} | system.setting.update | 儲存編輯 |
| DELETE | /system/setting/{setting} | system.setting.destroy | 刪除 |
| POST | /system/setting/batch-delete | system.setting.batch-delete | 批次刪除 |
| POST | /system/setting/parse-serialize | system.setting.parse-serialize | 序列化 → JSON |
| POST | /system/setting/to-serialize | system.setting.to-serialize | JSON → 序列化 |

## 程式碼使用範例

```php
use App\Models\System\Setting;

// 取得設定值（自動依 type 解析）
$limit = Setting::where('code', 'config_admin_limit')->first()?->parsed_value;
// 10 (int)

// 取得 JSON 類型設定
$siteTitle = Setting::where('code', 'config_site_title')->first()?->parsed_value;
// ['zh_Hant' => '華邦人資管理系統', 'en' => 'HRM System']

// 取得布林值
$maintenance = Setting::where('code', 'config_maintenance')->first()?->parsed_value;
// true / false
```

### 建議：未來可加 Helper

```php
// 簡化取值（未來可加，目前不急）
setting('config_admin_limit');       // 10
setting('config_site_title');        // ['zh_Hant' => '...', 'en' => '...']
```

## 異動項目（待實作）

1. **新增 migration** — 移除 `locale` 欄位，將 `unique(locale, code)` 改為 `unique(code)`
2. **更新 Model** — 移除 `locale` 的 `$fillable`
3. **更新 Controller** — store / update 移除 locale 相關驗證與邏輯
4. **更新 View（form.blade.php）** — 移除 locale 輸入欄位
5. **更新 View（list.blade.php）** — 移除 locale 顯示欄位（如有）

## 預設種子資料

| group | code | value | type | note |
|-------|------|-------|------|------|
| config | config_admin_limit | 10 | int | 後台列表每頁筆數 |

---

## 多門市擴充：stores + store_settings

### 設計前提

基底專案只需要 `settings` 表做全域設定，不涉及門市概念。

當專案需要多門市（多商店、多站台）時，再新增 `stores` + `store_settings` 兩張表。
`settings` 保持不動，繼續作為全域設定與預設值來源。

```
基底專案（全域）            多門市專案（擴充）
┌──────────────┐          ┌──────────────┐
│   settings   │          │   settings   │ ← 全域預設值（不變）
│  （全域設定） │          ├──────────────┤
└──────────────┘          │    stores    │ ← 門市主檔
                          ├──────────────┤
                          │store_settings│ ← 門市級覆寫
                          └──────────────┘
```

### 為什麼不一開始就用 stores

| 考量 | 說明 |
|------|------|
| 基底專案不需要 | 內部系統、單站後台根本沒有門市概念，多一張表只是負擔 |
| 查詢簡單 | `Setting::where('code', 'xxx')` 直接取值，不用帶 store_id |
| 漸進式擴充 | 需要時加表即可，不影響既有程式碼 |

### OpenCart 原設計的問題

OpenCart 用 `settings.store_id = 0` 代表主站，分店從 `stores.id = 1` 開始：

- 取門市名稱需要兩種邏輯（主站查 settings、分店查 stores）
- `store_id = 0` 是魔術數字，語意不清
- 主站不存在 stores 表，查詢邏輯分岔

### 改進方案

所有門市（含主站）都是 `stores` 表的記錄，ID 自動遞增，不用魔術數字。

### stores 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | int PK AI | 主鍵，主站為 1 |
| code | varchar(50) unique | 唯一識別碼，如 `main`、`branch-taipei` |
| name | varchar(255) | 門市名稱 |
| url | varchar(255) nullable | 門市網址 |
| ssl | varchar(255) nullable | SSL 網址 |
| status | tinyint(1) default 1 | 啟用狀態 |
| sort_order | int default 0 | 排序 |
| created_at | timestamp | |
| updated_at | timestamp | |

### store_settings 表

結構對齊 `settings` 表，加上 `store_id` 外鍵：

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | bigint PK | 主鍵 |
| store_id | int FK | 關聯 stores.id |
| group | varchar(100) nullable | 群組，同 settings.group |
| code | varchar(255) | 設定代碼，同 settings.code |
| value | text nullable | 該門市的設定值 |
| type | enum | 值類型，同 SettingType |
| note | varchar(255) nullable | 備註 |
| created_at | timestamp | |
| updated_at | timestamp | |

**唯一約束：** `unique(store_id, code)` — 同一門市同一 code 只有一筆。

### 設定值的查找順序

```
取得設定值 (code, store_id)
│
├─ 1. 查 store_settings WHERE store_id = ? AND code = ?
│     → 有值？回傳（門市級覆寫）
│
└─ 2. 查 settings WHERE code = ?
      → 有值？回傳（全域預設）
      → 無值？回傳 default
```

門市級設定**覆寫**全域設定，不是取代。
只有門市需要與全域不同時，才在 `store_settings` 寫一筆。

### Migration 範例

```php
// 只在需要多門市的專案中加入

Schema::create('stores', function (Blueprint $table) {
    $table->id();
    $table->string('code', 50)->unique();
    $table->string('name');
    $table->string('url')->nullable();
    $table->string('ssl')->nullable();
    $table->boolean('status')->default(true);
    $table->integer('sort_order')->default(0);
    $table->timestamps();
});

Schema::create('store_settings', function (Blueprint $table) {
    $table->id();
    $table->foreignId('store_id')->constrained()->cascadeOnDelete();
    $table->string('group', 100)->nullable();
    $table->string('code');
    $table->text('value')->nullable();
    $table->enum('type', SettingType::values())->default(SettingType::Text->value);
    $table->string('note')->nullable();
    $table->timestamps();

    $table->unique(['store_id', 'code']);
    $table->index('group');
});
```

### 程式碼使用範例

```php
// 全域設定（基底專案，維持不變）
$limit = Setting::where('code', 'config_admin_limit')->first()?->parsed_value;

// 門市設定（擴充後）
$store = Store::where('code', 'main')->first();

// 取得門市級設定，無則 fallback 到全域
$storeSetting = $store->settings()->where('code', 'config_admin_limit')->first();
$limit = $storeSetting
    ? $storeSetting->parsed_value
    : Setting::where('code', 'config_admin_limit')->first()?->parsed_value;
```

### 建議：未來可加 Helper

```php
// 帶門市的取值（未來可加，目前不急）
setting('config_admin_limit');              // 全域
setting('config_admin_limit', $storeId);   // 門市級，自動 fallback
```

### 總結

| 層級 | 表 | 角色 | 何時建立 |
|------|------|------|---------|
| 全域 | `settings` | 系統預設值，所有專案都有 | 基底專案 |
| 門市 | `stores` + `store_settings` | 門市級覆寫 | 需要多門市時才加 |
