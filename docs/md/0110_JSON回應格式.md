# JSON 回應格式

## 概述

本文件定義全系統統一的 JSON 回應格式，適用於 Ocadmin AJAX 表單、全域例外處理、以及未來 API。

---

## 統一格式

```json
{
    "success": true/false,
    "message": "顯示文字",
    "errors": { "欄位": "錯誤訊息" },
    "data": { ... }
}
```

| 欄位 | 類型 | 必要 | 說明 |
|------|------|------|------|
| `success` | boolean | 必要 | 成功/失敗的唯一判斷依據，前端據此決定 Toast 顏色 |
| `message` | string | 必要 | 顯示給用戶的文字（成功或錯誤皆用此欄位） |
| `errors` | object | 選填 | 欄位驗證錯誤，格式為 `{ field: message }`，僅驗證失敗時出現 |
| `data` | any | 選填 | 資料載荷（API 回傳資料用） |

### Ocadmin 專屬欄位

以下欄位僅用於 Ocadmin AJAX 表單的 UI 行為控制，與訊息格式無關：

| 欄位 | 類型 | 說明 |
|------|------|------|
| `redirect` | string | 全頁跳轉 URL |
| `replace_url` | string | 更新瀏覽器網址列，不刷新頁面（新增→編輯轉換用） |
| `form_action` | string | 更新表單 `action` 屬性（搭配 `replace_url` 使用） |

---

## 各場景回應範例

### 儲存成功

```json
{
    "success": true,
    "message": "新增成功"
}
```

Ocadmin 新增成功（附帶 UI 控制）：

```json
{
    "success": true,
    "message": "新增成功",
    "replace_url": "/zh-hant/admin/system/permission/1/edit",
    "form_action": "/zh-hant/admin/system/permission/1"
}
```

### 驗證錯誤（422，全域 handler 處理 ValidationException）

```json
{
    "success": false,
    "message": "名稱為必填",
    "errors": {
        "name": "名稱為必填",
        "display-name-zh-Hant": "顯示名稱為必填"
    }
}
```

### 業務邏輯錯誤（CustomException，HTTP 4xx）

```json
{
    "success": false,
    "message": "此部門仍有員工，無法刪除"
}
```

### 系統錯誤（全域 handler，HTTP 500）

```json
// 一般用戶
{
    "success": false,
    "message": "系統發生錯誤，請聯絡管理員。"
}

// debug 模式 / super_admin
{
    "success": false,
    "message": "SQLSTATE[23000]: Cannot delete or update a parent row..."
}
```

### API 回傳資料

```json
{
    "success": true,
    "message": "查詢成功",
    "data": {
        "employees": [ ... ],
        "total": 50
    }
}
```

---

## 全系統對照表

| 場景 | 來源 | HTTP 狀態碼 | 格式 |
|------|------|-------------|------|
| 儲存成功 | Controller 回傳 | 200 | `{ success: true, message: "..." }` |
| 驗證失敗 | 全域 handler 捕捉 ValidationException | 422 | `{ success: false, message: "...", errors: {...} }` |
| 未認證 | 全域 handler 捕捉 AuthenticationException | 401 | `{ success: false, message: "...", redirect: "..." }` |
| 業務邏輯錯誤 | 全域 handler 捕捉 CustomException | 4xx | `{ success: false, message: "..." }` |
| 系統錯誤 | 全域 handler 捕捉 | 500 | `{ success: false, message: "..." }` |
| API 查詢 | Controller 回傳 | 200 | `{ success: true, message: "...", data: {...} }` |

---

## 設計決策

### 為什麼 `success` 用 boolean 而非 string

OpenCart 原版將 `success` 當作訊息字串使用（有值 = 成功，無值 = 失敗）：

```json
// OpenCart 原版
{ "success": "更新成功" }
```

這導致 `success` 同時扛「旗標」和「訊息」兩個職責。改為 boolean 後，職責分離：

- `success: boolean` → 判斷成功/失敗
- `message: string` → 顯示文字

對 API 消費者也更友善：`if (response.success)` 比 `if (response.success && response.success !== '')` 清楚。

### 為什麼不用 `error` key

`error` 和 `errors` 只差一個 `s`，容易混淆。拿掉 `error` 後：

| Key | 職責 |
|-----|------|
| `success: false` | 表達「這是錯誤」 |
| `message` | 錯誤訊息內容 |
| `errors` | 欄位標記（唯一帶 "error" 的 key） |

不需要 `error` 來表達「這是錯誤訊息」，因為 `success: false` 已足夠。

### 為什麼不用 `error_warning`

`error_warning` 是本專案早期從 OpenCart 衍生的設計，用來將 Toast 訊息和欄位錯誤分開。現在 `success: false` + `message` 取代了 `error_warning` 的角色，`errors` 取代了 `error` object 的欄位標記角色，`error_warning` 不再需要。

### OpenCart 原版格式對照

| OpenCart 原版 | 本系統統一格式 | 說明 |
|---------------|---------------|------|
| `{ "success": "更新成功" }` | `{ "success": true, "message": "更新成功" }` | `success` 改為 boolean |
| `{ "error": "權限不足" }` | `{ "success": false, "message": "權限不足" }` | 不用 `error` key |
| `{ "error": { "warning": "...", "name": "..." } }` | `{ "success": false, "message": "...", "errors": { "name": "..." } }` | Toast 和欄位分離 |
| `{ "error_warning": "...", "errors": {...} }` | `{ "success": false, "message": "...", "errors": {...} }` | 不用 `error_warning` |

---

## common.js 配套更新

### handleFormErrors 改為 handleJsonResponse

核心邏輯：前端只看 `success` boolean 決定 Toast 顏色，看 `errors` 決定欄位標記。

```javascript
function handleJsonResponse(json, element) {
    // 成功訊息（綠色 Toast）
    if (json['success'] === true && json['message']) {
        $('#alert').prepend(
            '<div class="alert alert-success alert-dismissible">' +
            '<i class="fa-solid fa-circle-check"></i> ' + json['message'] +
            ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
            '</div>'
        );
    }

    // 錯誤訊息（紅色 Toast）
    if (json['success'] === false && json['message']) {
        $('#alert').prepend(
            '<div class="alert alert-danger alert-dismissible">' +
            '<i class="fa-solid fa-circle-exclamation"></i> ' + json['message'] +
            ' <button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
            '</div>'
        );
    }

    // 欄位錯誤標記（保留底線，不做 replaceAll 轉換）
    if (typeof json['errors'] == 'object') {
        for (var key in json['errors']) {
            $('#input-' + key).addClass('is-invalid');
            $('#error-' + key).html(json['errors'][key]).addClass('d-block');
        }
    }
}
```

### AJAX success / error callback

```javascript
success: function (json, textStatus) {
    $('.alert-dismissible').remove();
    $(element).find('.is-invalid').removeClass('is-invalid');
    $(element).find('.invalid-feedback').removeClass('d-block');

    if (json['redirect']) {
        location = json['redirect'];
    }

    if (json['replace_url']) {
        window.history.pushState(null, null, json['replace_url']);
        if (json['form_action']) {
            // 更新表單 action + _method=PUT（同現行邏輯）
        }
    }

    handleJsonResponse(json, element);

    // Refresh
    if (json['success'] === true) {
        var url = $(form).attr('data-oc-load');
        var target = $(form).attr('data-oc-target');
        if (url !== undefined && target !== undefined) {
            $(target).load(url);
        }
    }

    for (var key in json) {
        $(element).find('[name=\'' + key + '\']').val(json[key]);
    }
},
error: function (xhr, ajaxOptions, thrownError) {
    console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);

    $('.alert-dismissible').remove();
    $(element).find('.is-invalid').removeClass('is-invalid');
    $(element).find('.invalid-feedback').removeClass('d-block');

    var json = {};
    try {
        json = JSON.parse(xhr.responseText);
    } catch (e) {
        json = { success: false, message: '發生錯誤，請稍後再試' };
    }

    handleJsonResponse(json, element);
}
```

---

## Controller 回傳範例

### 更新前（OpenCart 風格）

```php
// 驗證失敗
return response()->json([
    'error_warning' => $validator->errors()->first(),
    'errors' => $this->formatErrors($validator),
]);

// 新增成功
return response()->json([
    'success' => $this->lang->text_success_add,
    'replace_url' => route('lang.ocadmin.system.permission.edit', $permission),
    'form_action' => route('lang.ocadmin.system.permission.update', $permission),
]);
```

### 更新後（統一格式）

```php
// 驗證失敗
return response()->json([
    'success' => false,
    'message' => $validator->errors()->first(),
    'errors' => $this->formatErrors($validator),
]);

// 新增成功
return response()->json([
    'success' => true,
    'message' => $this->lang->text_success_add,
    'replace_url' => route('lang.ocadmin.system.permission.edit', $permission),
    'form_action' => route('lang.ocadmin.system.permission.update', $permission),
]);
```

---

## 需配套修改的項目

| 項目 | 說明 |
|------|------|
| `common.js` | `handleFormErrors()` 改為 `handleJsonResponse()`，移除 `error` / `error_warning` 舊格式處理 |
| 既有 Controller | `'success' => '訊息'` 改為 `'success' => true, 'message' => '訊息'`；`'error_warning' => '...'` 改為 `'success' => false, 'message' => '...'` |
| `bootstrap/app.php` | 全域例外 handler 統一回傳 `{ success: false, message: "..." }` |
| `0106_Ocadmin程式規範.md` | 更新表單 AJAX 提交規範章節，改用新格式範例 |
| `0109_例外處理.md` | 更新 JSON 回應格式章節 |

---

## 相關文件

- [0106_Ocadmin程式規範.md](0106_Ocadmin程式規範.md)
- [0107_Ocadmin-common.js說明.md](0107_Ocadmin-common.js說明.md)
- [0109_例外處理.md](0109_例外處理.md)

---

*文件版本：v1.0*
*建立日期：2026-02-07*
