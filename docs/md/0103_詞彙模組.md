# 詞彙模組 (Taxonomy + Term)

## 概述

通用的分類詞彙管理系統，用於管理系統中各種動態分類與選項。
例如：技能、離職原因、招募管道、證照類別、訓練課程分類等。

**設計原則：**

- Taxonomy（分類）定義一個詞彙類別
- Term（詞彙項目）屬於某個 Taxonomy，支援階層結構（parent/child）
- 管理員可自行增刪改，不需工程師介入
- 詞彙值**不參與程式邏輯判斷**，僅用於分類、標記、篩選、下拉選單

## 不適用的場景

像訂單狀態（pending、confirmed、shipped、refunded…）這類值**不適合**用詞彙模組管理。
原因是這些狀態會直接參與業務流程，程式的 Controller、Service 需要根據狀態值做邏輯判斷（例如：只有 confirmed 才能出貨、refunded 要觸發退款流程）。
如果把這些值放在詞彙模組讓管理員自由增刪，程式邏輯就會斷掉。

**正確做法：** 資料表 enum 欄位 + `app/Enums/` PHP Enum + 語言檔。

```
// 資料表
$table->enum('status', OrderStatus::values());

// PHP Enum (app/Enums/Order/OrderStatus.php)
enum OrderStatus: string {
    case Pending = 'pending';
    case Confirmed = 'confirmed';
    case Shipped = 'shipped';
    case Refunded = 'refunded';
}

// Controller / Service 中的邏輯判斷
if ($order->status === OrderStatus::Confirmed) {
    // 才能執行出貨...
}
```

### 與 Enum 的分工

| | Enum | Taxonomy + Term |
|---|------|-----------------|
| 管理方式 | 程式碼，需部署 | 後台 UI，即時生效 |
| 適用場景 | 固定值、影響程式流程邏輯 | 動態值、僅用於分類/篩選/標記 |
| 範例 | 訂單狀態、性別、付款方式 | 技能、證照類別、離職原因 |
| 判斷依據 | 程式需要 if/match 判斷的值 | 管理員可自由增刪不影響系統運作的值 |

## 資料庫結構

### taxonomies 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | bigint PK | 主鍵 |
| code | varchar(50) unique | 系統識別碼，如 `skill` |
| description | varchar(255) nullable | 說明 |
| sort_order | int default 0 | 排序 |
| is_active | boolean default true | 是否啟用 |
| created_at | timestamp | |
| updated_at | timestamp | |

### taxonomy_translations 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | bigint PK | 主鍵 |
| taxonomy_id | FK → taxonomies | 所屬分類 |
| locale | varchar(10) | 語系代碼，如 `zh_Hant` |
| name | varchar(100) | 顯示名稱，如「技能」 |

**複合唯一約束：** `(taxonomy_id, locale)`

### terms 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | bigint PK | 主鍵 |
| taxonomy_id | FK → taxonomies | 所屬分類 |
| parent_id | FK → terms nullable | 父項目，支援階層 |
| code | varchar(50) | 識別碼，同分類下不重複 |
| sort_order | int default 0 | 排序 |
| is_active | boolean default true | 是否啟用 |
| created_at | timestamp | |
| updated_at | timestamp | |

**複合唯一約束：** `(taxonomy_id, code)`

### term_translations 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | bigint PK | 主鍵 |
| term_id | FK → terms | 所屬詞彙 |
| locale | varchar(10) | 語系代碼 |
| name | varchar(100) | 顯示名稱 |

**複合唯一約束：** `(term_id, locale)`

> `name` 透過 `HasTranslation` trait 在 Model 上透明存取：`$taxonomy->name` 會根據當前語系自動回傳對應翻譯。詳見 [多語機制](0101_多語機制.md)。

## 程式位置

此模組屬於基礎建置，放在 Ocadmin Core：

```
app/Portals/Ocadmin/Core/
├── Controllers/Config/
│   ├── TaxonomyController.php
│   └── TermController.php
└── Views/config/
    ├── taxonomy/
    │   ├── index.blade.php
    │   ├── list.blade.php
    │   └── form.blade.php
    └── term/
        ├── index.blade.php
        ├── list.blade.php
        └── form.blade.php

app/Models/Config/
├── Taxonomy.php
├── TaxonomyTranslation.php
├── Term.php
└── TermTranslation.php
```

## 路由

前綴：`/{locale}/admin/config/`

| 方法 | 路徑 | 名稱 | 說明 |
|------|------|------|------|
| GET | /config/taxonomy | config.taxonomy.index | 分類列表 |
| GET | /config/taxonomy/create | config.taxonomy.create | 新增分類 |
| POST | /config/taxonomy | config.taxonomy.store | 儲存新增 |
| GET | /config/taxonomy/{taxonomy}/edit | config.taxonomy.edit | 編輯分類 |
| PUT | /config/taxonomy/{taxonomy} | config.taxonomy.update | 儲存編輯 |
| DELETE | /config/taxonomy/{taxonomy} | config.taxonomy.destroy | 刪除分類 |
| POST | /config/taxonomy/batch-delete | config.taxonomy.batch-delete | 批次刪除 |
| GET | /config/term | config.term.index | 詞彙列表 |
| GET | /config/term/create | config.term.create | 新增詞彙 |
| POST | /config/term | config.term.store | 儲存新增 |
| GET | /config/term/{term}/edit | config.term.edit | 編輯詞彙 |
| PUT | /config/term/{term} | config.term.update | 儲存編輯 |
| DELETE | /config/term/{term} | config.term.destroy | 刪除詞彙 |
| POST | /config/term/batch-delete | config.term.batch-delete | 批次刪除 |
| GET | /config/term/by-taxonomy/{taxonomy} | config.term.by-taxonomy | JSON：取得某分類的詞彙 |

## 程式碼使用範例

```php
use App\Models\Config\Taxonomy;
use App\Models\Config\Term;

// 取得分類
$taxonomy = Taxonomy::where('code', 'skill')->first();

// 取得分類下所有啟用的根項目（含子項目）
$skills = $taxonomy->rootTerms()->where('is_active', true)->with('children')->get();

// 取得特定詞彙
$term = Term::where('taxonomy_id', $taxonomy->id)->where('code', 'php')->first();

// 階層路徑
$term->getFullPath(' > '); // "程式開發 > PHP"
```

## 範例資料（Seeder）

```
Taxonomy: skill（技能）
├── programming（程式開發）
│   ├── php（PHP）
│   ├── javascript（JavaScript）
│   └── python（Python）
├── language（語言能力）
│   ├── english（英語）
│   └── japanese（日語）
└── office（辦公軟體）
    ├── excel（Excel）
    └── word（Word）
```
