# 1000 差勤系統概述

## 系統目標

本差勤系統用於管理員工的出勤記錄、統計與分析，作為人力資源管理（HRM）的核心模組之一。本系統作為開源範例專案，不直接串接硬體設備或第三方服務，但提供完整的資料結構與匯入匯出功能，可與各類打卡設備整合。

## 術語說明

### Punch vs Clock

- **Punch in/out**：傳統術語，源自紙卡打孔式打卡鐘（time clock with punch cards）
- **Clock in/out**：現代術語，更廣泛使用於電子化考勤系統

本系統採用 **clock** 作為主要術語，資料表命名使用 `attendances`（出勤記錄）取代傳統的 `punches`。

### 核心概念

- **Clock Record（打卡記錄）**：每次打卡產生的原始記錄
- **Daily Attendance（每日出勤）**：每日的出勤統計，包含上下班時間、工時計算等
- **Monthly Summary（每月統計）**：每月的工時匯總
- **Calendar（行事曆）**：定義工作日、休假日、國定假日等

## 系統架構

### 資料表結構

```
hrm_calendar_days（行事曆）
    └── 記錄每一天的狀態（每天一筆記錄，支援歷史追溯）
    └── 包含工作日判斷、假日標記、補班日等資訊

hrm_clock_records（原始打卡記錄）
    └── 記錄每次打卡的原始資料（可能一天多筆）

hrm_daily_attendances（每日出勤統計）
    ├── 關聯 hrm_clock_records（彙整當天所有打卡記錄）
    ├── 關聯 hrm_calendar_days（依據當天的行事曆狀態）
    └── 計算工時、遲到、早退、加班等

hrm_monthly_summaries（每月出勤統計）
    └── 彙總 hrm_daily_attendances（每月一筆）
```

### 資料流程

```
0. 行事曆自動產生（系統初始化 & 定期排程）
   ├── 查詢某日記錄時，若無記錄則自動建立
   ├── 排程每週產生未來 3 個月的記錄
   └── 依據 config/hrm.php 的工作日規則產生

1. 原始打卡資料來源
   ├── 匯入 CSV/Excel（傳統打卡鐘、指紋機、人臉辨識機）
   ├── 門禁系統（自動記錄進出）
   ├── Web 打卡介面
   ├── 行動 APP
   └── 手動補登

2. 寫入 hrm_clock_records（原始記錄）

3. 每日批次處理（Scheduled Job）
   ├── 取得 hrm_calendar_days（判斷工作日）
   ├── 分析 hrm_clock_records（計算工時、判斷異常）
   └── 產生/更新 hrm_daily_attendances

4. 每月批次處理（Scheduled Job）
   └── 彙總 hrm_daily_attendances
   └── 產生/更新 hrm_monthly_summaries
```

## 功能模組

### 1. 行事曆管理（Calendar）
- **記錄每一天**：每天都有一筆記錄，支援歷史追溯（避免未來規則變更造成歧義）
- **自動建立機制**：查詢時自動建立 + 排程預先產生未來 3 個月
- **工作日規則**：使用 config/hrm.php 管理（支援週休二日、週休三日等規則變更）
- **特殊日期標記**：國定假日、公司假日、補班日、颱風假等
- **批次匯入**：支援匯入政府公告的行事曆

詳見：[1001_行事曆作業.md](1001_行事曆作業.md)

### 2. 原始打卡記錄（Clock Records）
- **完整記錄**：儲存所有打卡的原始資料（一天可能多筆進出記錄）
- **簡化類型**：只有 in（進）/ out（出）/ other（其他），語意放寬支援門禁系統
- **多種方式**：支援打卡機、門禁、網頁、APP、手動補登、批次匯入
- **匯入匯出**：提供 CSV 格式匯入匯出，與傳統設備整合
- **防重複機制**：5 分鐘內相同類型不重複記錄
- **後台處理**：一般不提供前台 UI 操作（系統自動處理）

詳見：[1002_原始打卡表.md](1002_原始打卡表.md)

### 3. 每日出勤統計（Daily Attendance）
- **每天一筆**：彙整當天所有打卡記錄為一筆統計（員工 × 日期唯一）
- **智能判斷**：第一個 in = 上班，最後一個 out = 下班，中間配對計算外出時間
- **自動計算**：工時、遲到、早退、缺勤、加班等自動判斷
- **異常偵測**：自動標記異常（缺勤、漏打卡、遲到早退等）
- **人工審核**：支援 HR 審核與調整異常記錄
- **批次處理**：每日凌晨自動處理前一天的記錄

詳見：[1003_每日出勤統計.md](1003_每日出勤統計.md)

### 4. 每月出勤統計（Monthly Summary）
- **每月一筆**：彙總當月所有每日記錄為一筆摘要（員工 × 月份唯一）
- **完整統計**：出勤天數、工時、加班（平日/假日）、遲到早退、請假等
- **狀態管理**：草稿 → 待審核 → 已審核 → 已鎖定（薪資計算後）
- **薪資整合**：提供薪資計算所需的所有基礎數據
- **報表產生**：部門統計、年度分析、Excel 匯出
- **批次處理**：每月 1 號自動處理上個月的統計

詳見：[1004_每月出勤統計.md](1004_每月出勤統計.md)

## 與其他模組的關聯

### 員工模組（HRM Employees）
- 員工基本資料（hrm_employees）
- 員工排班設定（預設上下班時間）
- 部門、職位資訊

### 排班模組（Shift Management）
- 排班規則
- 班別定義
- 輪班排程

### 請假模組（Leave Management）
- 請假申請
- 假別定義
- 假勤整合

### 薪資模組（Payroll）
- 工時計算
- 加班費計算
- 出勤獎金/扣款

## 權限設計

### 角色權限
- **員工**：查看個人打卡記錄、申請補打卡
- **主管**：查看部門出勤、審核異常打卡、手動調整
- **HR 人員**：管理行事曆、匯入匯出、產生報表
- **系統管理員**：完整權限

### 操作權限
```php
'hrm.attendance.clock.view'          // 查看打卡記錄
'hrm.attendance.clock.create'        // 打卡
'hrm.attendance.clock.import'        // 匯入打卡記錄
'hrm.attendance.clock.export'        // 匯出打卡記錄

'hrm.attendance.daily.view'          // 查看每日出勤
'hrm.attendance.daily.approve'       // 審核出勤
'hrm.attendance.daily.adjust'        // 調整出勤

'hrm.attendance.monthly.view'        // 查看月統計
'hrm.attendance.monthly.export'      // 匯出月報表

'hrm.calendar.view'                  // 查看行事曆
'hrm.calendar.manage'                // 管理行事曆
```

## 技術實作要點

### 1. 時區處理
- 統一使用 `Asia/Taipei` 時區（或系統設定的時區）
- 資料庫儲存使用 `datetime` 型別
- 前端顯示時自動轉換為使用者時區

### 2. 批次處理
- 使用 Laravel Scheduled Jobs
- 每日凌晨處理前一日的出勤記錄
- 每月 1 號處理上月的月統計
- 提供手動重新計算功能

### 3. 效能考量
- 原始打卡記錄使用索引：`[employee_id, clocked_at]`
- 每日統計使用複合唯一索引：`[employee_id, work_date]`
- 每月統計使用複合唯一索引：`[employee_id, year_month]`
- 大量資料匯入使用 Queue 處理

### 4. 資料完整性
- 使用 Transaction 確保資料一致性
- 提供資料修正稽核軌跡（audit log）
- 重要欄位變更需記錄修改人與修改時間

## 未來擴充規劃

### 短期（Phase 1）
- [x] 基礎資料表結構
- [ ] 行事曆管理介面
- [ ] 打卡記錄匯入匯出
- [ ] 每日出勤統計介面
- [ ] 基礎報表功能

### 中期（Phase 2）
- [ ] Web 打卡介面
- [ ] 行動 APP 打卡
- [ ] 地理圍籬（Geo-fencing）
- [ ] 人臉辨識整合（可選）
- [ ] 即時異常通知

### 長期（Phase 3）
- [ ] AI 排班建議
- [ ] 出勤模式分析
- [ ] 預測性排班
- [ ] 多公司/多廠區支援

## 參考資料

### 政府資源
- [人事行政總處行事曆](https://www.dgpa.gov.tw/typh/daily/nds.html)
- 勞動基準法相關規定

### 業界標準
- ISO 8601（日期時間格式）
- RFC 5545（iCalendar 格式）

### 相關專案
- 參考舊系統：`D:\Codes\PHP\DTSCorp\huabing.tw\hrm.huabing.tw\httpdocs\laravel`
