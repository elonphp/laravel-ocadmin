# 權限機制

> 建立日期：2026-02

---

## 一、概述

### 1.1 技術選型

採用 [Spatie Laravel Permission](https://spatie.be/docs/laravel-permission) 作為權限管理基礎。

| 項目 | 說明 |
|------|------|
| 套件 | spatie/laravel-permission ^6.24 |
| Guard | 單一 Guard (`web`) |
| 角色命名 | Portal 前綴：`ess.*`（`super_admin` 例外） |
| 權限命名 | 三段式：`{module}.{resource}.{action}` |
| 萬用權限 | Spatie Wildcard Permission（`enable_wildcard_permission => true`） |
| 多語支援 | 角色與權限的 `display_name`、`note` 透過翻譯表實現 |
| 資料表前綴 | `acl_`（透過 `config/permission.php` 設定） |

### 1.2 權限類型

| 類型 | 說明 | 實現方式 |
|------|------|----------|
| **功能權限** | 能否執行某操作 | Spatie Permission |
| **資料權限** | 能看到哪些資料 | 組織層級 + Policy |

### 1.3 現有基礎設施

- [x] `spatie/laravel-permission` 套件安裝
- [x] `config/permission.php` 設定（`acl_` 前綴、wildcard 啟用）
- [x] ACL 資料庫遷移（含翻譯表）
- [x] 自訂 Model：`App\Models\Acl\Role`、`App\Models\Acl\Permission`（含多語翻譯）
- [x] `User` Model 已掛載 `HasRoles` trait
- [x] 角色 Seeder (`AclRoleSeeder`)
- [ ] 權限 Seeder
- [ ] 路由級權限檢查

---

## 二、角色設計

### 2.1 命名規範

**格式：`{portal}.{role_name}`**

```
ess.hr_manager
 │      │
 │      └── 角色名稱（snake_case）
 └── Portal 前綴
```

例外：`super_admin` 為全域角色，不帶 Portal 前綴。

> Portal 的定義與架構決策請見 [0105_Portal概述.md](0105_Portal概述.md)。

### 2.2 角色清單

#### 全域角色

| 角色 name | 中文名稱 | 說明 |
|-----------|----------|------|
| `super_admin` | 超級管理員 | 最高權限，僅用於 Ocadmin |

#### App Portal 角色（ess.*）

**HR 管理角色：**

| 角色 name | 中文名稱 | 說明 |
|-----------|----------|------|
| `ess.hr_manager` | HR 主管 | 管理所有 HR 功能，含薪資、報表 |
| `ess.hr_operator` | HR 管理員 | 日常 HR 操作：員工資料、出勤、請假 |
| `ess.payroll_manager` | 薪資主管 | 薪資計算、薪資單管理 |

**員工自助服務角色：**

| 角色 name | 中文名稱 | 說明 |
|-----------|----------|------|
| `ess.dept_manager` | 部門主管 | 審核下屬請假/出勤，檢視部門資料 |
| `ess.employee` | 一般員工 | 查看個人資料、打卡、申請請假 |

### 2.3 跨角色指派

同一帳號可擁有多個角色：

```php
// HR 主管：管理功能 + 自己也是員工
$user->roles: ['ess.hr_manager', 'ess.employee']

// 部門主管：ESS + 部門管理
$user->roles: ['ess.dept_manager', 'ess.employee']

// 超級管理員：僅限 Ocadmin
$user->roles: ['super_admin']
```

---

## 三、權限設計

### 3.1 命名規範

**格式：`{module}.{resource}.{action}`**

- 固定 **3 段**，使用 **2 個點** 分隔
- 全小寫，snake_case
- resource 一律使用**單數**（如 `product`、`order`、`payment`，不用 `products`）
- module 多層用底線連接

### 3.2 萬用權限（Wildcard）

啟用 Spatie 原生 wildcard permission（`config/permission.php` 中 `enable_wildcard_permission => true`）。

使用 `*` 作為萬用字元：

```
# 單一資源的所有動作
employee.employee.*        → 符合 employee.employee.list、.read、.create、.update、.delete

# 整個模組的所有權限
leave.*.*                  → 符合 leave.leave.*、leave.leave_type.*、leave.holiday.*

# 明確指定單一動作
ess_leave.leave.create     → 僅符合「請假申請」
```

> **注意**：不要建立 `*.all` 權限（如 `employee.employee.all`），使用 Spatie 原生 wildcard `*` 即可達成相同效果，無需額外的 Gate 邏輯。

### 3.3 命名範例

```
# 標準格式
employee.employee.list
employee.employee.create
employee.employee.update
employee.employee.delete

# module 多層
system_access.user.list
system_access.role.update

# 欄位級權限（action 後加 :column）
payroll.payroll.read:salary
payroll.payroll.read:bonus
```

### 3.4 常用 Action

| Action | 說明 |
|--------|------|
| `list` | 列表檢視 |
| `read` | 單筆檢視 |
| `create` | 新增 |
| `update` | 修改 |
| `delete` | 刪除 |
| `export` | 匯出 |
| `approve` | 審核（適用於請假、出勤等需審核流程） |

### 3.5 權限清單

#### 管理權限（HR 管理角色使用）

| 權限 name | 中文名稱 |
|-----------|----------|
| **儀表板** | |
| `dashboard.dashboard.read` | 儀表板 |
| **員工管理** | |
| `employee.employee.list` | 員工列表 |
| `employee.employee.read` | 員工檢視 |
| `employee.employee.create` | 員工新增 |
| `employee.employee.update` | 員工修改 |
| `employee.employee.delete` | 員工刪除 |
| `employee.employee.export` | 員工匯出 |
| **部門管理** | |
| `employee.department.list` | 部門列表 |
| `employee.department.create` | 部門新增 |
| `employee.department.update` | 部門修改 |
| `employee.department.delete` | 部門刪除 |
| **職稱管理** | |
| `employee.designation.list` | 職稱列表 |
| `employee.designation.create` | 職稱新增 |
| `employee.designation.update` | 職稱修改 |
| `employee.designation.delete` | 職稱刪除 |
| **出勤管理** | |
| `attendance.attendance.list` | 出勤列表 |
| `attendance.attendance.read` | 出勤檢視 |
| `attendance.attendance.update` | 出勤修改 |
| `attendance.attendance.export` | 出勤匯出 |
| **請假管理** | |
| `leave.leave.list` | 請假列表 |
| `leave.leave.read` | 請假檢視 |
| `leave.leave.approve` | 請假審核 |
| `leave.leave_type.list` | 假別列表 |
| `leave.leave_type.create` | 假別新增 |
| `leave.leave_type.update` | 假別修改 |
| `leave.leave_type.delete` | 假別刪除 |
| `leave.holiday.list` | 國定假日列表 |
| `leave.holiday.create` | 國定假日新增 |
| `leave.holiday.update` | 國定假日修改 |
| `leave.holiday.delete` | 國定假日刪除 |
| **薪資管理** | |
| `payroll.payroll.list` | 薪資列表 |
| `payroll.payroll.read` | 薪資檢視 |
| `payroll.payroll.update` | 薪資修改 |
| `payroll.payroll.read:salary` | 薪資金額 |
| `payroll.payroll.read:bonus` | 獎金金額 |
| `payroll.payslip.list` | 薪資單列表 |
| `payroll.payslip.read` | 薪資單檢視 |
| `payroll.payslip.create` | 薪資單產生 |
| **班別管理** | |
| `schedule.shift.list` | 班別列表 |
| `schedule.shift.create` | 班別新增 |
| `schedule.shift.update` | 班別修改 |
| `schedule.shift.delete` | 班別刪除 |
| **系統管理** | |
| `system_access.user.list` | 使用者列表 |
| `system_access.user.create` | 使用者新增 |
| `system_access.user.update` | 使用者修改 |
| `system_access.role.list` | 角色列表 |
| `system_access.role.update` | 角色權限設定 |
| `config.setting.list` | 系統設定列表 |
| `config.setting.update` | 系統設定修改 |
| `config.taxonomy.list` | 詞彙分類列表 |
| `config.taxonomy.update` | 詞彙分類修改 |

#### ESS 權限（員工自助服務角色使用）

| 權限 name | 中文名稱 |
|-----------|----------|
| `ess_profile.profile.read` | 個人資料檢視 |
| `ess_profile.profile.update` | 個人資料修改 |
| `ess_attendance.attendance.list` | 個人出勤紀錄 |
| `ess_attendance.attendance.create` | 打卡 |
| `ess_leave.leave.list` | 個人請假紀錄 |
| `ess_leave.leave.create` | 請假申請 |
| `ess_leave.leave.approve` | 請假審核（部門主管） |
| `ess_payroll.payslip.list` | 個人薪資單 |
| `ess_payroll.payslip.read` | 薪資單檢視 |
| `ess_team.employee.list` | 部門成員列表（部門主管） |
| `ess_team.attendance.list` | 部門出勤紀錄（部門主管） |

### 3.6 角色權限指派範例（Wildcard）

```php
// ess.hr_manager — 使用萬用權限涵蓋所有動作
$hrManager->givePermissionTo([
    'employee.*.*',         // 員工、部門、職稱管理全部
    'attendance.*.*',       // 出勤管理全部
    'leave.*.*',            // 請假、假別、國定假日全部
    'payroll.*.*',          // 薪資管理全部
    'schedule.*.*',         // 班別管理全部
    'dashboard.dashboard.read',
]);

// ess.hr_operator — 部分模組全開，部分限定
$hrOperator->givePermissionTo([
    'employee.employee.*',  // 員工管理全部動作
    'employee.department.list',
    'employee.designation.list',
    'attendance.attendance.*',
    'leave.leave.*',
]);

// ess.employee — 僅 ESS 個人權限
$employee->givePermissionTo([
    'ess_profile.profile.read',
    'ess_profile.profile.update',
    'ess_attendance.attendance.create',
    'ess_leave.leave.list',
    'ess_leave.leave.create',
    'ess_payroll.payslip.list',
    'ess_payroll.payslip.read',
]);

// ess.dept_manager — ESS + 部門管理
$deptManager->givePermissionTo([
    'ess_team.employee.list',
    'ess_team.attendance.list',
    'ess_leave.leave.approve',
]);
```

---

## 四、資料表結構

### 4.1 Spatie Permission 資料表

使用 `acl_` 前綴（透過 `config/permission.php` 設定）：

| 資料表 | 說明 |
|--------|------|
| `acl_permissions` | 權限 |
| `acl_roles` | 角色 |
| `acl_role_has_permissions` | 角色-權限關聯 |
| `acl_model_has_permissions` | 使用者-權限關聯（直接指派） |
| `acl_model_has_roles` | 使用者-角色關聯 |

### 4.2 翻譯表

| 資料表 | 說明 |
|--------|------|
| `acl_role_translations` | 角色多語翻譯（display_name, note） |
| `acl_permission_translations` | 權限多語翻譯（display_name, note） |

### 4.3 擴展欄位

`acl_roles` 額外欄位：

| 欄位 | 類型 | 說明 |
|------|------|------|
| `sort_order` | int, default 0 | 排序 |
| `is_active` | boolean, default true | 是否啟用 |

---

## 五、設定與安裝

### 5.1 config/permission.php（重點摘要）

```php
return [
    'models' => [
        'permission' => App\Models\Acl\Permission::class,  // 自訂 Model
        'role' => App\Models\Acl\Role::class,              // 自訂 Model
    ],

    'table_names' => [
        'roles' => 'acl_roles',
        'permissions' => 'acl_permissions',
        'model_has_permissions' => 'acl_model_has_permissions',
        'model_has_roles' => 'acl_model_has_roles',
        'role_has_permissions' => 'acl_role_has_permissions',
    ],

    'teams' => false,  // 不使用 teams 功能

    'enable_wildcard_permission' => true,  // 啟用萬用權限

    'cache' => [
        'expiration_time' => \DateInterval::createFromDateString('24 hours'),
        'key' => 'spatie.permission.cache',
        'store' => 'default',
    ],
];
```

### 5.2 自訂 Model

角色和權限 Model 繼承自 Spatie 基礎類別，加上 `HasTranslation` trait 實現多語支援：

```php
// app/Models/Acl/Role.php
class Role extends SpatieRole
{
    use HasTranslation;

    protected $fillable = ['name', 'guard_name', 'sort_order', 'is_active'];
    protected array $translatedAttributes = ['display_name', 'note'];
    protected string $translationModel = RoleTranslation::class;
}

// app/Models/Acl/Permission.php
class Permission extends SpatiePermission
{
    use HasTranslation;

    protected array $translatedAttributes = ['display_name', 'note'];
    protected string $translationModel = PermissionTranslation::class;
}
```

### 5.3 User Model

```php
// app/Models/User.php
use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    use HasRoles;
    // ...
}
```

---

## 六、權限檢查

### 6.1 Controller 中

```php
public function index()
{
    // 方式一：手動檢查
    if (!auth()->user()->can('employee.employee.list')) {
        abort(403);
    }

    // 方式二：authorize（拋出 AuthorizationException）
    $this->authorize('employee.employee.list');
}
```

### 6.2 Middleware

```php
// 路由中使用
Route::middleware(['permission:employee.employee.list'])->group(function () {
    Route::get('/employees', [EmployeeController::class, 'index']);
});

// 或
Route::get('/employees', [EmployeeController::class, 'index'])
    ->middleware('can:employee.employee.list');
```

### 6.3 Inertia + React 前端

後端透過 Inertia 傳遞權限資訊給前端：

```php
// app/Http/Middleware/HandleInertiaRequests.php

public function share(Request $request): array
{
    return [
        ...parent::share($request),
        'auth' => [
            'user' => $request->user(),
            'permissions' => $request->user()?->getAllPermissions()
                ->pluck('name')
                ->toArray() ?? [],
            'roles' => $request->user()?->getRoleNames()->toArray() ?? [],
        ],
    ];
}
```

React 前端使用：

```tsx
// 取得權限資訊
const { permissions } = usePage().props.auth;

// 權限檢查 helper
function can(permission: string): boolean {
    return permissions.includes(permission);
}

// 在 JSX 中使用
{can('employee.employee.create') && (
    <Button>新增員工</Button>
)}
```

### 6.4 欄位級權限

```php
// Controller
public function show(Employee $employee)
{
    $data = $employee->toArray();

    // 隱藏無權限的敏感欄位
    if (!auth()->user()->can('payroll.payroll.read:salary')) {
        unset($data['salary']);
    }
    if (!auth()->user()->can('payroll.payroll.read:bonus')) {
        unset($data['bonus']);
    }

    return Inertia::render('Employee/Detail', ['employee' => $data]);
}
```

---

## 七、資料權限

資料範圍由權限名稱隱含，不需要額外的 Portal 層級判斷：

| 權限前綴 | 資料範圍 | 對應角色 |
|----------|---------|---------|
| `employee.*` | 全公司 | HR 管理角色 |
| `ess_team.*` | 同部門 | 部門主管 |
| `ess_profile.*` | 僅自己 | 一般員工 |

### 7.1 Policy

```php
// app/Policies/EmployeePolicy.php

class EmployeePolicy
{
    public function viewAny(User $user): bool
    {
        return $user->can('employee.employee.list')
            || $user->can('ess_team.employee.list');
    }

    public function view(User $user, Employee $employee): bool
    {
        // HR 有權限可查看所有
        if ($user->can('employee.employee.read')) {
            return true;
        }

        // 查看自己
        if ($employee->user_id === $user->id) {
            return true;
        }

        // 部門主管查看下屬
        if ($user->can('ess_team.employee.list')) {
            return $employee->department_id === $user->employee?->department_id;
        }

        return false;
    }
}
```

### 7.2 請假審核

```php
// app/Policies/LeavePolicy.php

class LeavePolicy
{
    public function approve(User $user, Leave $leave): bool
    {
        // HR 可審核所有
        if ($user->can('leave.leave.approve')) {
            return true;
        }

        // 部門主管只能審核自己部門的
        if ($user->can('ess_leave.leave.approve')) {
            return $leave->employee->department_id === $user->employee?->department_id;
        }

        return false;
    }
}
```

---

## 八、Seeder

### 8.1 角色 Seeder

角色由 `AclRoleSeeder` 管理，定義於 `database/seeders/AclRoleSeeder.php`。

### 8.2 權限 Seeder（範例）

```php
// database/seeders/AclPermissionSeeder.php

use App\Models\Acl\Permission;

class AclPermissionSeeder extends Seeder
{
    public function run(): void
    {
        app()[\Spatie\Permission\PermissionRegistrar::class]->forgetCachedPermissions();

        $permissions = [
            'dashboard.dashboard.read'      => ['en' => 'Dashboard', 'zh_Hant' => '儀表板'],
            'employee.employee.list'        => ['en' => 'Employee List', 'zh_Hant' => '員工列表'],
            'employee.employee.read'        => ['en' => 'View Employee', 'zh_Hant' => '員工檢視'],
            'employee.employee.create'      => ['en' => 'Create Employee', 'zh_Hant' => '員工新增'],
            'employee.employee.update'      => ['en' => 'Update Employee', 'zh_Hant' => '員工修改'],
            'employee.employee.delete'      => ['en' => 'Delete Employee', 'zh_Hant' => '員工刪除'],
            // ... 其餘權限依 §3.5 權限清單定義
        ];

        foreach ($permissions as $name => $translations) {
            $perm = Permission::updateOrCreate(
                ['name' => $name, 'guard_name' => 'web'],
            );
            foreach ($translations as $locale => $displayName) {
                $perm->translateOrNew($locale)->display_name = $displayName;
            }
            $perm->save();
        }
    }
}
```

---

## 九、多語支援

本系統的角色與權限支援多語翻譯，透過自訂 Model 上的 `HasTranslation` trait 實現。

### 9.1 取得翻譯後的名稱

```php
// 取得當前語系的 display_name
$role->display_name;  // 自動依 app()->getLocale() 回傳

// 指定語系
$role->translate('zh_Hant')->display_name;  // "HR 主管"
$role->translate('en')->display_name;        // "HR Manager"
```

### 9.2 前端顯示

後端傳遞角色/權限資訊時，自動帶入當前語系的翻譯：

```php
// Controller
return Inertia::render('System/Role/Index', [
    'roles' => Role::with('translation')
        ->orderBy('sort_order')
        ->where('is_active', true)
        ->get(),
]);
```

---

## 十、總結

### 10.1 快速參考

| 項目 | 格式 | 範例 |
|------|------|------|
| 全域角色 | `{role}` | `super_admin` |
| Portal 角色 | `ess.{role}` | `ess.hr_manager`, `ess.employee` |
| 權限 | `{module}.{resource}.{action}` | `employee.employee.list` |
| 萬用權限 | `{module}.{resource}.*` | `employee.employee.*` |
| 欄位權限 | `{module}.{resource}.{action}:{column}` | `payroll.payroll.read:salary` |

### 10.2 檢查方式

```php
// 檢查角色
$user->hasRole('super_admin');
$user->hasRole('ess.hr_manager');

// 檢查權限（支援 wildcard 比對）
$user->can('employee.employee.list');

// 檢查 Portal 存取（見 0105_Portal概述.md）
$user->hasAppAccess();
```

---

## 相關文件

- [0105_Portal概述.md](0105_Portal概述.md) — Portal 架構與存取控制

## 參考資料

- [Spatie Laravel Permission](https://spatie.be/docs/laravel-permission)
- [Spatie Wildcard Permissions](https://spatie.be/docs/laravel-permission/advanced-usage/wildcard-permissions)
- [Laravel Authorization](https://laravel.com/docs/authorization)
