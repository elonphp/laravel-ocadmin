# 日誌記錄系統

---

## 概述

本系統採用**資料庫為主、檔案歸檔為輔**的日誌架構：

- **即時記錄**：寫入資料庫，支援快速查詢
- **歷史歸檔**：每月自動匯出壓縮，保留完整歷史
- **自動清理**：資料庫僅保留 6 個月，超過自動刪除
- **獨立儲存**：推薦使用第二資料庫 `sysdata`，備份時可整庫排除

---

## 架構設計

```
┌─────────────────────────────────────────────────────────┐
│                      HTTP Request                        │
└─────────────────────────┬───────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 LogRequest Middleware                    │
│               (使用 LogDatabaseRepository)               │
└─────────────────────────┬───────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  LogDatabaseRepository                   │
└─────────────────────────┬───────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────┐
│              RequestLog Model                            │
│           ($connection = 'sysdata')                      │
└─────────────────────────┬───────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────┐
│            request_logs 資料表                            │
│              (位於 sysdata)                               │
└─────────────────────────┬───────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────┐
│              Laravel Scheduler (每月 1 日)               │
│  1. 匯出上月日誌 → JSON Lines                            │
│  2. 壓縮成 ZIP                                           │
│  3. 刪除超過 6 個月的記錄                                │
└─────────────────────────┬───────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────┐
│           storage/logs/archived/                         │
│  ├── logs_2026-01.zip                                   │
│  ├── logs_2026-02.zip                                   │
│  └── ...                                                │
└─────────────────────────────────────────────────────────┘
```

---

## 第二資料庫（sysdata）

推薦將日誌及其他不需備份的資料寫入獨立的第二資料庫 `sysdata`。

### 為什麼分離

每日備份時，最需要保護的是業務資料（員工、薪資、出勤）。`sysdata` 存放的資料有個共同特徵：**丟了可以重建，不影響業務運作**。整庫排除備份，可大幅減少備份時間與儲存空間。

### 適用資料分類

#### 靜態參考資料（極少變動，可從外部來源重新 seed）

| 資料表 | 來源 | 說明 |
|--------|------|------|
| `countries` | ISO 3166 | 國碼、國名、電話國碼 |
| `currencies` | ISO 4217 | 幣碼、幣名、小數位數 |
| `timezones` | IANA tz database | 時區名稱、UTC 偏移 |
| `districts` | 政府開放資料 | 縣市鄉鎮區行政區劃 |
| `postal_codes` | 中華郵政 | 三碼/五碼郵遞區號 |
| `roads` | 戶政/地政開放資料 | 全國路街名 |
| `banks` | 財金公司 | 總行/分行代碼 |
| `labor_insurance_brackets` | 勞動部 | 勞保投保薪資級距表（年度更新） |
| `health_insurance_brackets` | 衛福部 | 健保投保金額級距表（年度更新） |
| `income_tax_rates` | 財政部 | 所得稅累進稅率表（年度更新） |

> 這類資料來自公開來源，遺失後重新執行 `php artisan db:seed` 即可還原。

#### 可拋棄的操作紀錄（遺失不影響業務）

| 資料表 | 說明 |
|--------|------|
| `request_logs` | HTTP 請求/回應記錄 |
| `login_histories` | 登入時間、IP、成功/失敗 |
| `notification_logs` | Email/SMS 發送歷史 |
| `schedule_logs` | Artisan command 排程執行結果 |

> 這類資料是操作過程的副產物，業務資料本身存在主資料庫，日誌只是追蹤用途。

### .env

```env
# 第二資料庫（sysdata）
DB_SYSDATA_DRIVER=mysql
DB_SYSDATA_HOST=127.0.0.1
DB_SYSDATA_PORT=3306
DB_SYSDATA_DATABASE=my_sysdata
DB_SYSDATA_USERNAME=root
DB_SYSDATA_PASSWORD=
```

### config/database.php

在 `connections` 陣列中加入 `sysdata`（放在 `mysql` 之後）：

```php
// 系統資料庫（日誌、審計等）
'sysdata' => [
    'driver'       => env('DB_SYSDATA_DRIVER', 'mysql'),
    'url'          => env('DB_SYSDATA_URL'),
    'host'         => env('DB_SYSDATA_HOST', '127.0.0.1'),
    'port'         => env('DB_SYSDATA_PORT', '3306'),
    'database'     => env('DB_SYSDATA_DATABASE', 'sysdata'),
    'username'     => env('DB_SYSDATA_USERNAME', 'root'),
    'password'     => env('DB_SYSDATA_PASSWORD', ''),
    'unix_socket'  => env('DB_SYSDATA_SOCKET', ''),
    'charset'      => env('DB_SYSDATA_CHARSET', 'utf8mb4'),
    'collation'    => env('DB_SYSDATA_COLLATION', 'utf8mb4_unicode_ci'),
    'prefix'       => '',
    'prefix_indexes' => true,
    'strict'       => true,
    'engine'       => null,
],
```

### SysdataModel 基底類別

sysdata 的 Model 不應直接設定 `$connection = 'sysdata'`，而是繼承 `SysdataModel`。

#### 跨庫關聯問題

Laravel 在解析關聯時，若關聯 Model 未宣告 `$connection`，會繼承父 Model 的連線：

```php
// Laravel 原始碼 — Illuminate\Database\Eloquent\Model
protected function newRelatedInstance($class)
{
    return tap(new $class, function ($instance) {
        if (! $instance->getConnectionName()) {
            $instance->setConnection($this->connection); // ← 繼承父的 sysdata
        }
    });
}
```

這會導致 `$requestLog->user` 跑到 `sysdata` 去查 `users` 表（但 `users` 在主資料庫）。

#### 解決方式

建立 `SysdataModel` 覆寫 `newRelatedInstance()`，將未宣告連線的關聯 Model 導回應用程式預設連線：

```php
// app/Models/System/SysdataModel.php

namespace App\Models\System;

use Illuminate\Database\Eloquent\Model;

abstract class SysdataModel extends Model
{
    protected $connection = 'sysdata';

    protected function newRelatedInstance($class)
    {
        return tap(new $class, function ($instance) {
            if (! $instance->getConnectionName()) {
                $instance->setConnection(config('database.default'));
            }
        });
    }
}
```

所有 sysdata 的 Model 繼承此類別即可，主資料庫的 Model 不需任何修改：

```
SysdataModel (abstract)
├── RequestLog
├── (未來) LoginHistory
├── (未來) NotificationLog
└── (未來) ScheduleLog
```

---

## 資料庫設計

### 欄位說明

| 欄位 | 類型 | 說明 |
|------|------|------|
| `id` | bigint | 自動遞增主鍵 |
| `request_trace_id` | varchar(64) | 請求追蹤 ID，用於串聯同一請求的多筆日誌 |
| `user_id` | bigint unsigned | 操作者（nullable，未登入時為 null） |
| `app_name` | varchar(64) | 應用程式名稱（`config('app.name')`），多專案共用 sysdata 時區分來源 |
| `portal` | varchar(32) | 來源 Portal（`ocadmin` / `ess`） |
| `area` | varchar(32) | 環境標識（`local` / `staging` / `production`） |
| `url` | text | 完整請求 URL |
| `method` | varchar(10) | HTTP 方法（GET / POST / PUT / DELETE 等） |
| `status_code` | smallint unsigned | HTTP 回應狀態碼（200 / 404 / 500 等） |
| `request_data` | json | 請求資料（表單、JSON 等） |
| `response_data` | json | 回應資料（API 回傳結果等） |
| `status` | varchar(32) | 狀態標識（`success` / `error` / `warning` 等） |
| `note` | text | 備註說明 |
| `client_ip` | varchar(45) | 客戶端 IP（支援 IPv6） |
| `api_ip` | varchar(45) | API 伺服器 IP |
| `created_at` | timestamp | 建立時間 |

### Migration

```php
// database/migrations/0001_01_01_000060_create_request_logs_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('request_logs', function (Blueprint $table) {
            $table->id();
            $table->string('request_trace_id', 64)->nullable()->index()->comment('請求追蹤 ID');
            $table->unsignedBigInteger('user_id')->nullable()->index()->comment('操作者');
            $table->string('app_name', 64)->nullable()->comment('應用程式名稱 (APP_NAME)');
            $table->string('portal', 32)->nullable()->index()->comment('來源 Portal');
            $table->string('area', 32)->nullable()->comment('環境 (local/staging/production)');
            $table->text('url')->nullable()->comment('請求 URL');
            $table->string('method', 10)->nullable()->comment('HTTP 方法');
            $table->unsignedSmallInteger('status_code')->nullable()->comment('HTTP 回應狀態碼');
            $table->json('request_data')->nullable()->comment('請求資料');
            $table->json('response_data')->nullable()->comment('回應資料');
            $table->string('status', 32)->nullable()->comment('狀態');
            $table->text('note')->nullable()->comment('備註');
            $table->string('client_ip', 45)->nullable()->comment('客戶端 IP');
            $table->string('api_ip', 45)->nullable()->comment('API 伺服器 IP');
            $table->timestamp('created_at')->nullable()->index();

            // 複合索引
            $table->index(['created_at', 'status']);
            $table->index(['app_name', 'portal', 'created_at']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('request_logs');
    }
};
```

> **注意**：`user_id` 使用 `unsignedBigInteger` 而非 `foreignId()->constrained()`，因為日誌可能位於 `sysdata` 資料庫，無法跨庫建立外鍵約束。應用層透過 Model 關聯查詢即可。

### Model

```php
// app/Models/System/RequestLog.php

namespace App\Models\System;

use App\Models\User;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class RequestLog extends SysdataModel
{
    protected $table = 'request_logs';
    const UPDATED_AT = null;

    protected $fillable = [
        'request_trace_id',
        'user_id',
        'app_name',
        'portal',
        'area',
        'url',
        'method',
        'status_code',
        'request_data',
        'response_data',
        'status',
        'note',
        'client_ip',
        'api_ip',
    ];

    protected $casts = [
        'status_code' => 'integer',
        'request_data' => 'array',
        'response_data' => 'array',
        'created_at' => 'datetime',
    ];

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }
}
```

> **命名說明**：使用 `RequestLog` 而非 `Log`，避免與 Laravel 內建的 `Illuminate\Support\Facades\Log`（用於 `Log::info()` 等）混淆。在同一個檔案中可安全地同時使用兩者：
> ```php
> use App\Models\System\RequestLog;      // 資料庫日誌 Model
> use Illuminate\Support\Facades\Log;     // Laravel 日誌 Facade
> ```

---

## 請求與回應資料分離

將原本的 `data` 欄位拆分為 `request_data` 與 `response_data`：

| 場景 | request_data | response_data |
|------|--------------|---------------|
| 表單提交 | 表單欄位資料 | 處理結果/錯誤訊息 |
| API 呼叫 | 請求參數 | API 回傳結果 |
| 第三方 API | 發送的請求內容 | 收到的回應內容 |
| 錯誤記錄 | 觸發錯誤的請求 | 錯誤詳情/堆疊追蹤 |

---

## 請求資料過濾

記錄請求時，會自動過濾以下內容以避免資料庫膨脹或洩漏敏感資訊。

### 敏感資料過濾

以下欄位會被替換為 `***FILTERED***`：

- `password`
- `password_confirmation`
- `token`
- `secret`
- `api_key`

### Base64 圖片檢測

自動檢測並替換 Base64 編碼的圖片字串。

| 格式 | 範例 | 檢測方式 |
|------|------|---------|
| Data URI | `data:image/png;base64,iVBOR...` | 解析前綴 |
| 純 Base64 | `/9j/4AAQSkZ...` | 檢測 magic bytes |

支援的圖片類型：JPEG、PNG、GIF、WebP、BMP。

替換結果：

```
原始：data:image/png;base64,iVBORw0KGgo...(數 MB)
替換：***BASE64_IMAGE:png,1.5MB***
```

### 大型資料截斷

單一欄位超過 **1MB** 會被替換為 `***TRUNCATED:2.5MB***`。

### 過濾順序

```
請求/回應資料
    ↓
1. 過濾敏感資料（password 等）
    ↓
2. 檢測 Base64 圖片
    ↓
3. 截斷超過 1MB 的欄位
    ↓
寫入資料庫
```

---

## Portal 來源識別

Middleware 根據請求的路由前綴自動判斷 Portal 來源：

| 路由前綴 | portal 值 |
|----------|----------|
| `/{locale}/admin/*` | `ocadmin` |
| `/{locale}/ess/*` | `ess` |
| 其他 | `null` |

```php
// Middleware 內判斷邏輯
$portal = null;
$path = $request->path();

if (preg_match('#^[a-z-]+/admin(/|$)#', $path)) {
    $portal = 'ocadmin';
} elseif (preg_match('#^[a-z-]+/ess(/|$)#', $path)) {
    $portal = 'ess';
}
```

---

## 排程與歸檔

### 排程設定

```php
// routes/console.php

use Illuminate\Support\Facades\Schedule;

Schedule::command('logs:archive')->monthlyOn(1, '03:00');
```

### 歸檔唯一識別符 (archive_id)

由於資料庫 `created_at` 只有秒級精度，歸檔時需產生唯一識別符。

格式：

```
2026-02-06_12-20-33_000001
├────────┘ └──────┘ └────┘
│          │        │
│          │        └── 6 位流水號（同秒內遞增）
│          └─────────── 時間 HH-MM-SS
└────────────────────── 日期 YYYY-MM-DD
```

總長度：26 字元。

### 歸檔 Command

```php
// app/Console/Commands/System/ArchiveLogs.php

class ArchiveLogs extends Command
{
    protected $signature = 'logs:archive {--month= : 指定月份 YYYY-MM}';
    protected $description = '歸檔日誌：匯出上月記錄並刪除超過 6 個月的資料';
}
```

### 歸檔目錄結構

```
storage/logs/archived/
├── logs_2026-01.zip
├── logs_2026-02.zip
└── ...
```

---

## 後台管理介面

後台提供兩個查詢入口，位於 Ocadmin Portal：

### 1. 日誌查詢（資料庫）

查詢近 6 個月的即時日誌。

- **路由**：`/{locale}/admin/system/logs`
- **資料來源**：`request_logs` 資料表
- **功能**：
  - 日期篩選（預設不篩選，顯示全部由新到舊）
  - Portal 來源篩選
  - HTTP Method 篩選
  - 狀態篩選
  - 關鍵字搜尋
  - 分頁（每頁 10 筆）
- **詳情頁**：`/{locale}/admin/system/logs/form?id={id}`

### 2. 歷史日誌查詢（壓縮檔）

查詢已歸檔的歷史日誌。

- **路由**：`/{locale}/admin/system/logs/archived`
- **資料來源**：`storage/logs/archived/*.zip`
- **功能**：
  - 列出所有壓縮檔（顯示月份、檔案大小）
  - 選擇月份後載入該月日誌
  - Portal 來源篩選
  - HTTP Method 篩選
  - 狀態篩選
  - 關鍵字搜尋
- **詳情頁**：`/{locale}/admin/system/logs/archived/form?archive_id={archive_id}`

### 介面差異

| 功能 | 資料庫查詢 | 壓縮檔查詢 |
|------|-----------|-----------|
| 資料範圍 | 近 6 個月 | 6 個月以前 |
| 查詢速度 | 快（SQL 索引） | 較慢（需解壓讀取） |
| 詳情連結 | `?id={id}` | `?archive_id={archive_id}` |
| 即時性 | 即時 | 歸檔後不變 |

---

## 相關檔案

### 核心

| 檔案 | 說明 |
|------|------|
| `app/Repositories/LogDatabaseRepository.php` | 資料庫 Repository |
| `app/Repositories/LogFileRepository.php` | 檔案 Repository（備用） |
| `app/Models/System/SysdataModel.php` | Sysdata 基底 Model（處理跨庫關聯） |
| `app/Models/System/RequestLog.php` | Eloquent Model |
| `app/Http/Middleware/LogRequest.php` | 請求日誌 Middleware |

### 資料庫

| 檔案 | 說明 |
|------|------|
| `database/migrations/0001_01_01_000060_create_request_logs_table.php` | Migration |

### 排程

| 檔案 | 說明 |
|------|------|
| `app/Console/Commands/System/ArchiveLogs.php` | 歸檔 Command |
| `storage/logs/archived/` | 壓縮檔存放目錄 |

### 後台管理

| 檔案 | 說明 |
|------|------|
| `app/Portals/Ocadmin/Core/Controllers/System/LogController.php` | 日誌管理 Controller |
| `app/Portals/Ocadmin/Core/Views/system/log/` | 日誌管理 Blade 視圖 |

---

## 相關文件

- [0100_系統架構.md](0100_系統架構.md)
- [0105_Portal概述.md](0105_Portal概述.md)
- [0106_Ocadmin程式規範.md](0106_Ocadmin程式規範.md)
