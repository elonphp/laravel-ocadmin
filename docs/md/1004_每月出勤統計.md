# 1004 每月出勤統計

## 概述

每月出勤統計（Monthly Attendance Summary）將每日出勤記錄彙整為月度摘要，提供薪資計算、績效考核、人力分析的基礎資料。

## 資料流程

```
hrm_daily_attendances（每日統計）
    - 30-31 筆/月/人
    ↓ 每月批次處理
hrm_monthly_summaries（每月統計）
    - 1 筆/月/人
    ↓ 用於
薪資計算、績效考核、年度統計
```

## 資料表結構

### hrm_monthly_summaries

```php
Schema::create('hrm_monthly_summaries', function (Blueprint $table) {
    $table->id();

    // 基本資訊
    $table->foreignId('employee_id')->comment('員工 ID')
        ->constrained('hrm_employees')->onDelete('cascade');
    $table->string('year_month', 7)->comment('年月（YYYY-MM）');

    // 出勤天數統計
    $table->integer('scheduled_workdays')->default(0)->comment('應出勤天數');
    $table->integer('actual_workdays')->default(0)->comment('實際出勤天數');
    $table->integer('absent_days')->default(0)->comment('缺勤天數');
    $table->integer('holiday_workdays')->default(0)->comment('假日上班天數');

    // 工時統計（單位：分鐘）
    $table->integer('scheduled_minutes')->default(0)->comment('應工作分鐘數');
    $table->integer('work_minutes')->default(0)->comment('實際工作分鐘數');
    $table->integer('overtime_minutes')->default(0)->comment('總加班分鐘數');

    // 加班細分
    $table->integer('weekday_overtime_minutes')->default(0)->comment('平日加班分鐘數');
    $table->integer('holiday_overtime_minutes')->default(0)->comment('假日加班分鐘數');

    // 異常統計
    $table->integer('late_count')->default(0)->comment('遲到次數');
    $table->integer('late_minutes')->default(0)->comment('遲到總分鐘數');
    $table->integer('early_leave_count')->default(0)->comment('早退次數');
    $table->integer('early_leave_minutes')->default(0)->comment('早退總分鐘數');

    // 請假統計（與請假系統整合）
    $table->integer('annual_leave_days')->default(0)->comment('特休天數');
    $table->integer('sick_leave_days')->default(0)->comment('病假天數');
    $table->integer('personal_leave_days')->default(0)->comment('事假天數');
    $table->integer('other_leave_days')->default(0)->comment('其他假別天數');

    // 狀態
    $table->enum('status', [
        'draft',       // 草稿（月份尚未結束）
        'pending',     // 待審核（月份已結束）
        'approved',    // 已審核
        'locked',      // 已鎖定（已用於薪資計算）
    ])->default('draft')->comment('狀態');

    $table->text('note')->nullable()->comment('備註');
    $table->foreignId('reviewed_by')->nullable()->comment('審核人 ID')
        ->constrained('users')->nullOnDelete();
    $table->timestamp('reviewed_at')->nullable()->comment('審核時間');
    $table->timestamp('calculated_at')->nullable()->comment('最後計算時間');

    $table->timestamps();
    $table->softDeletes();

    // 唯一約束
    $table->unique(['employee_id', 'year_month']);

    // 索引
    $table->index(['year_month']);
    $table->index(['status']);
});
```

## 欄位說明

### 天數統計

| 欄位 | 說明 | 來源 |
|------|------|------|
| scheduled_workdays | 應出勤天數 | 從 `hrm_calendar_days` 計算當月工作日數 |
| actual_workdays | 實際出勤天數 | `COUNT(is_absent = false AND work_minutes > 0)` |
| absent_days | 缺勤天數 | `COUNT(is_absent = true)` |
| holiday_workdays | 假日上班天數 | `COUNT(is_holiday_work = true)` |

### 工時統計

| 欄位 | 說明 | 計算方式 |
|------|------|----------|
| scheduled_minutes | 應工作分鐘數 | `SUM(scheduled_minutes)` |
| work_minutes | 實際工作分鐘數 | `SUM(work_minutes)` |
| overtime_minutes | 總加班分鐘數 | weekday_overtime + holiday_overtime |
| weekday_overtime_minutes | 平日加班 | 工作日超過標準工時的部分 |
| holiday_overtime_minutes | 假日加班 | 假日工作的全部時數 |

### 異常統計

| 欄位 | 說明 | 計算方式 |
|------|------|----------|
| late_count | 遲到次數 | `COUNT(is_late = true)` |
| late_minutes | 遲到總分鐘數 | `SUM(late_minutes)` |
| early_leave_count | 早退次數 | `COUNT(is_early_leave = true)` |
| early_leave_minutes | 早退總分鐘數 | `SUM(early_leave_minutes)` |

### 狀態說明

| 狀態 | 說明 | 時機 |
|------|------|------|
| draft | 草稿 | 月份尚未結束，持續更新中 |
| pending | 待審核 | 月份已結束，等待 HR 確認 |
| approved | 已審核 | HR 已審核確認 |
| locked | 已鎖定 | 已用於薪資計算，不可修改 |

## 核心業務邏輯

### 1. 月統計計算

```php
class MonthlyAttendanceService
{
    public function processMonthlyAttendance(int $employeeId, string $yearMonth): MonthlySummary
    {
        // 1. 取得或建立月統計記錄
        $summary = MonthlySummary::firstOrNew([
            'employee_id' => $employeeId,
            'year_month' => $yearMonth,
        ]);

        // 2. 取得該月所有每日記錄
        $dailyAttendances = DailyAttendance::where('employee_id', $employeeId)
            ->whereYear('work_date', substr($yearMonth, 0, 4))
            ->whereMonth('work_date', substr($yearMonth, 5, 2))
            ->get();

        // 3. 取得該月工作日數
        $scheduledWorkdays = $this->countWorkdays($yearMonth);

        // 4. 統計各項數據
        $stats = $this->calculateStatistics($dailyAttendances, $scheduledWorkdays);

        // 5. 取得請假統計
        $leaveStats = $this->getLeaveStatistics($employeeId, $yearMonth);

        // 6. 更新統計資料
        $summary->fill(array_merge($stats, $leaveStats));
        $summary->calculated_at = now();

        // 7. 判斷狀態
        $summary->status = $this->determineStatus($yearMonth, $summary->status);
        $summary->save();

        return $summary;
    }

    protected function calculateStatistics($dailyAttendances, $scheduledWorkdays): array
    {
        return [
            'scheduled_workdays' => $scheduledWorkdays,
            'actual_workdays' => $dailyAttendances->where('is_absent', false)
                ->where('work_minutes', '>', 0)->count(),
            'absent_days' => $dailyAttendances->where('is_absent', true)->count(),
            'holiday_workdays' => $dailyAttendances->where('is_holiday_work', true)->count(),

            'scheduled_minutes' => $dailyAttendances->sum('scheduled_minutes'),
            'work_minutes' => $dailyAttendances->sum('work_minutes'),
            'weekday_overtime_minutes' => $dailyAttendances
                ->where('is_holiday_work', false)->sum('overtime_minutes'),
            'holiday_overtime_minutes' => $dailyAttendances
                ->where('is_holiday_work', true)->sum('work_minutes'),
            'overtime_minutes' => $dailyAttendances->sum('overtime_minutes'),

            'late_count' => $dailyAttendances->where('is_late', true)->count(),
            'late_minutes' => $dailyAttendances->sum('late_minutes'),
            'early_leave_count' => $dailyAttendances->where('is_early_leave', true)->count(),
            'early_leave_minutes' => $dailyAttendances->sum('early_leave_minutes'),
        ];
    }

    protected function determineStatus($yearMonth, $currentStatus): string
    {
        $monthEnd = Carbon::parse($yearMonth . '-01')->endOfMonth();

        if (Carbon::now()->lte($monthEnd)) {
            return 'draft';  // 月份未結束
        }

        if ($currentStatus === 'draft') {
            return 'pending';  // 月份已結束，待審核
        }

        return $currentStatus;  // 保持現有狀態
    }
}
```

### 2. 批次處理

```php
class ProcessMonthlyAttendances extends Command
{
    protected $signature = 'attendance:process-monthly {year_month?}';

    public function handle(MonthlyAttendanceService $service)
    {
        $yearMonth = $this->argument('year_month')
            ?? Carbon::now()->subMonth()->format('Y-m');

        $employees = Employee::where('is_active', true)->get();

        foreach ($employees as $employee) {
            $service->processMonthlyAttendance($employee->id, $yearMonth);
        }
    }
}
```

**排程設定**：
```php
// app/Console/Kernel.php
$schedule->command('attendance:process-monthly')
    ->monthlyOn(1, '02:00')  // 每月 1 號凌晨 2 點處理上個月
    ->withoutOverlapping();

// 或每天執行（自動更新當月統計）
$schedule->command('attendance:process-monthly ' . date('Y-m'))
    ->dailyAt('03:00');
```

## 薪資計算整合

### 計算月薪

```php
class SalaryCalculator
{
    public function calculateMonthlySalary(int $employeeId, string $yearMonth): array
    {
        $employee = Employee::findOrFail($employeeId);
        $summary = MonthlySummary::where('employee_id', $employeeId)
            ->where('year_month', $yearMonth)
            ->firstOrFail();

        // 基本月薪
        $baseSalary = $employee->base_salary;

        // 時薪
        $hourlyRate = $baseSalary / ($summary->scheduled_minutes / 60);

        // 實際工時薪資
        $actualSalary = ($summary->work_minutes / 60) * $hourlyRate;

        // 加班費（平日 1.33 倍，假日 2 倍）
        $weekdayOvertimePay = ($summary->weekday_overtime_minutes / 60) * $hourlyRate * 1.33;
        $holidayOvertimePay = ($summary->holiday_overtime_minutes / 60) * $hourlyRate * 2;

        // 缺勤扣款
        $absentDeduction = ($summary->absent_days * 8) * $hourlyRate;

        // 遲到扣款
        $lateDeduction = ($summary->late_minutes / 60) * $hourlyRate;

        // 應發薪資
        $totalSalary = $baseSalary + $weekdayOvertimePay + $holidayOvertimePay
                     - $absentDeduction - $lateDeduction;

        return [
            'base_salary' => $baseSalary,
            'overtime_pay' => $weekdayOvertimePay + $holidayOvertimePay,
            'deductions' => $absentDeduction + $lateDeduction,
            'total_salary' => $totalSalary,
        ];
    }
}
```

### 鎖定與解鎖

```php
// 鎖定（薪資計算後）
$summary->update([
    'status' => 'locked',
    'reviewed_by' => auth()->id(),
    'reviewed_at' => now(),
]);

// 解鎖（需特殊權限）
$summary->update([
    'status' => 'approved',
    'note' => "解鎖原因：{$reason}",
]);
```

## 與其他表的關聯

### 資料輸入

**hrm_daily_attendances** → 彙總每日統計
```php
// 從每日統計彙總
$monthlySummary->work_minutes = DailyAttendance::where('employee_id', $employeeId)
    ->whereYear('work_date', $year)
    ->whereMonth('work_date', $month)
    ->sum('work_minutes');

$monthlySummary->overtime_minutes = DailyAttendance::...->sum('overtime_minutes');
$monthlySummary->late_count = DailyAttendance::...->where('is_late', true)->count();
$monthlySummary->absent_days = DailyAttendance::...->where('is_absent', true)->count();
```

**hrm_calendar_days** → 計算應出勤天數
```php
$scheduledWorkdays = CalendarDay::where('date', 'like', $yearMonth . '%')
    ->where('is_workday', true)
    ->count();
```

**hrm_leaves（請假系統）** → 統計請假天數
```php
$annualLeaveDays = Leave::where('employee_id', $employeeId)
    ->where('leave_type', 'annual')
    ->whereYear('date', $year)
    ->whereMonth('date', $month)
    ->sum('days');
```

### 資料輸出

**薪資系統** ← 使用月統計計算薪資
- `work_minutes` → 基本薪資
- `weekday_overtime_minutes` → 平日加班費（× 1.33）
- `holiday_overtime_minutes` → 假日加班費（× 2.0）
- `late_minutes` → 遲到扣款
- `absent_days` → 缺勤扣款

**績效考核** ← 使用月統計評估績效
- `actual_workdays / scheduled_workdays` → 出勤率
- `late_count` → 遲到次數
- `early_leave_count` → 早退次數

## API 端點（簡要）

```php
// 查詢月統計
GET /api/hrm/monthly-summaries?employee_id=123&year=2025

// 查詢單月
GET /api/hrm/monthly-summaries?employee_id=123&year_month=2025-10

// 處理月統計
POST /api/hrm/monthly-summaries/process
{
    "employee_id": 123,
    "year_month": "2025-10"
}

// 審核通過
POST /api/hrm/monthly-summaries/{id}/approve

// 鎖定
POST /api/hrm/monthly-summaries/{id}/lock

// 解鎖
POST /api/hrm/monthly-summaries/{id}/unlock
{
    "reason": "薪資計算錯誤，需重新計算"
}

// 取得薪資計算
GET /api/hrm/monthly-summaries/{id}/salary-calculation

// 匯出報表
GET /api/hrm/monthly-summaries/export?year_month=2025-10
```

## 效能優化

### 快取月統計

```php
// 快取當月統計
$cacheKey = "monthly_summary_{$employeeId}_{$yearMonth}";
$summary = Cache::remember($cacheKey, 3600, function() use ($employeeId, $yearMonth) {
    return MonthlySummary::where('employee_id', $employeeId)
        ->where('year_month', $yearMonth)
        ->first();
});

// 更新時清除快取
Cache::forget($cacheKey);
```

### 索引策略

```sql
-- 查詢優化
CREATE INDEX idx_year_month ON hrm_monthly_summaries(year_month);
CREATE INDEX idx_employee_month ON hrm_monthly_summaries(employee_id, year_month);
CREATE INDEX idx_status ON hrm_monthly_summaries(status);
```

## 總結

### 設計重點

✅ **一月一筆**：員工 × 月份唯一
✅ **完整統計**：天數、工時、加班、異常、請假
✅ **狀態管理**：草稿 → 待審核 → 已審核 → 已鎖定
✅ **薪資整合**：提供薪資計算所需的所有數據
✅ **自動批次**：每月自動處理，每天可更新當月
✅ **資料完整**：關聯每日統計，可回溯查證

### 實作優先序

**Phase 1**：
- 資料表建立
- 基本統計邏輯
- 批次指令

**Phase 2**：
- 薪資計算整合
- 鎖定/解鎖機制

**Phase 3**：
- 報表匯出（Excel）
- 年度統計分析
- 績效考核整合

## 相關文件

- [1000_差勤系統概述](1000_差勤系統概述.md)
- [1001_行事曆作業](1001_行事曆作業.md)
- [1002_原始打卡表](1002_原始打卡表.md)
- [1003_每日出勤統計](1003_每日出勤統計.md)
