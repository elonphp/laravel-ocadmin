# 1002 原始打卡表

## 概述

原始打卡表（Clock Records）儲存所有打卡的原始資料，是差勤系統的基礎資料來源。每次打卡都會產生一筆記錄，後續的每日統計與每月統計都基於這些原始記錄計算。

## 設計理念

### 為什麼需要原始打卡表？

1. **保留完整歷史**：員工一天可能多次進出，需要完整記錄
2. **資料來源追溯**：可追蹤每筆記錄的來源（設備、網頁、APP、手動）
3. **異常處理**：統計異常時可回溯原始記錄查明原因
4. **審計需求**：符合勞動法規對出勤記錄的保存要求

### 與每日統計的關係

```
原始打卡表（hrm_clock_records）- 一天多筆
    - 08:55 in（門禁進門）
    - 12:00 out（門禁出門）
    - 13:05 in（門禁進門）
    - 18:10 out（門禁出門）
              ↓ 每日批次處理
每日出勤統計（hrm_daily_attendances）- 一天一筆
    - 上班：08:55
    - 下班：18:10
    - 工時：8小時15分
```

## 資料表結構

### hrm_clock_records

```php
Schema::create('hrm_clock_records', function (Blueprint $table) {
    $table->id();

    // 基本資訊
    $table->foreignId('employee_id')->comment('員工 ID')
        ->constrained('hrm_employees')->onDelete('cascade');

    $table->dateTime('clocked_at')->comment('打卡時間');

    // 打卡類型（簡化設計）
    $table->enum('clock_type', [
        'in',        // 進（上班、門禁進門、任何進入動作）
        'out',       // 出（下班、門禁出門、任何離開動作）
        'other',     // 其他（無法歸類的特殊情況）
    ])->comment('打卡類型');

    // 打卡方式
    $table->enum('clock_method', [
        'device',    // 實體設備（打卡鐘、門禁、指紋機、人臉辨識機）
        'web',       // 網頁打卡
        'app',       // 行動 APP
        'manual',    // 手動補登
        'import',    // 批次匯入
    ])->default('device')->comment('打卡方式');

    // 設備/位置資訊
    $table->string('device_id', 50)->nullable()->comment('設備編號');
    $table->string('device_name', 100)->nullable()->comment('設備名稱');
    $table->string('location', 100)->nullable()->comment('打卡地點');

    // GPS 定位（APP 打卡用）
    $table->decimal('latitude', 10, 7)->nullable()->comment('緯度');
    $table->decimal('longitude', 10, 7)->nullable()->comment('經度');

    // 生物辨識資訊
    $table->string('verification_method', 20)->nullable()
        ->comment('驗證方式：face, fingerprint, card, password');
    $table->decimal('verification_score', 5, 2)->nullable()
        ->comment('辨識信心分數（0-100）');

    // 照片證據（可選）
    $table->string('photo_path')->nullable()->comment('打卡照片路徑');

    // 審核狀態
    $table->enum('status', [
        'pending',   // 待審核（手動補登時）
        'approved',  // 已審核通過
        'rejected',  // 已駁回
        'voided',    // 已作廢
    ])->default('approved')->comment('審核狀態');

    $table->text('note')->nullable()->comment('備註');
    $table->foreignId('approved_by')->nullable()->comment('審核人 ID')
        ->constrained('users')->nullOnDelete();
    $table->timestamp('approved_at')->nullable()->comment('審核時間');

    // IP 位址（安全性）
    $table->string('ip_address', 45)->nullable()->comment('打卡 IP');
    $table->text('user_agent')->nullable()->comment('瀏覽器/APP 資訊');

    $table->timestamps();
    $table->softDeletes();

    // 索引
    $table->index(['employee_id', 'clocked_at']);
    $table->index(['clocked_at']);
    $table->index(['status']);
    $table->index(['clock_method']);

    // 唯一約束：同員工、同時間、同方式不能重複
    $table->unique(['employee_id', 'clocked_at', 'clock_method']);
});
```

## 欄位說明

### 打卡類型（clock_type）

| 類型 | 說明 | 使用場景 |
|------|------|----------|
| **in** | 進入 | 上班打卡、門禁進門、外出後返回 |
| **out** | 離開 | 下班打卡、門禁出門、外出用餐 |
| **other** | 其他 | 無法歸類的特殊情況（保留欄位）|

**設計理念**：
- 語意放寬：`in/out` 不僅是「上班/下班」，而是廣義的「進/出」
- 智能判斷：系統自動判斷第一個 `in` = 上班，最後一個 `out` = 下班
- 彈性應用：適用於傳統打卡機、門禁系統、APP 打卡等各種場景

### 打卡方式（clock_method）

| 方式 | 說明 | 特點 |
|------|------|------|
| device | 實體設備 | 打卡鐘、指紋機、人臉辨識機、門禁讀卡機 |
| web | 網頁打卡 | 適合居家辦公或辦公室電腦打卡 |
| app | 行動 APP | 支援 GPS 定位，適合外勤人員 |
| manual | 手動補登 | 忘記打卡時由主管或 HR 補登 |
| import | 批次匯入 | 從外部系統或 CSV 檔案匯入 |

### 應用場景範例

**場景 1：傳統打卡機**
```
08:55 按「上班」→ clock_type='in', clock_method='device'
18:10 按「下班」→ clock_type='out', clock_method='device'
```

**場景 2：門禁系統（自動記錄）**
```
08:55 刷卡進門 → clock_type='in', clock_method='device', device_id='GATE-01'
12:00 刷卡出門 → clock_type='out', clock_method='device'
13:05 刷卡進門 → clock_type='in', clock_method='device'
18:10 刷卡出門 → clock_type='out', clock_method='device'

處理結果：
- 上班時間：08:55（第一個 in）
- 下班時間：18:10（最後一個 out）
```

**場景 3：APP 打卡 + GPS**
```
clock_method='app'
latitude=25.0330
longitude=121.5654
→ 系統驗證是否在允許範圍內
```

## 核心業務邏輯

### 1. 建立打卡記錄

```php
class ClockService
{
    public function clock(array $data): ClockRecord
    {
        // 驗證重複打卡（5分鐘內相同類型）
        $this->validateDuplicateClock(
            $data['employee_id'],
            $data['clocked_at'],
            $data['clock_type']
        );

        // 建立記錄
        $record = ClockRecord::create([
            'employee_id' => $data['employee_id'],
            'clocked_at' => $data['clocked_at'],
            'clock_type' => $data['clock_type'],
            'clock_method' => $data['clock_method'],
            'device_id' => $data['device_id'] ?? null,
            'location' => $data['location'] ?? null,
            'latitude' => $data['latitude'] ?? null,
            'longitude' => $data['longitude'] ?? null,
            'ip_address' => request()->ip(),
            'user_agent' => request()->userAgent(),
            'status' => $data['clock_method'] === 'manual' ? 'pending' : 'approved',
        ]);

        return $record;
    }

    protected function validateDuplicateClock($employeeId, $clockedAt, $clockType): void
    {
        $exists = ClockRecord::where('employee_id', $employeeId)
            ->where('clock_type', $clockType)
            ->whereBetween('clocked_at', [
                Carbon::parse($clockedAt)->subMinutes(5),
                Carbon::parse($clockedAt)->addMinutes(5),
            ])
            ->exists();

        if ($exists) {
            throw new DuplicateClockException('5分鐘內已有相同類型的打卡記錄');
        }
    }
}
```

### 2. GPS 位置驗證

```php
class ClockLocationValidator
{
    public function validate(float $latitude, float $longitude): bool
    {
        $allowedLocations = config('hrm.clock_locations', []);

        foreach ($allowedLocations as $location) {
            $distance = $this->calculateDistance(
                $latitude, $longitude,
                $location['latitude'], $location['longitude']
            );

            if ($distance <= $location['radius']) {
                return true;
            }
        }

        return false;
    }

    protected function calculateDistance($lat1, $lon1, $lat2, $lon2): float
    {
        // Haversine formula
        $earthRadius = 6371000; // 公尺
        $dLat = deg2rad($lat2 - $lat1);
        $dLon = deg2rad($lon2 - $lon1);

        $a = sin($dLat/2) * sin($dLat/2) +
             cos(deg2rad($lat1)) * cos(deg2rad($lat2)) *
             sin($dLon/2) * sin($dLon/2);

        $c = 2 * atan2(sqrt($a), sqrt(1-$a));

        return $earthRadius * $c;
    }
}
```

## 匯入匯出功能

### CSV 格式

```csv
employee_number,clocked_at,clock_type,device_id,location
E001,2025-10-10 08:55:30,in,GATE-01,台北總部大門
E001,2025-10-10 18:10:45,out,GATE-01,台北總部大門
E002,2025-10-10 09:02:15,in,GATE-01,台北總部大門
```

### 匯入指令

```php
class ImportClockRecords extends Command
{
    protected $signature = 'clock:import {file}';

    public function handle(ClockService $service)
    {
        $csv = Reader::createFromPath($this->argument('file'), 'r');
        $csv->setHeaderOffset(0);

        foreach ($csv->getRecords() as $record) {
            $employee = Employee::where('employee_number', $record['employee_number'])->first();

            if ($employee) {
                $service->clock([
                    'employee_id' => $employee->id,
                    'clocked_at' => $record['clocked_at'],
                    'clock_type' => $record['clock_type'],
                    'clock_method' => 'import',
                    'device_id' => $record['device_id'] ?? null,
                ]);
            }
        }
    }
}
```

### 匯出指令

```php
class ExportClockRecords extends Command
{
    protected $signature = 'clock:export {--start=} {--end=} {--output=}';

    public function handle()
    {
        $records = ClockRecord::with('employee')
            ->whereBetween('clocked_at', [$this->option('start'), $this->option('end')])
            ->get();

        $csv = Writer::createFromPath($this->option('output'), 'w+');
        $csv->insertOne(['employee_number', 'employee_name', 'clocked_at', 'clock_type', 'device_id']);

        foreach ($records as $record) {
            $csv->insertOne([
                $record->employee->employee_number,
                $record->employee->name,
                $record->clocked_at,
                $record->clock_type,
                $record->device_id,
            ]);
        }
    }
}
```

## 與其他表的關聯

### 資料輸出

**hrm_daily_attendances** ← 彙整原始打卡
```php
// 取得當天所有打卡記錄
$clockRecords = ClockRecord::where('employee_id', $employeeId)
    ->whereDate('clocked_at', $date)
    ->orderBy('clocked_at')
    ->get();

// 第一筆 in → clocked_in
$clockedIn = $clockRecords->where('clock_type', 'in')->first();

// 最後一筆 out → clocked_out
$clockedOut = $clockRecords->where('clock_type', 'out')->last();
```

## Config 設定

```php
// config/hrm.php
return [
    // GPS 打卡允許地點
    'clock_locations' => [
        [
            'name' => '台北總部',
            'latitude' => 25.0330,
            'longitude' => 121.5654,
            'radius' => 100,  // 允許範圍（公尺）
        ],
        [
            'name' => '新竹分公司',
            'latitude' => 24.8138,
            'longitude' => 120.9675,
            'radius' => 100,
        ],
    ],
];
```

## API 端點（簡要）

```php
// 查詢打卡記錄
GET /api/hrm/clock-records?employee_id=123&date=2025-10-10

// 建立打卡（網頁/APP）
POST /api/hrm/clock-records
{
    "employee_id": 123,
    "clock_type": "in",
    "clock_method": "app",
    "latitude": 25.0330,
    "longitude": 121.5654
}

// 手動補登
POST /api/hrm/clock-records/manual
{
    "employee_id": 123,
    "clocked_at": "2025-10-10 08:55:00",
    "clock_type": "in",
    "note": "忘記打卡"
}

// 審核補登記錄
POST /api/hrm/clock-records/{id}/approve

// 批次匯入
POST /api/hrm/clock-records/import
// 上傳 CSV 檔案

// 匯出
GET /api/hrm/clock-records/export?start_date=2025-10-01&end_date=2025-10-31
```

## 資料保留與效能

### 資料分區（大量資料時）

```php
// 按月份分區（MySQL 8.0+）
CREATE TABLE hrm_clock_records (
    -- ... 欄位定義 ...
) PARTITION BY RANGE (YEAR(clocked_at) * 100 + MONTH(clocked_at)) (
    PARTITION p202510 VALUES LESS THAN (202511),
    PARTITION p202511 VALUES LESS THAN (202512),
    -- ...
);
```

### 資料保留政策

```php
// 定期清理過舊資料（如：7年前）
class CleanOldClockRecords extends Command
{
    protected $signature = 'clock:clean {--years=7}';

    public function handle()
    {
        $cutoffDate = Carbon::now()->subYears($this->option('years'));

        // 先匯出備份
        $this->call('clock:export', [
            '--start' => $cutoffDate->format('Y-m-d'),
            '--end' => $cutoffDate->copy()->addYear()->format('Y-m-d'),
            '--output' => storage_path("backups/clock_{$cutoffDate->year}.csv"),
        ]);

        // 再刪除
        ClockRecord::where('clocked_at', '<', $cutoffDate)->delete();
    }
}
```

## 總結

### 設計重點

✅ **完整記錄**：保留所有原始打卡資料
✅ **簡化類型**：in/out/other 三種類型，語意放寬
✅ **多種方式**：支援設備、網頁、APP、手動、匯入
✅ **防重複**：5分鐘內相同類型不重複
✅ **GPS 驗證**：APP 打卡可驗證位置
✅ **匯入匯出**：CSV 格式，與傳統設備整合
✅ **審核機制**：手動補登需要審核

### 實作優先序

**Phase 1**：
- 資料表建立
- 基本 CRUD
- CSV 匯入/匯出

**Phase 2**：
- 網頁打卡
- 手動補登與審核
- 防重複邏輯

**Phase 3**：
- APP 打卡與 GPS 驗證
- 人臉辨識設備串接

## 相關文件

- [1000_差勤系統概述](1000_差勤系統概述.md)
- [1001_行事曆作業](1001_行事曆作業.md)
- [1003_每日出勤統計](1003_每日出勤統計.md)
- [1004_每月出勤統計](1004_每月出勤統計.md)
