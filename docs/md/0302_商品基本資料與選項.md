# 0302 商品基本資料與選項（Products & Product Options）

## 概述

商品模組是電商系統的核心，管理可銷售的商品資料，包括名稱、價格、庫存、圖片等基本資訊，
以及商品與選項（Options）的關聯設定——每個商品可綁定多個選項，並為每個選項值設定價格/重量等修飾。

參考來源：OpenCart 4.x `catalog/product` 模組，並依本系統規範轉換為 Laravel + Blade 架構。

**前置依賴**：`0301 選項與選項值` 模組（`clg_options`、`clg_option_values` 表已存在）。

---

## 資料表設計

### clg_products（商品主表）

| 欄位             | 類型              | 說明                          |
|------------------|-------------------|-------------------------------|
| id               | bigint PK         | 主鍵                          |
| model            | string(64)        | 商品型號 / SKU                |
| image            | string(255) null  | 主圖路徑                      |
| price            | decimal(15,4) 0   | 售價                          |
| quantity         | int default 0     | 庫存數量                      |
| minimum          | int default 1     | 最低訂購量                    |
| subtract         | boolean default 1 | 是否扣庫存                    |
| stock_status_id  | int nullable      | 缺貨狀態 ID（未來關聯用）      |
| shipping         | boolean default 1 | 是否需要出貨                  |
| weight           | decimal(15,8) 0   | 重量                          |
| weight_class_id  | int nullable      | 重量單位 ID（未來關聯用）      |
| length           | decimal(15,8) 0   | 長度                          |
| width            | decimal(15,8) 0   | 寬度                          |
| height           | decimal(15,8) 0   | 高度                          |
| length_class_id  | int nullable      | 長度單位 ID（未來關聯用）      |
| status           | boolean default 1 | 啟用/停用                     |
| sort_order       | int default 0     | 排序                          |
| date_available   | date nullable     | 上架日期                      |
| created_at       | timestamp         |                               |
| updated_at       | timestamp         |                               |

> **簡化說明**：OpenCart 另有 `manufacturer_id`、`tax_class_id`、`points`、`master_id`（變體）等欄位，
> 本階段先不建立，待相關子系統就緒後再以 nullable FK 方式加入。

### clg_product_translations（商品翻譯表）

| 欄位             | 類型            | 說明               |
|------------------|-----------------|--------------------|
| id               | bigint PK       | 主鍵               |
| product_id       | bigint FK       | 關聯 clg_products.id |
| locale           | string(10)      | 語系代碼           |
| name             | string(255)     | 商品名稱           |
| description      | text nullable   | 商品描述（HTML）    |
| meta_title       | string(255)     | SEO 標題           |
| meta_keyword     | string(255) null| SEO 關鍵字         |
| meta_description | text nullable   | SEO 描述           |
| tag              | string(255) null| 標籤（逗號分隔）    |

- UNIQUE：`(product_id, locale)`
- CASCADE DELETE

### clg_product_options（商品選項關聯表）

| 欄位              | 類型            | 說明                                  |
|-------------------|-----------------|---------------------------------------|
| id                | bigint PK       | 主鍵                                  |
| product_id        | bigint FK       | 關聯 clg_products.id                  |
| option_id         | bigint FK       | 關聯 clg_options.id                   |
| value             | text nullable   | 文字型選項的預設值（text/textarea/date/time/datetime） |
| required          | boolean default 0 | 是否必填                             |

- CASCADE DELETE（product_id）

> **用途**：記錄「這個商品使用了哪些選項」。
> 選擇型（select/radio/checkbox）的具體值放在 `clg_product_option_values`；
> 輸入型（text/textarea/file/date/time/datetime）的值放在 `value` 欄位。

### clg_product_option_values（商品選項值表）

| 欄位                   | 類型              | 說明                           |
|------------------------|-------------------|--------------------------------|
| id                     | bigint PK         | 主鍵                           |
| product_option_id      | bigint FK         | 關聯 clg_product_options.id    |
| product_id             | bigint FK         | 關聯 clg_products.id（冗餘，加速查詢） |
| option_id              | bigint FK         | 關聯 clg_options.id（冗餘）     |
| option_value_id        | bigint FK         | 關聯 clg_option_values.id      |
| quantity               | int default 0     | 此選項值的獨立庫存              |
| subtract               | boolean default 0 | 是否扣除庫存                    |
| price                  | decimal(15,4) 0   | 價格修飾量                     |
| price_prefix           | string(1) '+'     | 價格運算符（+ 或 -）           |
| weight                 | decimal(15,8) 0   | 重量修飾量                     |
| weight_prefix          | string(1) '+'     | 重量運算符（+ 或 -）           |

- CASCADE DELETE（product_option_id）

> **用途**：記錄「這個商品的某個選項，每個選項值對應的價格/重量/庫存修飾」。
> 例如：T-Shirt 的「顏色：紅色」→ 加價 $50、「尺寸：大」→ 加重 0.2kg。

---

## 資料表關聯圖

```
clg_products
├── clg_product_translations       (1:N, by locale)
├── clg_product_options            (1:N)
│   ├── → clg_options              (N:1, 引用選項定義)
│   └── clg_product_option_values  (1:N)
│       └── → clg_option_values    (N:1, 引用選項值定義)
```

---

## 選項類型與表單行為

| 選項類型              | value 欄位 | product_option_values | 表單呈現                |
|-----------------------|------------|----------------------|------------------------|
| select                | 不使用     | 有（含修飾）          | 下拉選單 + 值設定表格    |
| radio                 | 不使用     | 有（含修飾）          | 單選按鈕 + 值設定表格    |
| checkbox              | 不使用     | 有（含修飾）          | 核取方塊 + 值設定表格    |
| text                  | 使用       | 無                   | 文字輸入框              |
| textarea              | 使用       | 無                   | 多行文字輸入框          |
| file                  | 不使用     | 無                   | 檔案上傳               |
| date                  | 使用       | 無                   | 日期選取器              |
| time                  | 使用       | 無                   | 時間選取器              |
| datetime              | 使用       | 無                   | 日期時間選取器          |

---

## 範例資料

### 商品：T-Shirt

```
clg_products: { id: 1, model: 'TS-001', price: 590.0000, quantity: 100, status: 1 }
clg_product_translations:
  - { product_id: 1, locale: 'zh_Hant', name: '經典 T-Shirt', description: '...', meta_title: '經典 T-Shirt' }
  - { product_id: 1, locale: 'en', name: 'Classic T-Shirt', description: '...', meta_title: 'Classic T-Shirt' }

clg_product_options:
  - { id: 1, product_id: 1, option_id: 1, value: null, required: 1 }   ← 顏色（select）
  - { id: 2, product_id: 1, option_id: 2, value: null, required: 1 }   ← 尺寸（radio）

clg_product_option_values:
  # 顏色選項值
  - { product_option_id: 1, product_id: 1, option_id: 1, option_value_id: 1, quantity: 30, subtract: 1, price: 0, price_prefix: '+', weight: 0, weight_prefix: '+' }   ← 黃色
  - { product_option_id: 1, product_id: 1, option_id: 1, option_value_id: 2, quantity: 40, subtract: 1, price: 50, price_prefix: '+', weight: 0, weight_prefix: '+' }  ← 紅色（加價 $50）
  - { product_option_id: 1, product_id: 1, option_id: 1, option_value_id: 3, quantity: 30, subtract: 1, price: 0, price_prefix: '+', weight: 0, weight_prefix: '+' }   ← 綠色

  # 尺寸選項值
  - { product_option_id: 2, product_id: 1, option_id: 2, option_value_id: 4, quantity: 0, subtract: 0, price: 100, price_prefix: '+', weight: 0.2, weight_prefix: '+' }  ← 大（加價 $100、加重 0.2kg）
  - { product_option_id: 2, product_id: 1, option_id: 2, option_value_id: 5, quantity: 0, subtract: 0, price: 0, price_prefix: '+', weight: 0, weight_prefix: '+' }      ← 中
  - { product_option_id: 2, product_id: 1, option_id: 2, option_value_id: 6, quantity: 0, subtract: 0, price: -50, price_prefix: '+', weight: 0, weight_prefix: '+' }     ← 小（減價 $50）
```

---

## 程式架構

### 目錄結構

```
app/
├── Models/Catalog/
│   ├── Product.php
│   ├── ProductTranslation.php
│   ├── ProductOption.php
│   └── ProductOptionValue.php
│
├── Portals/Ocadmin/
│   ├── Modules/Catalog/Product/
│   │   ├── ProductController.php
│   │   └── Views/
│   │       ├── index.blade.php         列表頁
│   │       ├── list.blade.php          AJAX 列表
│   │       └── form.blade.php          新增/編輯表單
│   └── routes/ocadmin.php              （新增 catalog/product 路由）

database/migrations/
└── 2026_02_10_000002_create_product_tables.php

lang/zh_Hant/catalog/
└── product.php
```

### 路由

```
Route prefix: {locale}/admin/catalog/product
Route name prefix: lang.ocadmin.catalog.product.

GET    /                    → index        列表頁
GET    /list                → list         AJAX 列表
GET    /create              → create       新增表單
POST   /                    → store        儲存
GET    /{product}/edit      → edit         編輯表單
PUT    /{product}           → update       更新
DELETE /{product}           → destroy      刪除
POST   /batch-delete        → batchDelete  批次刪除
GET    /autocomplete        → autocomplete 商品自動完成（供未來關聯用）
```

### 選單位置

```
商品型錄（menu-catalog）
├── 商品（catalog.product.index）
└── 選項（catalog.option.index）
```

---

## Model 關聯

```
Product
  ├── translations()      → HasMany ProductTranslation
  ├── translation()       → HasOne  ProductTranslation (current locale)
  └── productOptions()    → HasMany ProductOption
        ├── option()             → BelongsTo Option (clg_options)
        └── productOptionValues() → HasMany ProductOptionValue
              └── optionValue()        → BelongsTo OptionValue (clg_option_values)
```

---

## 表單設計（參考 OpenCart product form）

採用 **Tab 結構**，與 Option 的 fieldset 不同，因商品欄位較多需分頁呈現。

### Tab 1：一般資料（text_general）

多語系欄位，以語系標籤上下堆疊 input-group（與 Option 相同模式）：

- **商品名稱**：多語 input-group（必填）
- **商品描述**：多語 textarea / 富文本
- **Meta 標題**：多語 input-group（必填）
- **Meta 關鍵字**：多語 input-group
- **Meta 描述**：多語 textarea
- **標籤**：多語 input-group（逗號分隔）

### Tab 2：資料（text_data）

商品核心屬性，使用 fieldset 分區：

**Fieldset：型號**
- **型號（Model）**：必填，1-64 字元

**Fieldset：價格**
- **售價（Price）**：decimal

**Fieldset：庫存**
- **數量（Quantity）**：int
- **最低訂購量（Minimum）**：int
- **扣庫存（Subtract）**：boolean switch
- **上架日期（Date Available）**：date

**Fieldset：規格**
- **需出貨（Shipping）**：boolean switch
- **尺寸（L × W × H）**：三欄 decimal
- **重量（Weight）**：decimal
- **狀態（Status）**：boolean switch
- **排序（Sort Order）**：int

### Tab 3：選項（text_option）

動態添加商品選項：

- **搜尋選項**：autocomplete 搜尋 `clg_options`，選擇後添加到頁面
- 每個已添加的選項顯示為一個 **fieldset**：
  - Legend：選項名稱 + 刪除按鈕
  - **必填**：下拉（是/否）
  - **根據選項類型**：
    - 選擇型（select/radio/checkbox）：顯示選項值表格
      - 每列：選項值名稱 | 數量 | 扣庫存 | 價格（前綴 + 金額）| 重量（前綴 + 數值）| 動作
      - 新增按鈕可從該選項的 `clg_option_values` 添加值
    - 輸入型（text/textarea）：文字輸入框
    - 日期型（date/time/datetime）：對應日期選取器

---

## Controller 方法

| 方法          | 回傳             | 說明                        |
|---------------|------------------|-----------------------------|
| index()       | View             | 列表頁，含初始 getList()     |
| list()        | string           | AJAX 入口                   |
| getList()     | string           | 核心查詢邏輯                 |
| create()      | View             | 新增表單                    |
| store()       | JsonResponse     | 儲存（AJAX）                |
| edit()        | View             | 編輯表單                    |
| update()      | JsonResponse     | 更新（AJAX）                |
| destroy()     | JsonResponse     | 刪除（AJAX）                |
| batchDelete() | JsonResponse     | 批次刪除（AJAX）             |
| autocomplete()| JsonResponse     | 商品自動完成搜尋             |

---

## 儲存邏輯（store / update）

1. 驗證商品主表欄位 + 多語翻譯
2. 建立/更新 `clg_products` 記錄
3. 呼叫 `saveTranslations()` 儲存商品翻譯
4. 處理商品選項：
   - update 時先刪除舊的 `product_options` + `product_option_values`
   - 逐筆建立 `clg_product_options` 記錄
   - 若為選擇型：逐筆建立 `clg_product_option_values` 記錄
   - 若為輸入/日期型：值存在 `product_options.value`

---

## 列表頁設計

### 表格欄位

| 欄位     | 說明                    | 排序   |
|----------|------------------------|--------|
| ☑        | 全選核取方塊            | —      |
| 圖片     | 40×40 縮圖             | —      |
| 商品名稱 | 翻譯名稱               | ✔ name |
| 型號     | model                  | ✔ model |
| 價格     | 格式化金額              | ✔ price |
| 數量     | 庫存（含狀態 badge）    | ✔ quantity |
| 狀態     | 啟用/停用               | —      |
| 動作     | 編輯按鈕               | —      |

### 篩選條件

- 商品名稱（filter_name）
- 型號（filter_model）
- 價格範圍（filter_price_from / filter_price_to）
- 數量範圍（filter_quantity_from / filter_quantity_to）
- 狀態（equal_status）

---

## 刪除保護

刪除商品時，cascade 自動刪除：
- `clg_product_translations`
- `clg_product_options` → `clg_product_option_values`

未來如有訂單模組（`ord_order_items`），需檢查商品是否有訂單引用，防止誤刪。

---

## 未來擴展

| 功能         | 資料表                 | 時機             |
|--------------|----------------------|------------------|
| 商品分類     | clg_product_categories | Phase 1 後期     |
| 商品圖片     | clg_product_images    | Phase 1 後期     |
| 折扣/特價    | clg_product_discounts | Phase 2          |
| SEO URL      | clg_product_seo_urls  | Phase 2          |
| 庫存關聯     | clg_products.inv_item_id → inv_items | Phase 2（需 inv_ 子系統） |
| 品牌/製造商  | clg_manufacturers     | Phase 2          |
| 商品屬性     | clg_product_attributes | Phase 2         |
