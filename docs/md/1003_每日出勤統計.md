# 1003 每日出勤統計

## 概述

每日出勤統計（Daily Attendance）將原始打卡記錄彙整為每日的出勤摘要，包含上下班時間、工時計算、遲到早退判斷等。這是差勤系統最核心的資料表，也是薪資計算的重要依據。

## 資料流程

```
hrm_clock_records（原始打卡）
    - 一天多筆（多次進出）
    ↓ 每日批次處理
hrm_daily_attendances（每日統計）
    - 一天一筆（員工 × 日期唯一）
    ↓ 每月批次處理
hrm_monthly_summaries（每月統計）
```

## 資料表結構

### hrm_daily_attendances

```php
Schema::create('hrm_daily_attendances', function (Blueprint $table) {
    $table->id();

    // 基本資訊
    $table->foreignId('employee_id')->comment('員工 ID')
        ->constrained('hrm_employees')->onDelete('cascade');
    $table->date('work_date')->comment('工作日期');

    // 排定時間（從員工設定或排班系統取得）
    $table->dateTime('scheduled_in')->nullable()->comment('排定上班時間');
    $table->dateTime('scheduled_out')->nullable()->comment('排定下班時間');

    // 打卡時間（從 hrm_clock_records 取得）
    $table->dateTime('clocked_in')->nullable()->comment('上班打卡時間');
    $table->dateTime('clocked_out')->nullable()->comment('下班打卡時間');

    // 工作時間（用於計薪）
    $table->dateTime('work_start')->nullable()->comment('工作開始時間（計薪起算）');
    $table->dateTime('work_end')->nullable()->comment('工作結束時間（計薪截止）');

    // 休息時間
    $table->dateTime('break_start')->nullable()->comment('休息開始時間');
    $table->dateTime('break_end')->nullable()->comment('休息結束時間');
    $table->integer('break_minutes')->default(0)->comment('休息分鐘數');

    // 工時統計（單位：分鐘）
    $table->integer('scheduled_minutes')->default(0)->comment('應工作分鐘數');
    $table->integer('work_minutes')->default(0)->comment('實際工作分鐘數');
    $table->integer('overtime_minutes')->default(0)->comment('加班分鐘數');
    $table->integer('late_minutes')->default(0)->comment('遲到分鐘數');
    $table->integer('early_leave_minutes')->default(0)->comment('早退分鐘數');

    // 異常標記
    $table->boolean('is_absent')->default(false)->comment('是否缺勤');
    $table->boolean('is_late')->default(false)->comment('是否遲到');
    $table->boolean('is_early_leave')->default(false)->comment('是否早退');
    $table->boolean('is_overtime')->default(false)->comment('是否加班');
    $table->boolean('is_holiday_work')->default(false)->comment('是否假日上班');
    $table->boolean('is_abnormal')->default(false)->comment('是否嚴重異常（需人工審核）');

    $table->string('abnormal_reason')->nullable()->comment('異常原因');

    // 審核狀態
    $table->enum('status', [
        'pending',      // 待審核（有嚴重異常）
        'approved',     // 已審核通過
        'adjusted',     // 已調整
        'voided',       // 已作廢
    ])->default('pending')->comment('審核狀態');

    $table->text('note')->nullable()->comment('備註');
    $table->foreignId('reviewed_by')->nullable()->comment('審核人 ID')
        ->constrained('users')->nullOnDelete();
    $table->timestamp('reviewed_at')->nullable()->comment('審核時間');

    $table->foreignId('leave_id')->nullable()->comment('請假單 ID')
        ->constrained('hrm_leaves')->nullOnDelete();

    $table->timestamps();
    $table->softDeletes();

    // 唯一約束
    $table->unique(['employee_id', 'work_date']);

    // 索引
    $table->index(['work_date']);
    $table->index(['status']);
    $table->index(['is_abnormal']);
});
```

## 欄位說明

### 時間欄位

| 欄位 | 說明 | 範例 |
|------|------|------|
| scheduled_in/out | 排定上下班時間 | 09:00-18:00 |
| clocked_in/out | 實際打卡時間 | 08:55-18:10 |
| work_start/end | 工作時間（計薪用）| 09:00-18:10 |

**關係範例**：
```
排定時間：09:00-18:00
打卡時間：08:55-18:10（早到5分鐘，晚退10分鐘）
工作時間：09:00-18:10（不計早到，計入延遲下班）
```

- `clocked_*`：記錄實際打卡時間，不做調整
- `work_*`：依公司政策計算的計薪時間

### 工時欄位

| 欄位 | 計算方式 | 說明 |
|------|----------|------|
| scheduled_minutes | `scheduled_out - scheduled_in - break_minutes` | 應工作分鐘數 |
| work_minutes | `work_end - work_start - break_minutes` | 實際工作分鐘數（計薪用）|
| overtime_minutes | `work_minutes - scheduled_minutes` (> 0) | 加班分鐘數 |
| late_minutes | `clocked_in - scheduled_in` (> 容許) | 遲到分鐘數 |
| early_leave_minutes | `scheduled_out - clocked_out` (> 容許) | 早退分鐘數 |

### 異常標記（異常分級）

| 欄位 | 判斷條件 | 處理方式 | status |
|------|----------|----------|--------|
| is_late | 遲到 > 容許時間 | 系統自動扣薪 | approved |
| is_early_leave | 早退 > 容許時間 | 系統自動扣薪 | approved |
| is_overtime | 工時 > 應工作時數 | 系統自動計算加班費 | approved |
| **is_abnormal** | **配對不完整** | **需人工審核** | **pending** |

**嚴重異常（is_abnormal）情況**：
1. 有上班打卡，無下班打卡
2. 有下班打卡，無上班打卡
3. 有休息開始，無休息結束
4. 有休息結束，無休息開始
5. 完全無打卡記錄（缺勤）

**設計理念**：
- 遲到、早退可由系統自動扣薪，不算嚴重異常
- 只有配對不完整、無法計算工時的情況才標記 `is_abnormal = true`

## 核心業務邏輯

### 1. 資料來源與處理

```php
class DailyAttendanceService
{
    public function processDailyAttendance(int $employeeId, Carbon $date): DailyAttendance
    {
        // 1. 取得或建立每日記錄
        $attendance = DailyAttendance::firstOrNew([
            'employee_id' => $employeeId,
            'work_date' => $date->format('Y-m-d'),
        ]);

        // 2. 取得員工當天的打卡記錄
        $clockRecords = ClockRecord::where('employee_id', $employeeId)
            ->whereDate('clocked_at', $date)
            ->where('status', 'approved')
            ->orderBy('clocked_at')
            ->get();

        // 3. 取得排定時間（從排班或員工預設）
        $schedule = $this->getSchedule($employeeId, $date);

        // 4. 取得行事曆資訊
        $calendarDay = CalendarDay::where('date', $date->format('Y-m-d'))->first();
        $isWorkday = $calendarDay ? $calendarDay->is_workday : !$date->isWeekend();

        // 5. 分析打卡記錄
        $analysis = $this->analyzeClockRecords($clockRecords, $schedule, $isWorkday);

        // 6. 更新統計資料
        $attendance->fill($analysis);
        $attendance->save();

        return $attendance;
    }
}
```

### 2. 打卡記錄分析

```php
protected function analyzeClockRecords($clockRecords, $schedule, $isWorkday): array
{
    $result = [
        'clocked_in' => null,
        'clocked_out' => null,
        'is_abnormal' => false,
        'abnormal_reason' => null,
        'status' => 'approved',
    ];

    // 如果是工作日但沒有打卡記錄
    if ($isWorkday && $clockRecords->isEmpty()) {
        return [
            'is_absent' => true,
            'is_abnormal' => true,
            'abnormal_reason' => '缺勤（無打卡記錄）',
            'status' => 'pending',
        ];
    }

    // 取得上下班打卡
    $result['clocked_in'] = $clockRecords->where('clock_type', 'in')->first()?->clocked_at;
    $result['clocked_out'] = $clockRecords->where('clock_type', 'out')->last()?->clocked_at;

    // 檢查配對完整性
    $abnormalReasons = [];

    if ($result['clocked_in'] && !$result['clocked_out']) {
        $abnormalReasons[] = '缺少下班打卡';
    }
    if (!$result['clocked_in'] && $result['clocked_out']) {
        $abnormalReasons[] = '缺少上班打卡';
    }

    if (!empty($abnormalReasons)) {
        $result['is_abnormal'] = true;
        $result['abnormal_reason'] = implode('、', $abnormalReasons);
        $result['status'] = 'pending';  // 需人工審核
    }

    // 計算工作時間
    if ($result['clocked_in'] && $result['clocked_out']) {
        $result['work_start'] = $this->calculateWorkStart($result['clocked_in'], $schedule['in']);
        $result['work_end'] = $this->calculateWorkEnd($result['clocked_out'], $schedule['out']);
        $result['work_minutes'] = $result['work_end']->diffInMinutes($result['work_start'])
                                  - $schedule['break_minutes'];
    }

    // 判斷遲到（不算嚴重異常）
    if ($result['clocked_in'] > $schedule['in']->addMinutes(config('hrm.late_threshold_minutes', 5))) {
        $result['is_late'] = true;
        $result['late_minutes'] = $result['clocked_in']->diffInMinutes($schedule['in']);
    }

    return $result;
}
```

### 3. 工作時間計算

```php
// 計算工作開始時間（計薪用）
protected function calculateWorkStart($clockedIn, $scheduledIn)
{
    $countEarlyArrival = config('hrm.count_early_arrival', false);

    if ($countEarlyArrival) {
        return $clockedIn;  // 計入早到
    }

    // 不計早到：取較晚的時間
    return $clockedIn->lt($scheduledIn) ? $scheduledIn : $clockedIn;
}

// 計算工作結束時間（計薪用）
protected function calculateWorkEnd($clockedOut, $scheduledOut)
{
    $countLateDeparture = config('hrm.count_late_departure', true);

    if ($countLateDeparture) {
        return $clockedOut;  // 計入延遲下班
    }

    // 不計延遲下班：取較早的時間
    return $clockedOut->gt($scheduledOut) ? $scheduledOut : $clockedOut;
}
```

### 4. 批次處理

```php
// 每日批次處理指令
class ProcessDailyAttendances extends Command
{
    protected $signature = 'attendance:process-daily {date?}';

    public function handle(DailyAttendanceService $service)
    {
        $date = $this->argument('date')
            ? Carbon::parse($this->argument('date'))
            : Carbon::yesterday();

        $employees = Employee::where('is_active', true)->get();

        foreach ($employees as $employee) {
            $service->processDailyAttendance($employee->id, $date);
        }
    }
}
```

**排程設定**：
```php
// app/Console/Kernel.php
$schedule->command('attendance:process-daily')
    ->dailyAt('01:00')  // 每天凌晨 1 點處理前一天
    ->withoutOverlapping();
```

## 與其他表的關聯

### 資料輸入

**hrm_clock_records** → 提供原始打卡記錄
- 第一筆 `clock_type = 'in'` → `clocked_in`
- 最後一筆 `clock_type = 'out'` → `clocked_out`

**hrm_calendar_days** → 判斷是否為工作日
- `is_workday` → 決定是否需要檢查出勤

**hrm_employees** → 提供預設工作時間
- `default_work_start/end` → `scheduled_in/out`
- `default_break_minutes` → `break_minutes`

**hrm_shifts（可選）** → 提供排班時間
- 優先於員工預設時間

### 資料輸出

**hrm_monthly_summaries** ← 彙總每日統計
```php
// 每月統計從每日統計彙總
$monthlySummary->work_minutes = DailyAttendance::where('employee_id', $employeeId)
    ->whereYear('work_date', $year)
    ->whereMonth('work_date', $month)
    ->sum('work_minutes');

$monthlySummary->overtime_minutes = DailyAttendance::...->sum('overtime_minutes');
$monthlySummary->late_count = DailyAttendance::...->where('is_late', true)->count();
```

**薪資計算** ← 使用每日統計
- `work_minutes` → 基本薪資計算
- `overtime_minutes` → 加班費計算
- `late_minutes` → 遲到扣款
- `early_leave_minutes` → 早退扣款

## Config 設定

```php
// config/hrm.php
return [
    // 容許時間
    'late_threshold_minutes' => 5,         // 容許遲到 5 分鐘
    'early_leave_threshold_minutes' => 5,  // 容許早退 5 分鐘

    // 預設工作時間
    'default_work_start' => '09:00',
    'default_work_end' => '18:00',
    'default_break_minutes' => 60,

    // 計薪政策
    'count_early_arrival' => false,   // 是否計入早到（false=不計）
    'count_late_departure' => true,   // 是否計入延遲下班（true=計入）
];
```

## 審核與調整

### 審核流程

```php
// HR 審核通過
$attendance->update([
    'status' => 'approved',
    'reviewed_by' => auth()->id(),
    'reviewed_at' => now(),
]);

// 調整工作時間
$attendance->update([
    'work_start' => '09:00:00',
    'work_end' => '18:00:00',
    'status' => 'adjusted',
    'reviewed_by' => auth()->id(),
    'reviewed_at' => now(),
]);

// 重新計算工時
$attendance->work_minutes = $attendance->work_end->diffInMinutes($attendance->work_start)
                           - $attendance->break_minutes;
$attendance->save();
```

## API 端點（簡要）

```php
// 查詢出勤記錄
GET /api/hrm/daily-attendances?employee_id=123&month=2025-10

// 處理指定日期
POST /api/hrm/daily-attendances/process
{
    "employee_id": 123,
    "date": "2025-10-10"
}

// 審核通過
POST /api/hrm/daily-attendances/{id}/approve

// 調整時間
POST /api/hrm/daily-attendances/{id}/adjust
{
    "work_start": "09:00:00",
    "work_end": "18:00:00"
}

// 查詢異常記錄
GET /api/hrm/daily-attendances?status=pending&is_abnormal=1
```

## 總結

### 設計重點

✅ **一天一筆**：員工 × 日期唯一
✅ **清晰命名**：`clocked_*`（打卡）vs `work_*`（計薪）
✅ **異常分級**：輕微異常自動處理，嚴重異常需審核
✅ **配對檢查**：確保上下班、休息時間配對完整
✅ **自動批次**：每日自動處理，無需手動操作
✅ **彈性政策**：可設定早到/延遲下班計薪規則

### 實作優先序

**Phase 1**：
- 資料表建立
- 基本處理邏輯
- 批次指令

**Phase 2**：
- 異常判斷
- 審核調整功能

**Phase 3**：
- 與薪資系統整合
- 完整報表功能

## 相關文件

- [1000_差勤系統概述](1000_差勤系統概述.md)
- [1001_行事曆作業](1001_行事曆作業.md)
- [1002_原始打卡表](1002_原始打卡表.md)
- [1004_每月出勤統計](1004_每月出勤統計.md)
