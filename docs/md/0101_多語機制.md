# 多語機制

本系統的多語分為三個層面，各自獨立運作，共用同一份設定檔。

- **介面多語** — `lang/` 語系檔 + `__()`，用於固定 UI 文字（按鈕、標題、提示訊息）
- **網址多語** — URL 前綴 `/zh-hant/`、`/en/` + `SetLocale` middleware，每次 request 自動切換語系
- **內容多語** — `xxx_translations` 翻譯表 + `HasTranslation` trait，用於後台管理的動態資料（分類名稱、詞彙名稱等）

---

## 統一設定檔

`config/localization.php`

```php
return [
    'supported_locales' => ['zh_Hant', 'en'],
    'default_locale'    => 'zh_Hant',
    'url_mapping'       => [
        'zh-hant' => 'zh_Hant',   // URL 格式 → 內部格式
        'en'      => 'en',
    ],
    'locale_names'      => [
        'zh_Hant' => '繁體中文',
        'en'      => 'English',
    ],
];
```

統一存取方式（不直接呼叫 `config()`）：

```php
use App\Helpers\Classes\LocaleHelper;

LocaleHelper::getSupportedLocales();   // ['zh_Hant', 'en']
LocaleHelper::getLocaleNames();        // ['zh_Hant' => '繁體中文', 'en' => 'English']
LocaleHelper::getDefaultLocale();      // 'zh_Hant'
LocaleHelper::getCurrentLocale();      // 當前語系（內部格式）
LocaleHelper::toUrlFormat('zh_Hant');  // 'zh-hant'
LocaleHelper::toInternalFormat('zh-hant'); // 'zh_Hant'
```

---

## 一、介面多語（Laravel 語系檔）

用途：按鈕文字、欄位標題、提示訊息等**固定的 UI 文字**。

### 目錄結構

```
lang/
├── zh_Hant/
│   ├── common.php      # 通用文字（按鈕、欄位、訊息）
│   └── enums.php       # Enum 顯示名稱
└── en/
    ├── common.php
    └── enums.php
```

### 使用方式

Blade 中：

```blade
{{ __('common.button_save') }}        {{-- 儲存 / Save --}}
{{ __('common.text_confirm_delete') }} {{-- 確定要刪除嗎？ --}}
```

PHP 中：

```php
__('common.column_name')  // 名稱 / Name
```

### 新增語系檔

以新增「員工模組」語系為例：

```
lang/zh_Hant/employee.php
lang/en/employee.php
```

```php
// lang/zh_Hant/employee.php
return [
    'heading_title' => '員工管理',
    'column_employee_id' => '員工編號',
];
```

使用：`__('employee.heading_title')`

### 語言 Key 命名慣例

| 前綴 | 用途 | 範例 |
|------|------|------|
| `heading_` | 頁面標題 | `heading_title` |
| `text_` | 一般文字、訊息 | `text_list`, `text_success_add` |
| `column_` | 欄位標籤（列表、表單、篩選共用） | `column_name`, `column_display_name` |
| `placeholder_` | 輸入提示 | `placeholder_name` |
| `help_` | 欄位說明 | `help_name` |
| `error_` | 錯誤訊息 | `error_has_roles` |
| `button_` | 按鈕文字 | `button_save`（通常放 common） |
| `tab_` | Tab 標籤 | `tab_trans`（通常放 common） |

> **不使用 `entry_` 前綴。** 因為列表欄位標題與表單欄位標籤大部分相同，統一使用 `column_` 避免重複定義。篩選欄位標籤也直接複用 `column_*`。

### 語系如何切換

`SetLocale` middleware 在每次 request 根據 URL 呼叫 `App::setLocale()`，之後所有 `__()` 自動使用對應語系目錄的檔案。

---

## 二、網址多語（URL Locale）

用途：以 URL 前綴區分語系，讓同一頁面可透過不同網址切換語言。

### URL 格式

```
/zh-hant/admin/config/taxonomy        ← 繁體中文
/en/admin/config/taxonomy              ← English
/admin/config/taxonomy                 ← 自動轉址到 /zh-hant/admin/...
```

### 運作流程

```
Request: /en/admin/config/taxonomy/1/edit
    │
    ├─ Route 匹配 {locale}/admin/...
    │
    ├─ SetLocale Middleware（app/Http/Middleware/SetLocale.php）
    │   ├─ segment(1) = "en"
    │   ├─ LocaleHelper::toInternalFormat("en") → "en"
    │   ├─ App::setLocale("en")          ← 影響 __() 和 HasTranslation
    │   ├─ URL::defaults(['locale' => 'en'])  ← 影響 route() 產生的連結
    │   └─ forgetParameter('locale')      ← Controller 不會收到 locale 參數
    │
    └─ Controller / Blade 正常運作，所有 route() 自動帶入 {locale}
```

### 路由定義

```php
// app/Portals/Ocadmin/routes/ocadmin.php
Route::group([
    'prefix'     => '{locale}/admin',
    'as'         => 'lang.ocadmin.',
    'middleware' => 'setLocale',
], function () {
    // ...
});

// 無語系前綴的自動轉址
Route::get('/admin/{any?}', function ($any = '') {
    return redirect("/{$defaultUrlLocale}/admin/{$any}");
})->where('any', '.*');
```

### Middleware 註冊

```php
// bootstrap/app.php
$middleware->alias([
    'setLocale' => \App\Http\Middleware\SetLocale::class,
]);
```

### 為什麼用 Middleware 而不是在路由檔直接呼叫 Helper

路由檔直接呼叫 `LocaleHelper::setLocale()` 作為 prefix，在 `php artisan route:cache` 時 prefix 會被固定成單一語系，導致其他語系 404。Middleware 搭配 `{locale}` 路由參數則不受 route cache 影響。

---

## 三、內容多語（Translation Tables）

用途：由使用者在後台管理的**動態資料**，如分類名稱、詞彙名稱、商品名稱等。

### 資料表結構

每個需要多語的主表，建立對應的 `xxx_translations` 翻譯表：

```
taxonomies                    taxonomy_translations
┌────┬──────┬───────┐        ┌────┬─────────────┬────────┬──────┐
│ id │ code │ ...   │        │ id │ taxonomy_id │ locale │ name │
├────┼──────┼───────┤        ├────┼─────────────┼────────┼──────┤
│  1 │ skill│       │───────→│  1 │           1 │zh_Hant │ 技能 │
│    │      │       │        │  2 │           1 │ en     │Skills│
└────┴──────┴───────┘        └────┴─────────────┴────────┴──────┘
```

翻譯表固定欄位：`id`、`{主表}_id`（外鍵）、`locale`，其餘為可翻譯欄位。

### Model 設定

**主表 Model**（使用 `HasTranslation` trait）：

```php
use App\Traits\HasTranslation;

class Taxonomy extends Model
{
    use HasTranslation;

    protected $fillable = ['code', 'description', 'sort_order', 'is_active'];

    // 宣告哪些欄位是可翻譯的（這些欄位不在主表，在翻譯表）
    public array $translatedAttributes = ['name'];
}
```

**翻譯 Model**（命名慣例：主表名 + `Translation`）：

```php
class TaxonomyTranslation extends Model
{
    public $timestamps = false;
    protected $fillable = ['taxonomy_id', 'locale', 'name'];
}
```

### 存取翻譯

```php
// 自動根據當前語系回傳（透過 getAttribute 覆寫）
$taxonomy->name;                    // "技能"（當 App locale = zh_Hant）

// 指定語系
$taxonomy->translate('en')->name;   // "Skills"

// 帶 fallback
$taxonomy->translateOrDefault('ja')->name;  // 找不到 ja，回傳 fallback 語系

// 取得所有翻譯（陣列）
$taxonomy->getTranslationsArray();
// ['zh_Hant' => ['name' => '技能'], 'en' => ['name' => 'Skills']]
```

### 儲存翻譯

```php
$taxonomy->saveTranslations([
    'zh_Hant' => ['name' => '技能'],
    'en'      => ['name' => 'Skills'],
]);
```

### 查詢 Scope

```php
// 依翻譯欄位模糊查詢（當前語系）
Taxonomy::whereTranslationLike('name', '%技%')->get();

// 篩選有指定語系翻譯的記錄
Taxonomy::translatedIn('en')->get();
```

### Controller 中的 Validation

```php
use App\Helpers\Classes\LocaleHelper;

foreach (LocaleHelper::getSupportedLocales() as $locale) {
    $rules["translations.{$locale}.name"] = 'required|string|max:100';
}
```

### Blade 表單（Tab 分頁）

`LocaleComposer` 自動注入 `$locales` 和 `$localeNames` 給所有 `ocadmin::*` 視圖，不需要 Controller 手動傳入。

```blade
{{-- 第一層：翻譯 / 資料 --}}
<ul class="nav nav-tabs">
    <li class="nav-item"><a href="#tab-trans" data-bs-toggle="tab" class="nav-link active">翻譯</a></li>
    <li class="nav-item"><a href="#tab-data" data-bs-toggle="tab" class="nav-link">資料</a></li>
</ul>

<div class="tab-content">
    <div id="tab-trans" class="tab-pane active">
        {{-- 第二層：語言 sub-tab --}}
        <ul class="nav nav-tabs">
            @foreach($locales as $locale)
            <li class="nav-item">
                <a href="#language-{{ $locale }}" data-bs-toggle="tab"
                   class="nav-link @if($loop->first) active @endif">
                    {{ $localeNames[$locale] ?? $locale }}
                </a>
            </li>
            @endforeach
        </ul>
        <div class="tab-content">
            @foreach($locales as $locale)
            <div id="language-{{ $locale }}" class="tab-pane @if($loop->first) active @endif">
                <div class="row mb-3 required">
                    <label class="col-sm-2 col-form-label">名稱</label>
                    <div class="col-sm-10">
                        <input type="text" name="translations[{{ $locale }}][name]"
                               value="{{ old("translations.{$locale}.name", $translationsArray[$locale]['name'] ?? '') }}"
                               class="form-control">
                    </div>
                </div>
            </div>
            @endforeach
        </div>
    </div>

    <div id="tab-data" class="tab-pane">
        {{-- 代碼、排序、狀態等非翻譯欄位 --}}
    </div>
</div>
```

### 新增可翻譯 Model 的步驟

1. **建立翻譯表 migration**：`xxx_translations`（id, xxx_id, locale, 可翻譯欄位）
2. **建立翻譯 Model**：`XxxTranslation`（`$timestamps = false`）
3. **主表 Model 加入 trait**：`use HasTranslation`，宣告 `$translatedAttributes`
4. **主表不放可翻譯欄位**：`name` 等欄位只在翻譯表

---

## 三者的關係

| 層面 | 資料來源 | 切換時機 | 適用對象 |
|------|----------|----------|----------|
| 介面多語 | `lang/` 語系檔 | `App::setLocale()` | 固定 UI 文字 |
| 網址多語 | URL 第一段 | `SetLocale` middleware | 每次 request |
| 內容多語 | `xxx_translations` 表 | `$model->name` 自動查 locale | 動態資料 |

三者由 `SetLocale` middleware 串聯：middleware 根據 URL 設定 `App::setLocale()`，之後 `__()` 和 `HasTranslation` 都自動使用對應語系。

### 相關檔案

```
config/localization.php                         # 語系設定
app/Helpers/Classes/LocaleHelper.php            # 語系工具
app/Http/Middleware/SetLocale.php               # 網址語系 Middleware
app/Traits/HasTranslation.php                   # 內容多語 Trait
app/Portals/Ocadmin/Core/ViewComposers/LocaleComposer.php  # 自動注入語系變數
lang/zh_Hant/                                   # 繁中語系檔
lang/en/                                        # 英文語系檔
```
