# AdminLTE 分支概述

## 目標

本分支（`adminlte`）將後台介面從 OpenCart 風格改為 **AdminLTE**，提供更現代化的管理介面。

資料表結構、Controllers、Migrations、Seeders 皆比照 main 分支，不做額外變動。

## 優先開發項目

先完成 **左側欄 > 系統管理 > 權限** 相關的 CRUD：

| 功能 | Controller | 路由前綴 |
|------|-----------|---------|
| 權限管理 | `Acl\PermissionController` | `system/permission` |
| 角色管理 | `Acl\RoleController` | `system/role` |
| 使用者管理 | `Acl\UserController` | `system/user` |

其餘模組（商品型錄、會員、人資等）暫不處理。

## Ocadmin 架構

### Portal-Module 結構

```
app/Portals/Adminlte/
  Core/
    Controllers/Acl/          ← 權限/角色/使用者
    Controllers/Config/       ← 分類/詞彙
    Controllers/System/       ← 日誌/結構/設定
    Views/                    ← Core Blade 視圖
    ViewComposers/            ← MenuComposer（側邊欄選單）
  Modules/                    ← 業務模組（Dashboard, Catalog, Hrm...）
  routes/ocadmin.php          ← 所有後台路由
```

本分支會建立 app/Portals/Adminlte/

### 技術棧

- **Laravel** + Blade 模板
- **Spatie Laravel Permission** — 角色權限管理
- **Bootstrap 5** + jQuery（目前為 OpenCart 風格，待替換為 AdminLTE）
- 路由格式：`/{locale}/admin/...`
- 中介層：`auth`、`accessBackend`、`logRequest`

### ACL 資料表

| 資料表 | 用途 |
|--------|------|
| `acl_permissions` | 權限定義 |
| `acl_permission_translations` | 權限多語翻譯 |
| `acl_roles` | 角色定義 |
| `acl_role_translations` | 角色多語翻譯 |
| `model_has_permissions` | 使用者直接權限 |
| `model_has_roles` | 使用者角色關聯 |
| `role_has_permissions` | 角色權限關聯 |

### 權限命名規則

三段式 `{module}.{resource}.{action}`：
- `catalog.*` — 商品型錄

---*

## AdminLTE 安裝方式比較

本分支使用 AdminLTE v4（基於 Bootstrap 5）。安裝方式有三種，比較如下：

| | npm + Vite 編譯 | Composer 套件 | 手動放靜態檔 |
|---|---|---|---|
| **套件** | `admin-lte` (npm) | `jeroennoten/laravel-adminlte` | 下載 zip 解壓 |
| **輕量化** | Vite tree shaking，只打包用到的部分 | 完整引入 | 完整引入 |
| **快取更新** | 編譯產物帶 hash（`app-3a8b2c1f.css`），內容變動時檔名自動改變，客戶端一定載入新版 | 需手動處理 | 檔名不變，瀏覽器可能長期使用舊快取 |
| **版本更新** | `npm update admin-lte` | `composer update` | 重新下載 zip 覆蓋 |
| **架構綁定** | 低，自由控制 Blade layout | 高，layout 由套件控制，選單需配合其設定格式，升級可能破壞覆寫的 view | 無綁定 |
| **開發流程** | 修改後需 `npm run build`（開發時 `npm run dev` 自動 watch） | 無需編譯 | 無需編譯 |

### 靜態檔的快取問題（其它分支借用 OpenCart 前端為例）

瀏覽器對靜態資源的快取判斷流程：

```
瀏覽器請求 common.js
  ↓
本地有快取？ ──否──→ 直接下載新檔
  ↓ 是
Cache-Control 過期了嗎？
  ↓ 沒過期
直接用快取（完全不問伺服器）  ← 問題在這裡
  ↓ 已過期
送 If-Modified-Since / If-None-Match 給伺服器
  ↓
伺服器比對檔案有無變動
  ├─ 沒變 → 回 304 Not Modified（用快取）
  └─ 有變 → 回 200 + 新檔案內容
```

大多數 Web Server 對靜態資源預設的 `Cache-Control` 會設較長時間（幾小時到幾天甚至一年）。在這期間，瀏覽器**根本不會發請求去問伺服器**，直接用本地快取。

以 `common.js` 為例，改了之後：
- **最差情況**：使用者要等快取到期才會拿到新版（可能數天）
- **使用者手動 Ctrl+F5**：強制重新載入可以拿到新版，但不能要求每個使用者都這樣做
- **無明確快取標頭**：瀏覽器會用啟發式快取（通常是 Last-Modified 時間的 10%），行為不可預期

| | 靜態檔 `common.js` | Vite `app-3a8b2c1f.js` |
|---|---|---|
| 檔案更新後 | URL 不變，瀏覽器可能繼續用舊快取 | URL 改變（新 hash），瀏覽器視為全新檔案，一定下載 |
| Cache-Control 策略 | 設短 → 頻繁請求浪費流量；設長 → 更新延遲 | 可設超長快取（1年），因為內容變了檔名就變了 |

Vite hash 做法能**魚與熊掌兼得**：既能長期快取（省流量），又能即時更新（不怕舊檔）。

### 最終選擇：手動放靜態檔 + versioned_asset()

經過實際評估後，改為使用靜態檔方式（下載 zip 解壓至 `public/assets/adminlte/`），理由：

1. **快取問題已解決** — 使用 `versioned_asset()` helper（以 `filemtime()` 產生版本號），效果等同 Vite hash 檔名，瀏覽器一定載入最新檔案
2. **可自由修改** — 靜態檔完全由專案控制，可依需求微調 CSS/JS；npm 安裝的檔案在 `node_modules/` 中，改了會被 `npm update` 覆蓋
3. **無需編譯** — 不用跑 `npm run build`，修改即生效
4. **不綁定套件架構** — 與 Composer 套件相比，不受限於套件的 layout 結構和設定格式

安裝版本：AdminLTE v4.0.0-rc6（從 GitHub master 分支下載）

檔案位置：`public/assets/adminlte/`

Blade 使用方式：
```blade
<link href="{{ versioned_asset('assets/adminlte/css/adminlte.min.css') }}" rel="stylesheet">
<script src="{{ versioned_asset('assets/adminlte/js/adminlte.min.js') }}"></script>
```

---

## 圖示套件：Bootstrap Icons

`bi bi-*` 是 **Bootstrap Icons** — 由 Bootstrap 團隊開發的獨立開源圖示套件，跟 FontAwesome 一樣是通用的，不是 AdminLTE 自己定義的。

- 官網：https://icons.getbootstrap.com/
- 目前有 2,000+ 個圖示
- AdminLTE v4 預設搭配它，因為 AdminLTE v4 基於 Bootstrap 5
- 本專案透過 CDN 載入：`bootstrap-icons@1.13.1`

| | FontAwesome | Bootstrap Icons |
|---|---|---|
| 性質 | 獨立通用套件 | 獨立通用套件 |
| 用法 | `<i class="fa-solid fa-plus">` | `<i class="bi bi-plus-lg">` |
| 誰做的 | Fonticons, Inc. | Bootstrap 團隊 |

兩者都是通用的 icon 套件，沿用 FontAwesome 技術上完全沒問題。本專案選用 Bootstrap Icons 是為了配合 AdminLTE v4 的慣例。

---

