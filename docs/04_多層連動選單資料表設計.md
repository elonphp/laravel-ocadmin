# 多層連動選單資料表設計

---

## 一、背景說明

### 1.1 業務需求

窗簾訂單系統的選項具有層層連動特性：

```
材質 → 框型 → 顏色 → 配件（把手、鎖、軌道...）
```

- 選擇「材質 A」後，只顯示該材質可用的「框型」
- 選擇「框型 B」後，只顯示該框型可用的「顏色」
- 以此類推

### 1.2 驅動模式

| 模式 | 說明 | 適用場景 |
|------|------|----------|
| **資料型驅動** | 從現有資料反查可用選項 | 二手車鑑價（只顯示有車可賣的選項） |
| **結構型驅動** | 預先定義選項之間的關聯 | 窗簾客製（所有可能的組合都要顯示） |

**本專案採用：結構型驅動**

原因：
- 窗簾選項是「產品規格」，不是「現有庫存」
- 即使某組合目前沒有訂單，仍需顯示讓客戶選擇
- 選項關聯由後台管理員預先設定

---

## 二、資料表設計

### 2.1 資料表總覽

| 資料表 | 說明 |
|--------|------|
| `options` | 選項群組（材質、框型、顏色...） |
| `option_translations` | 選項群組多語系 |
| `option_values` | 選項值（鋁合金、木質、白色...） |
| `option_value_translations` | 選項值多語系 |
| `option_value_links` | 選項值連動關係（結構型驅動核心） |

### 2.2 options（選項群組）

定義選項的「類型」，如：材質、框型、顏色、把手、鎖...

| 欄位 | 類型 | 說明 |
|------|------|------|
| `id` | bigint | PK |
| `slug` | varchar(50) | 識別碼，唯一（如 `material`、`frame`、`color`） |
| `input_type` | varchar(20) | 輸入類型（`select`、`radio`、`checkbox`），預設 `select` |
| `sort_order` | int | 排序，預設 0 |
| `is_active` | boolean | 啟用狀態，預設 true |
| `created_at` | timestamp | |
| `updated_at` | timestamp | |

**範例資料：**

| id | slug | input_type | sort_order |
|----|------|------------|------------|
| 1 | material | select | 1 |
| 2 | frame | select | 2 |
| 3 | color | select | 3 |
| 4 | handle | select | 4 |
| 5 | lock | select | 5 |

### 2.3 option_translations（選項群組多語系）

| 欄位 | 類型 | 說明 |
|------|------|------|
| `id` | bigint | PK |
| `option_id` | bigint | FK → options |
| `locale` | varchar(10) | 語系代碼（zh_Hant, en） |
| `name` | varchar(100) | 顯示名稱 |
| `description` | text | 說明 |

**唯一約束**：`UNIQUE (option_id, locale)`

**範例資料：**

| id | option_id | locale | name |
|----|-----------|--------|------|
| 1 | 1 | zh_Hant | 材質 |
| 2 | 1 | en | Material |
| 3 | 2 | zh_Hant | 框型 |
| 4 | 2 | en | Frame |

### 2.4 option_values（選項值）

定義每個選項群組下的具體選項。

| 欄位 | 類型 | 說明 |
|------|------|------|
| `id` | bigint | PK |
| `option_id` | bigint | FK → options，所屬選項群組 |
| `slug` | varchar(50) | 識別碼 |
| `image` | varchar(255) | 選項圖片 |
| `sort_order` | int | 排序，預設 0 |
| `is_active` | boolean | 啟用狀態，預設 true |
| `created_at` | timestamp | |
| `updated_at` | timestamp | |

**唯一約束**：`UNIQUE (option_id, slug)`

**範例資料：**

| id | option_id | slug | sort_order |
|----|-----------|------|------------|
| 1 | 1 | aluminum | 1 |
| 2 | 1 | wood | 2 |
| 3 | 1 | plastic | 3 |
| 4 | 2 | sliding | 1 |
| 5 | 2 | hinged | 2 |
| 6 | 3 | white | 1 |
| 7 | 3 | black | 2 |

### 2.5 option_value_translations（選項值多語系）

| 欄位 | 類型 | 說明 |
|------|------|------|
| `id` | bigint | PK |
| `option_value_id` | bigint | FK → option_values |
| `locale` | varchar(10) | 語系代碼（zh_Hant, en） |
| `name` | varchar(100) | 顯示名稱 |
| `description` | text | 說明 |

**唯一約束**：`UNIQUE (option_value_id, locale)`

**範例資料：**

| id | option_value_id | locale | name |
|----|-----------------|--------|------|
| 1 | 1 | zh_Hant | 鋁合金 |
| 2 | 1 | en | Aluminum |
| 3 | 2 | zh_Hant | 木質 |
| 4 | 2 | en | Wood |

### 2.6 option_value_links（選項值連動關係）

**結構型驅動的核心表**：定義「父選項值」與「子選項值」的連動關係。

| 欄位 | 類型 | 說明 |
|------|------|------|
| `id` | bigint | PK |
| `parent_option_value_id` | bigint | FK → option_values，父選項值 |
| `child_option_value_id` | bigint | FK → option_values，子選項值 |
| `created_at` | timestamp | |

**唯一約束**：`UNIQUE (parent_option_value_id, child_option_value_id)`

**範例資料：**

選擇「鋁合金」材質後，可選的框型為「推拉式」和「掀開式」：

| id | parent_option_value_id | child_option_value_id |
|----|------------------------|----------------------|
| 1 | 1 (鋁合金) | 4 (推拉式) |
| 2 | 1 (鋁合金) | 5 (掀開式) |
| 3 | 2 (木質) | 5 (掀開式) |

選擇「鋁合金 + 推拉式」後，可選的顏色：

| id | parent_option_value_id | child_option_value_id |
|----|------------------------|----------------------|
| 4 | 4 (推拉式) | 6 (白色) |
| 5 | 4 (推拉式) | 7 (黑色) |
| 6 | 5 (掀開式) | 6 (白色) |

---

## 三、ER 關係圖

```
┌─────────────────┐       ┌─────────────────────────┐
│     options     │       │   option_translations   │
├─────────────────┤       ├─────────────────────────┤
│ id              │◄──────│ option_id               │
│ slug            │       │ locale                  │
│ input_type      │       │ name                    │
│ sort_order      │       │ description             │
│ is_active       │       └─────────────────────────┘
└────────┬────────┘
         │
         │ 1:N
         ▼
┌─────────────────┐       ┌───────────────────────────────┐
│  option_values  │       │  option_value_translations    │
├─────────────────┤       ├───────────────────────────────┤
│ id              │◄──────│ option_value_id               │
│ option_id       │       │ locale                        │
│ slug            │       │ name                          │
│ image           │       │ description                   │
│ sort_order      │       └───────────────────────────────┘
│ is_active       │
└────────┬────────┘
         │
         │ N:M (自關聯)
         ▼
┌─────────────────────────┐
│   option_value_links    │
├─────────────────────────┤
│ id                      │
│ parent_option_value_id  │──► option_values.id
│ child_option_value_id   │──► option_values.id
└─────────────────────────┘
```

---

## 四、連動查詢邏輯

### 4.1 取得第一層選項（材質）

```php
$materialOption = Option::where('slug', 'material')->first();
$materials = $materialOption->values()->where('is_active', true)->get();
```

### 4.2 根據已選值取得下一層選項

```php
// 使用者選擇了「鋁合金」(id=1)，查詢可選的框型
$selectedMaterialId = 1;

$frameValues = OptionValue::whereHas('parentLinks', function ($query) use ($selectedMaterialId) {
    $query->where('parent_option_value_id', $selectedMaterialId);
})
->whereHas('option', function ($query) {
    $query->where('slug', 'frame');
})
->get();
```

### 4.3 多層連動查詢

```php
// 使用者選擇了「鋁合金」(id=1) + 「推拉式」(id=4)
// 查詢可選的顏色

$selectedIds = [1, 4];

$colorValues = DB::table('option_values as ov')
    ->join('option_value_links as link', 'ov.id', '=', 'link.child_option_value_id')
    ->join('options as o', 'ov.option_id', '=', 'o.id')
    ->whereIn('link.parent_option_value_id', $selectedIds)
    ->where('o.slug', 'color')
    ->where('ov.is_active', true)
    ->select('ov.*')
    ->distinct()
    ->get();
```

---

## 五、Model 關聯

```php
// app/Models/Option.php

class Option extends Model
{
    use HasTranslation;

    protected $fillable = ['slug', 'input_type', 'sort_order', 'is_active'];
    protected array $translatedAttributes = ['name', 'description'];

    public function values()
    {
        return $this->hasMany(OptionValue::class);
    }
}
```

```php
// app/Models/OptionValue.php

class OptionValue extends Model
{
    use HasTranslation;

    protected $fillable = ['option_id', 'slug', 'image', 'sort_order', 'is_active'];
    protected array $translatedAttributes = ['name', 'description'];

    public function option()
    {
        return $this->belongsTo(Option::class);
    }

    /**
     * 此選項值作為「子」的連動關係（查詢父選項值）
     */
    public function parentLinks()
    {
        return $this->hasMany(OptionValueLink::class, 'child_option_value_id');
    }

    /**
     * 此選項值作為「父」的連動關係（查詢子選項值）
     */
    public function childLinks()
    {
        return $this->hasMany(OptionValueLink::class, 'parent_option_value_id');
    }

    /**
     * 取得所有子選項值
     */
    public function children()
    {
        return $this->belongsToMany(
            OptionValue::class,
            'option_value_links',
            'parent_option_value_id',
            'child_option_value_id'
        );
    }

    /**
     * 取得所有父選項值
     */
    public function parents()
    {
        return $this->belongsToMany(
            OptionValue::class,
            'option_value_links',
            'child_option_value_id',
            'parent_option_value_id'
        );
    }
}
```

---

## 六、前端連動載入

本專案前台使用 Inertia.js + React，選項連動透過 Inertia 請求實現：

### 6.1 載入流程

```
頁面載入
  → 後端傳入第一層選項（材質）作為 Inertia props
  → 使用者選擇材質
  → 前端發送請求取得下一層選項（框型）
  → 使用者選擇框型
  → 前端發送請求取得下一層選項（顏色）
  → ...依序載入
```

### 6.2 回應格式

```json
{
    "data": [
        {
            "id": 6,
            "slug": "white",
            "name": "白色",
            "image": "/images/options/white.jpg"
        },
        {
            "id": 7,
            "slug": "black",
            "name": "黑色",
            "image": "/images/options/black.jpg"
        }
    ]
}
```

---

## 七、與授權方案的關聯

選項值（`option_values`）透過授權機制控制經銷商的可用範圍。詳見 [02_角色與組織.md](02_角色與組織.md)。

| 資料表 | 說明 | 關聯 |
|--------|------|------|
| `option_groups` | 授權方案 | 一組預定義的選項集合 |
| `option_group_items` | 方案選項明細 | `group_id` → option_groups, `option_id` → options |
| `organization_options` | 個別授權 | `organization_id` → organizations, `option_id` → options |

授權判斷優先順序：

| 優先順序 | 條件 | 選項來源 |
|----------|------|----------|
| 1 | `organizations.type = 'manufacturer'` | 全部選項 |
| 2 | `organizations.option_group_id` 有值 | 方案選項 |
| 3 | 以上皆無 | 個別授權 |

---

## 八、總結

| 項目 | 決策 |
|------|------|
| 驅動模式 | 結構型驅動（預先定義選項關聯） |
| 命名方案 | Option / OptionValue |
| 多語系 | 獨立翻譯表（`_translations`） |
| 連動關係 | `option_value_links` 自關聯表 |
| 資料表數量 | 5 張表 |

### 資料表清單

1. `options` — 選項群組
2. `option_translations` — 選項群組多語系
3. `option_values` — 選項值
4. `option_value_translations` — 選項值多語系
5. `option_value_links` — 選項值連動關係

### 相關文件

- [02_角色與組織.md](02_角色與組織.md) — 授權方案與選項存取控制
